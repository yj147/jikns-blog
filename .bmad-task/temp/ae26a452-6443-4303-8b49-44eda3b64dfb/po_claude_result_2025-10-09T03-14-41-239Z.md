{
  "prd_updated": "# Phase 9 关注系统 - 质量保障与上线准备 PRD (v2.0)\n\n## 1. 业务背景\n\n### 1.1 项目现状\n- **核心功能**：关注系统的服务层、API、Hooks、组件已完成开发并通过测试\n- **API状态**：4个API端点全部实现（关注/取关、粉丝列表、关注列表、批量状态查询）\n- **测试覆盖**：19个API测试全部通过，单元测试覆盖核心业务逻辑\n- **集成进度**：Settings页面和Profile页面（`app/profile/[userId]/page.tsx`）已集成关注功能\n- **监控基础**：性能监控指标（MetricType）已包含`FOLLOW_ACTION_DURATION`、`FOLLOW_ACTION_RATE_LIMIT`、`FEED_FOLLOWING_RESULT_COUNT`\n\n### 1.2 业务目标\n完成Phase 9关注系统的质量保障与上线准备，确保功能稳定、可监控、可回滚，达到生产环境就绪状态。本次工作聚焦于**验证现有实现**而非新增功能开发。\n\n### 1.3 成功指标\n- **质量目标**：E2E测试覆盖关键用户流程，连续3次通过\n- **可观测性**：关注操作的3个性能指标在实际操作中被正确记录\n- **灰度能力**：通过Feature Flag实现功能开关，支持快速回滚\n- **文档完整**：实施文档准确反映当前状态，Release Note包含所有必要技术细节\n\n### 1.4 ROI分析\n- **风险降低**：E2E测试和Feature Flag降低生产环境故障风险\n- **可维护性**：完整文档降低团队成员上手成本和沟通成本\n- **上线信心**：质量保障工作确保功能稳定性，减少回滚概率\n\n---\n\n## 2. 用户故事与验收标准\n\n### Epic 1: E2E测试补充（P0 - 必须）\n\n#### User Story 1.1: 关注流程端到端测试\n**作为** 测试工程师  \n**我希望** 有完整的E2E测试覆盖关注系统的核心用户流程  \n**以便** 确保功能在真实浏览器环境中正常工作，避免生产环境出现UI交互问题\n\n**验收标准**：\n- [ ] **测试环境配置**：\n  - 使用真实的本地Supabase数据库（非Mock）\n  - 在Playwright的`globalSetup`中自动seed测试数据（2-3个测试用户、预设关注关系）\n  - 在`globalTeardown`中清理测试数据\n  - 参考现有`tests/e2e/permissions-e2e.spec.ts`的setup模式\n\n- [ ] **场景1：Feed页面关注推荐用户**：\n  - 访问Feed页面，验证推荐用户卡片存在\n  - 点击某推荐用户的关注按钮\n  - 验证按钮文本从\"关注\"变为\"已关注\"\n  - 验证按钮状态变化（颜色、图标）\n  - 验证toast提示显示成功消息\n\n- [ ] **场景2：关注流Tab验证**：\n  - 在场景1的基础上，切换到\"关注\"Tab\n  - 验证Tab可访问（非禁用状态）\n  - 验证动态列表中出现被关注用户的内容\n  - 验证列表数据来自`/api/activities?orderBy=following`\n\n- [ ] **场景3：取消关注并验证乐观更新**：\n  - 在已关注状态下，再次点击关注按钮（取消关注）\n  - 验证按钮状态立即变为\"关注\"（乐观更新）\n  - 等待API响应，验证状态保持正确（无回滚）\n  - 切换回\"关注\"Tab，验证该用户的内容已不再显示\n\n- [ ] **场景4：未登录用户访问控制**：\n  - 清除登录状态，访问Feed页面\n  - 验证\"关注\"Tab被禁用或隐藏\n  - 验证推荐用户卡片的关注按钮提示需要登录\n\n- [ ] **性能要求**：\n  - 单个场景执行时间<10秒\n  - 测试套件在CI环境稳定通过（连续3次）\n\n#### User Story 1.2: 粉丝/关注列表测试\n**作为** 测试工程师  \n**我希望** E2E测试覆盖Settings页面的关注管理功能  \n**以便** 验证列表查询、分页、搜索、交互功能的正确性\n\n**验收标准**：\n- [ ] 访问Settings页面，切换到\"社交关系管理\"Tab\n- [ ] 验证\"关注的人\"和\"粉丝\"两个子Tab可访问\n- [ ] 验证列表数据正确显示（用户名、头像、关注状态）\n- [ ] 验证无限滚动加载（至少触发一次loadMore）\n- [ ] 验证搜索过滤功能（输入用户名，列表即时更新）\n- [ ] 在列表中点击关注/取关按钮，验证状态即时更新\n- [ ] 验证数量统计显示正确（`pagination.total`）\n\n**优先级**：P0（必须）\n**时间估算**：2-3小时（包括setup配置）\n\n---\n\n### Epic 2: Feature Flag灰度控制（P0 - 必须）\n\n#### User Story 2.1: 关注功能灰度开关\n**作为** 运维工程师  \n**我希望** 通过环境变量控制关注功能的启用/禁用  \n**以便** 在生产环境遇到问题时快速回滚，无需重新部署代码\n\n**验收标准**：\n\n- [ ] **后端实现**：\n  - 在`lib/config/feature-flags.ts`中新增`feedFollowingStrict()`方法\n  - 读取环境变量`FEATURE_FEED_FOLLOWING_STRICT`（类型：布尔值）\n  - 默认值：`true`（开启关注功能）\n  - 遵循现有flag的命名和实现模式\n\n- [ ] **前端降级行为（Flag=false时）**：\n  - **Feed页面**：\n    - \"关注\"Tab完全隐藏（使用条件渲染：`{featureFlag && <Tab>}`）\n    - 不影响其他Tab（\"推荐\"、\"最新\"等）的正常显示\n  - **FollowButton组件**：\n    - 组件显示但处于禁用状态（`disabled={!featureFlag}`）\n    - Hover时显示tooltip提示：\"该功能暂时维护中\"\n    - 按钮样式变为灰色/禁用态\n  - **Settings页面**：\n    - \"社交关系管理\"Tab保持可访问（用户仍可查看现有关注列表）\n    - 关注/取关按钮禁用，显示维护提示\n\n- [ ] **配置文档**：\n  - 在Release Note中说明环境变量的设置方法\n  - 提供回滚操作步骤（设置`FEATURE_FEED_FOLLOWING_STRICT=false`）\n  - 说明降级后的用户体验变化\n\n**优先级**：P0（必须）\n**时间估算**：1小时\n\n---\n\n### Epic 3: 监控验证（P1 - 重要）\n\n#### User Story 3.1: 性能指标验证\n**作为** SRE工程师  \n**我希望** 确认关注操作的性能指标在实际操作中被正确记录  \n**以便** 在生产环境监控关注系统的健康状态，及时发现性能问题\n\n**验收标准**：\n\n- [ ] **手动测试验证**（通过应用日志）：\n  - 执行一次关注操作，检查日志中是否记录`FOLLOW_ACTION_DURATION`指标\n  - 触发速率限制（连续30次关注），检查`FOLLOW_ACTION_RATE_LIMIT`指标\n  - 访问Feed的\"关注\"Tab，检查`FEED_FOLLOWING_RESULT_COUNT`指标\n\n- [ ] **指标上下文验证**：\n  - 验证指标包含`userId`字段\n  - 验证指标包含`requestId`字段（用于分布式追踪）\n  - 验证指标包含`timestamp`字段\n\n- [ ] **监控脚本验证**（可选，P2优先级）：\n  - 验证`scripts/collect-monitoring-data.sh`能正确采集关注指标\n  - 如果时间允许，添加`--focus follow`参数支持\n  - 如果时间不足，可在后续优化（不阻塞上线）\n\n**优先级**：P1（重要，但可部分延后）\n**时间估算**：30分钟（手动验证） + 1小时（脚本优化，可选）\n\n---\n\n### Epic 4: 文档更新（P1 - 重要）\n\n#### User Story 4.1: 实施状态同步\n**作为** 项目管理者  \n**我希望** 设计文档准确反映当前实施进度  \n**以便** 团队成员和利益相关方了解项目真实状态，避免信息不对称\n\n**验收标准**：\n- [ ] 更新`docs/7-follow/Phase9-关注系统任务计划.md`\n- [ ] 标记M0.5-M1的所有任务为✅（已完成）\n- [ ] 更新M2-M4的实际状态（区分已完成、进行中、待开始）\n- [ ] 新增\"实际完成度分析\"章节：\n  - 说明Profile页面已存在且功能完整（无需路由重构）\n  - 说明监控指标已包含在`lib/performance-monitor.ts`\n  - 说明超预期完成的部分（Settings页面集成）\n- [ ] 更新剩余工作清单（聚焦E2E测试和Feature Flag）\n\n#### User Story 4.2: Release Note编写\n**作为** 技术负责人  \n**我希望** 有清晰的Release Note面向开发和运维团队  \n**以便** 技术团队了解新功能、API变更、配置方法和回滚步骤\n\n**验收标准**：\n- [ ] 创建`docs/7-follow/Phase9-Release-Note.md`\n- [ ] **核心内容**（使用技术语言，避免营销化表达）：\n  1. **功能清单**：\n     - 用户关注/取关（幂等操作，防止自关注）\n     - 粉丝/关注列表查询（分页、游标支持）\n     - 批量状态查询（最多50个用户ID）\n     - Feed页面\"关注\"Tab（基于关注关系过滤动态）\n  2. **API变更**：\n     - `POST /api/users/[userId]/follow`：关注用户\n     - `DELETE /api/users/[userId]/follow`：取消关注\n     - `GET /api/users/[userId]/followers`：获取粉丝列表\n     - `GET /api/users/[userId]/following`：获取关注列表\n     - `POST /api/users/follow/status`：批量查询关注状态\n  3. **配置说明**：\n     - 环境变量：`FEATURE_FEED_FOLLOWING_STRICT`（默认true）\n     - 速率限制：关注操作30次/分钟，批量查询20次/分钟\n  4. **灰度上线步骤**：\n     - 阶段A：内部测试账号验证\n     - 阶段B：10%灰度用户\n     - 阶段C：全量上线\n  5. **回滚步骤**：\n     - 设置`FEATURE_FEED_FOLLOWING_STRICT=false`\n     - 重启应用\n     - 验证UI降级行为正确\n  6. **已知限制**：\n     - 批量查询最多50个用户ID\n     - 关注关系不支持隐私设置（全部公开）\n     - 暂不支持推荐算法（Phase 10+）\n  7. **兼容性说明**：\n     - 向后兼容，无破坏性变更\n     - 现有数据库schema无需迁移\n     - 前端API调用保持统一响应格式\n\n**优先级**：P1（重要）\n**时间估算**：1.5小时\n\n---\n\n## 3. 范围界定\n\n### 3.1 In Scope（包含）\n- ✅ E2E测试套件（关注流程、列表交互）\n- ✅ Feature Flag实现（feedFollowingStrict）\n- ✅ 性能监控手动验证（日志检查）\n- ✅ 文档更新（任务计划、Release Note）\n- ✅ 验证现有Profile页面功能（通过E2E测试覆盖）\n\n### 3.2 Out of Scope（排除）\n- ❌ 核心功能开发（已完成）\n- ❌ Profile页面路由重构（现有实现已满足需求）\n- ❌ 新增API端点（已完成）\n- ❌ 性能优化（当前指标满足需求）\n- ❌ 监控脚本的`--focus follow`参数（P2优先级，可后置）\n- ❌ 推荐算法改进（Phase 10+）\n- ❌ 推送通知系统（Phase 10+）\n\n---\n\n## 4. 技术约束\n\n### 4.1 技术栈\n- **测试框架**：Playwright 1.49.1（已配置）\n- **测试数据**：真实本地Supabase数据库 + globalSetup/Teardown\n- **Feature Flag**：`lib/config/feature-flags.ts`（已存在框架）\n- **监控**：`lib/performance-monitor.ts`（MetricType已包含关注指标）\n- **文档格式**：Markdown\n\n### 4.2 质量标准\n- **测试稳定性**：E2E测试连续3次通过\n- **代码质量**：通过`pnpm quality:check`（lint + typecheck）\n- **性能要求**：E2E单个场景<10秒\n- **文档完整性**：包含所有必要章节（功能、API、配置、回滚）\n- **Linus原则**：遵循\"Never break userspace\"，无破坏性变更\n\n### 4.3 安全与合规\n- 速率限制：关注操作30次/分钟，批量查询20次/分钟（已实现）\n- CSRF保护：统一使用`secureFetch`与`X-CSRF-Token`（已实现）\n- 审计日志：`USER_FOLLOW`、`USER_UNFOLLOW`动作记录（已实现）\n- 权限控制：写操作强制`user-active`策略（已实现）\n\n---\n\n## 5. 数据要求\n\n### 5.1 E2E测试数据\n- **测试用户**：2-3个用户账号（user1, user2, user3）\n- **关注关系**：预设关系（user1关注user2，user2关注user3）\n- **动态数据**：每个用户至少1条动态内容（用于验证关注流）\n- **清理策略**：测试后完全清理，避免数据污染\n\n### 5.2 性能指标数据\n- **指标字段**：type, value, unit, timestamp, context（userId, requestId）\n- **存储位置**：应用日志（通过`logger`输出）\n- **采集方式**：`performanceMonitor.recordMetric()`\n\n---\n\n## 6. 用户体验考虑\n\n### 6.1 灰度降级体验\n- 当Feature Flag关闭时，用户应看到**一致的降级体验**：\n  - Feed页面：关注Tab消失，不影响其他Tab\n  - 关注按钮：禁用态 + 明确的维护提示\n  - Settings页面：可查看现有列表，但无法操作\n- 提示文案统一使用：\"该功能暂时维护中\"（避免技术术语）\n\n### 6.2 E2E测试覆盖的UX关键点\n- **乐观更新**：按钮状态立即变化，提升感知性能\n- **错误回滚**：API失败时状态正确回滚，避免UI不一致\n- **未登录提示**：明确引导用户登录，而非显示错误页面\n- **空态处理**：未关注任何人时显示引导性文案\n\n---\n\n## 7. 风险与缓解\n\n### 7.1 技术风险\n\n| 风险 | 等级 | 概率 | 影响 | 缓解措施 |\n|------|------|------|------|----------|\n| E2E测试Playwright环境配置失败 | 低 | 20% | 阻塞测试 | 参考现有permissions-e2e.spec.ts，复用已验证的配置 |\n| Feature Flag前端读取逻辑位置不明确 | 中 | 30% | 实现延迟 | 在Architect阶段明确前端Hook实现（参考现有useAuth模式） |\n| 性能指标未被正确记录 | 低 | 10% | 监控失效 | 手动测试验证，查看应用日志确认指标输出 |\n| 文档更新遗漏关键信息 | 低 | 15% | 沟通成本 | 使用Checklist验证文档完整性 |\n\n### 7.2 外部依赖\n- Playwright浏览器环境：已配置，低风险\n- 本地Supabase实例：通过`pnpm supabase:start`启动，已验证\n- CI环境E2E支持：需验证（如CI不支持，可先在本地验证）\n\n---\n\n## 8. 时间估算\n\n| 任务 | 估算时间 | 优先级 |\n|------|----------|--------|\n| E2E测试开发（含setup） | 2.5小时 | P0 |\n| Feature Flag后端实现 | 0.5小时 | P0 |\n| Feature Flag前端集成 | 0.5小时 | P0 |\n| 性能指标手动验证 | 0.5小时 | P1 |\n| 文档更新（任务计划） | 0.5小时 | P1 |\n| Release Note编写 | 1小时 | P1 |\n| **总计（P0+P1）** | **5.5小时** | |\n| 监控脚本优化（可选，P2） | 1小时 | P2 |\n\n**建议时间窗口**：1个工作日（6-8小时，包含缓冲）\n\n---\n\n## 9. 验收流程\n\n### 9.1 开发阶段验收\n- [ ] E2E测试在本地环境连续3次通过\n- [ ] Feature Flag前后端集成完成，可通过环境变量控制\n- [ ] 性能指标在日志中可观察到\n- [ ] 代码通过`pnpm quality:check`\n\n### 9.2 Review阶段验收\n- [ ] E2E测试代码遵循现有测试模式\n- [ ] Feature Flag实现遵循现有flag模式\n- [ ] 文档准确无歧义，包含所有必要信息\n\n### 9.3 QA阶段验收\n- [ ] 手动验证关注流程（关注→取关→关注流查询）\n- [ ] 手动验证Feature Flag开关行为\n- [ ] 验证性能指标记录正确\n- [ ] 验证文档完整性（对照Checklist）\n\n### 9.4 上线前验收\n- [ ] Go/No-Go决策会议通过\n- [ ] 灰度上线计划明确\n- [ ] 回滚步骤已验证\n\n---\n\n## 10. 后续阶段交接\n\n本PRD完成后，将移交给：\n\n1. **Architect（Alex）**：\n   - 输入：本PRD + 现有代码库分析\n   - 输出：技术实施方案（E2E测试结构、Feature Flag位置、前端Hook设计）\n   - 关键决策：前端如何读取Feature Flag、E2E测试的数据管理策略\n\n2. **SM（Mike）**：\n   - 输入：Architect方案\n   - 输出：带时间估算的详细任务清单、里程碑定义\n   - 关键工作：任务拆解、风险识别、资源分配\n\n3. **Dev（通过Codex）**：\n   - 输入：SM任务清单\n   - 输出：可运行的代码、测试、文档\n   - 执行方式：使用Codex（model: gpt-5, sandbox: danger-full-access）\n\n4. **QA（Quinn）**：\n   - 输入：Dev产出物\n   - 输出：测试报告、质量评估、上线建议\n   - 验证项：功能、灰度、性能、回滚\n\n---\n\n## 11. 附录\n\n### 11.1 参考资料\n- Phase9设计文档：`docs/7-follow/Phase9-关注系统设计.md`\n- Phase9任务计划：`docs/7-follow/Phase9-关注系统任务计划.md`\n- 现有E2E测试：`tests/e2e/permissions-e2e.spec.ts`\n- Feature Flag实现：`lib/config/feature-flags.ts`\n- 性能监控：`lib/performance-monitor.ts`\n\n### 11.2 关键决策记录\n- **决策1**：E2E测试使用真实数据库而非Mock → 原因：更接近生产环境，可发现数据库级别的问题\n- **决策2**：Feature Flag关闭时部分降级（而非完全隐藏） → 原因：平衡用户体验和技术实现复杂度\n- **决策3**：监控脚本优化降为P2优先级 → 原因：核心是指标记录，脚本聚合功能可后置\n- **决策4**：跳过Profile页面路由重构 → 原因：现有实现已满足需求，遵循\"Never break userspace\"\n- **决策5**：Release Note面向技术团队 → 原因：关注系统是后端功能，主要影响开发和运维\n",
  "quality_score": 94,
  "improvements": [
    "基于用户回答明确了E2E测试数据策略：真实本地Supabase + globalSetup/Teardown",
    "详细定义了Feature Flag关闭时的前端降级行为：Feed Tab隐藏、按钮禁用+tooltip、Settings保留查看权限",
    "将监控脚本的--focus follow参数降为P2优先级，明确不阻塞上线",
    "确认现有Profile页面无需重构，通过E2E测试验证功能完整性即可",
    "明确Release Note面向开发和运维团队，侧重技术细节和配置说明",
    "新增\"关键决策记录\"章节，记录重要的架构选择和理由",
    "完善了验收流程，明确了开发、Review、QA、上线前的验收标准",
    "新增\"数据要求\"章节，明确E2E测试数据和性能指标数据的具体要求",
    "新增\"安全与合规\"章节，说明已实现的安全机制（速率限制、CSRF、审计）",
    "新增\"后续阶段交接\"章节，明确PRD如何传递给Architect、SM、Dev、QA"
  ],
  "ready_for_approval": true
}