{
  "prd_draft": "# Phase 9 关注系统 - 质量保障与上线准备 PRD\n\n## 1. 业务背景\n\n### 1.1 项目现状\n- **核心功能**：关注系统的服务层、API、Hooks、组件已完成开发\n- **测试状态**：19个API测试全部通过\n- **集成进度**：Settings页面和Profile页面已集成关注功能\n- **监控基础**：性能监控指标（MetricType）已包含关注系统的3个指标\n\n### 1.2 业务目标\n完成Phase 9关注系统的质量保障与上线准备，确保功能稳定、可监控、可回滚，达到生产环境就绪状态。\n\n### 1.3 成功指标\n- **质量目标**：E2E测试覆盖率≥80%，关键用户流程全部通过\n- **可观测性**：关注操作的性能指标可实时监控\n- **灰度能力**：通过Feature Flag实现功能开关，支持快速回滚\n- **文档完整**：实施文档与Release Note准确反映当前状态\n\n---\n\n## 2. 用户故事与验收标准\n\n### Epic 1: E2E测试补充\n\n#### User Story 1.1: 关注流程端到端测试\n**作为** 测试工程师  \n**我希望** 有完整的E2E测试覆盖关注系统的核心用户流程  \n**以便** 确保功能在真实浏览器环境中正常工作\n\n**验收标准**：\n- [ ] 场景1：用户在Feed页面关注推荐用户，验证按钮状态变化\n- [ ] 场景2：关注成功后切换到\"关注\"Tab，验证动态列表显示被关注用户的内容\n- [ ] 场景3：取消关注并验证状态即时更新（乐观更新+回滚）\n- [ ] 场景4：未登录用户访问Feed页面，\"关注\"Tab应被禁用或提示登录\n- [ ] 所有场景在CI环境稳定通过（连续3次）\n- [ ] 单个场景执行时间<10秒\n\n#### User Story 1.2: 粉丝/关注列表测试\n**作为** 测试工程师  \n**我希望** E2E测试覆盖粉丝和关注列表的查询与交互  \n**以便** 验证列表页面的分页、搜索、关注按钮等功能\n\n**验收标准**：\n- [ ] 在Settings页面访问\"关注的人\"和\"粉丝\"Tab\n- [ ] 验证列表数据正确显示（用户名、头像、关注状态）\n- [ ] 验证无限滚动加载功能\n- [ ] 验证搜索过滤功能\n- [ ] 验证在列表中关注/取关用户，状态即时更新\n\n**优先级**：P0（必须）\n\n---\n\n### Epic 2: Feature Flag灰度控制\n\n#### User Story 2.1: 关注功能灰度开关\n**作为** 运维工程师  \n**我希望** 通过环境变量控制关注功能的启用/禁用  \n**以便** 在生产环境遇到问题时快速回滚\n\n**验收标准**：\n- [ ] 在`lib/config/feature-flags.ts`中新增`feedFollowingStrict()`方法\n- [ ] 读取环境变量`FEATURE_FEED_FOLLOWING_STRICT`（默认值：true）\n- [ ] 当Flag关闭时，Feed页面\"关注\"Tab隐藏或禁用\n- [ ] 当Flag关闭时，关注按钮变为\"功能维护中\"状态\n- [ ] 提供明确的回滚文档和操作步骤\n\n**优先级**：P0（必须）\n\n---\n\n### Epic 3: 监控验证\n\n#### User Story 3.1: 性能指标验证\n**作为** SRE工程师  \n**我希望** 确认关注操作的性能指标正确记录  \n**以便** 在生产环境监控关注系统的健康状态\n\n**验收标准**：\n- [ ] 验证`FOLLOW_ACTION_DURATION`指标在关注/取关时正确记录\n- [ ] 验证`FOLLOW_ACTION_RATE_LIMIT`指标在速率限制触发时记录\n- [ ] 验证`FEED_FOLLOWING_RESULT_COUNT`指标在关注流查询时记录\n- [ ] 性能日志包含必要的上下文（userId、requestId、timestamp）\n- [ ] 监控脚本`collect-monitoring-data.sh`能正确采集关注指标（可选支持`--focus follow`）\n\n**优先级**：P1（重要）\n\n---\n\n### Epic 4: 文档更新\n\n#### User Story 4.1: 实施状态同步\n**作为** 项目管理者  \n**我希望** 设计文档准确反映当前实施进度  \n**以便** 团队成员和利益相关方了解项目真实状态\n\n**验收标准**：\n- [ ] 更新`docs/7-follow/Phase9-关注系统任务计划.md`中的里程碑状态\n- [ ] 标记M0.5-M1已完成任务为✅\n- [ ] 更新M2-M4的实施状态和剩余工作\n- [ ] 添加\"实际完成度\"章节，说明超预期完成的部分\n\n#### User Story 4.2: Release Note编写\n**作为** 产品负责人  \n**我希望** 有清晰的Release Note说明本次发布内容  \n**以便** 用户和开发团队了解新功能和变更\n\n**验收标准**：\n- [ ] 创建`docs/7-follow/Phase9-Release-Note.md`\n- [ ] 包含功能清单（已完成的核心功能）\n- [ ] 包含API变更说明（新增的4个API端点）\n- [ ] 包含配置说明（环境变量、Feature Flag）\n- [ ] 包含已知限制和后续计划\n\n**优先级**：P1（重要）\n\n---\n\n## 3. 范围界定\n\n### 3.1 In Scope（包含）\n- ✅ E2E测试套件（关注流程、列表交互）\n- ✅ Feature Flag实现（feedFollowingStrict）\n- ✅ 性能监控验证（手动测试+日志检查）\n- ✅ 文档更新（任务计划、Release Note）\n\n### 3.2 Out of Scope（排除）\n- ❌ 核心功能开发（已完成）\n- ❌ 大规模重构（无需要）\n- ❌ 新增API端点（已完成）\n- ❌ 性能优化（当前指标满足需求）\n- ❌ 推荐算法改进（Phase 10+）\n- ❌ 推送通知系统（Phase 10+）\n\n---\n\n## 4. 技术约束\n\n### 4.1 技术栈\n- **测试框架**：Playwright 1.49.1（已配置）\n- **Feature Flag**：`lib/config/feature-flags.ts`（已存在框架）\n- **监控**：`lib/performance-monitor.ts`（已集成）\n- **文档格式**：Markdown\n\n### 4.2 质量标准\n- **测试稳定性**：E2E测试连续3次通过\n- **代码质量**：通过`pnpm quality:check`（lint + typecheck）\n- **性能要求**：E2E单个场景<10秒\n- **文档完整性**：包含所有必要章节（功能、配置、限制）\n\n---\n\n## 5. 用户体验考虑\n\n### 5.1 灰度降级体验\n- 当Feature Flag关闭时，用户应看到友好的提示而非错误页面\n- \"功能维护中\"提示应明确告知预计恢复时间（如有）\n\n### 5.2 测试覆盖重点\n- 关注操作的乐观更新和错误回滚（防止状态不一致）\n- 未登录用户的友好提示（避免混淆）\n- 列表加载的骨架屏和空态（提升感知性能）\n\n---\n\n## 6. 风险与依赖\n\n### 6.1 技术风险\n- **低风险**：E2E测试可能需要调试Playwright环境配置\n- **中风险**：Feature Flag需要确认前端读取逻辑的实现位置\n\n### 6.2 外部依赖\n- Playwright浏览器环境（已配置）\n- CI环境支持E2E测试（需验证）\n\n---\n\n## 7. 时间估算\n\n- **E2E测试开发**：2-3小时\n- **Feature Flag实现**：1小时\n- **监控验证**：30分钟\n- **文档更新**：1.5小时\n- **总计**：5-6小时（约1个工作日）\n\n---\n\n## 8. 后续阶段\n\n本PRD完成后，将移交给：\n- **Architect**：制定技术实施方案（E2E测试结构、Feature Flag位置）\n- **SM**：拆解具体任务和里程碑\n- **Dev**：通过Codex执行代码生成\n- **QA**：验证功能、灰度、性能、回滚\n",
  "quality_score": 82,
  "gaps": [
    "E2E测试的具体测试数据来源不明确（Mock数据 vs 真实数据库）",
    "Feature Flag关闭时的前端行为细节未定义（隐藏组件 vs 禁用按钮 vs 显示提示）",
    "监控脚本的'--focus follow'参数是否必须实现，还是可选优化",
    "Profile页面的现有功能完整性是否需要验证（设计文档要求路由重构，但实际已存在app/profile/[userId]/page.tsx）",
    "Release Note的目标读者是谁（开发团队 vs 最终用户 vs 运维团队）"
  ],
  "questions": [
    {
      "id": "q1",
      "question": "E2E测试应该使用Mock数据还是连接真实的本地Supabase数据库？如果使用真实数据库，是否需要在测试前自动seed数据？",
      "context": "E2E测试的数据策略影响测试可靠性和环境配置复杂度。Mock数据更快但可能遗漏真实数据库问题；真实数据库更接近生产但需要额外的setup/teardown"
    },
    {
      "id": "q2",
      "question": "当Feature Flag（FEATURE_FEED_FOLLOWING_STRICT）关闭时，前端应该如何表现？是完全隐藏关注相关的UI组件，还是显示但禁用按钮并提示'功能维护中'？",
      "context": "灰度降级的用户体验需要明确定义。不同的降级策略对用户的影响不同，也会影响前端实现的复杂度"
    },
    {
      "id": "q3",
      "question": "监控脚本的'--focus follow'参数是本次必须实现的功能，还是可选的优化项？如果是可选的，优先级如何？",
      "context": "明确P0（必须）和P1（重要但可后置）任务有助于时间管理和风险控制。如果时间紧张，可以先跳过非关键优化"
    },
    {
      "id": "q4",
      "question": "设计文档提到需要重构Profile页面路由（从app/profile/page.tsx迁移到app/(me)/profile/page.tsx + 新增app/(users)/users/[id]/page.tsx），但实际已存在app/profile/[userId]/page.tsx。是否需要验证现有实现是否满足设计要求，还是直接跳过路由重构？",
      "context": "如果现有实现已满足需求，可以避免不必要的重构工作。但如果设计有特定原因要求新的路由结构，则需要明确"
    },
    {
      "id": "q5",
      "question": "Release Note的主要目标读者是谁？如果是开发团队，应侧重技术细节（API变更、配置项）；如果是最终用户，应侧重功能说明和使用指南。",
      "context": "目标读者决定Release Note的语言风格和内容深度。技术团队需要精确的API文档，而用户需要通俗易懂的功能介绍"
    }
  ]
}