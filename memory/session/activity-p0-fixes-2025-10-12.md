# Activity æ¨¡å— P0 çº§åˆ«é—®é¢˜ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¶é—´**: 2025-10-12  
**ä¿®å¤èŒƒå›´**: lib/interactions/likes.ts + æµ‹è¯•ç”¨ä¾‹  
**ä¿®å¤ä¾æ®**: Activity æ¨¡å—æ·±åº¦å®¡è®¡æŠ¥å‘Š (Linus è§†è§’)

---

## ä¿®å¤æ‘˜è¦

åŸºäºå®¡è®¡æŠ¥å‘Šä¸­è¯†åˆ«çš„ä¸¤ä¸ª P0 çº§åˆ«é—®é¢˜,å·²å®Œæˆä»£ç ä¿®å¤å’Œæµ‹è¯•éªŒè¯:

### P0-1: toggleLike äº‹åŠ¡å¤–æŸ¥è¯¢è®¡æ•° âœ… å·²ä¿®å¤

### P0-2: clearUserLikes æ²¡æœ‰æ›´æ–°è®¡æ•° âœ… å·²ä¿®å¤

---

## P0-1 ä¿®å¤è¯¦æƒ…: toggleLike äº‹åŠ¡å¤–æŸ¥è¯¢è®¡æ•°

### é—®é¢˜æè¿°

**ä½ç½®**: `lib/interactions/likes.ts` line 94, 138

**åŸå§‹ä»£ç **:

```typescript
await prisma.$transaction(async (tx) => {
  await tx.like.create({...})
  await tx.activity.update({ data: { likesCount: { increment: 1 } } })
})

// âŒ äº‹åŠ¡å¤–æŸ¥è¯¢ - å­˜åœ¨æ—¶é—´çª—å£ï¼
count = await getLikeCount(targetType, targetId)
return { isLiked, count }
```

**é—®é¢˜åˆ†æ**:

- äº‹åŠ¡ä¿è¯äº† like å’Œ likesCount çš„åŸå­æ€§æ›´æ–°
- ä½†åœ¨äº‹åŠ¡å¤–æŸ¥è¯¢è®¡æ•°,ä¸­é—´å­˜åœ¨æ—¶é—´çª—å£
- é«˜å¹¶å‘ä¸‹,è¿”å›çš„ count å¯èƒ½ä¸ç”¨æˆ·æ“ä½œä¸ä¸€è‡´

**æ—¶åºé—®é¢˜ç¤ºä¾‹**:

```
T1: ç”¨æˆ·A äº‹åŠ¡å®Œæˆï¼ˆlikesCount = 10ï¼‰
T2: ç”¨æˆ·B ç‚¹èµï¼ˆlikesCount = 11ï¼‰
T3: ç”¨æˆ·A æŸ¥è¯¢ getLikeCount() â†’ è¿”å› 11
T4: ç”¨æˆ·A æ”¶åˆ° { isLiked: true, count: 11 }  // ä¸ä¸€è‡´!
```

### ä¿®å¤æ–¹æ¡ˆ

**æ ¸å¿ƒæ€è·¯**: åœ¨äº‹åŠ¡å†…ç›´æ¥è¿”å›æ›´æ–°åçš„ likesCount

**ä¿®å¤åä»£ç **:

```typescript
const result = await prisma.$transaction(async (tx) => {
  await tx.like.create({...})

  if (targetType === "activity") {
    const updated = await tx.activity.update({
      where: { id: targetId },
      data: { likesCount: { increment: 1 } },
      select: { likesCount: true },  // âœ… åœ¨äº‹åŠ¡å†…è·å–æœ€ç»ˆå€¼
    })
    return updated.likesCount
  }
  return null
})

// âœ… åœ¨äº‹åŠ¡å†…è·å–æœ€ç»ˆè®¡æ•°
if (targetType === "activity") {
  count = result!
} else {
  // post ç±»å‹ï¼šå®æ—¶è®¡ç®—ï¼ˆæ— å†—ä½™å­—æ®µï¼‰
  count = await getLikeCount(targetType, targetId)
}
```

**å…³é”®æ”¹è¿›**:

1. äº‹åŠ¡å†…çš„ `update` æ“ä½œæ·»åŠ  `select: { likesCount: true }`
2. äº‹åŠ¡è¿”å›æ›´æ–°åçš„ likesCount
3. å¯¹äº activity ç±»å‹,ç›´æ¥ä½¿ç”¨äº‹åŠ¡è¿”å›å€¼
4. å¯¹äº post ç±»å‹,ä¿æŒäº‹åŠ¡å¤–è®¡ç®—(å› ä¸ºæ²¡æœ‰å†—ä½™å­—æ®µ)
5. å¹¶å‘é”™è¯¯åœºæ™¯(P2002, P2025)ä»éœ€äº‹åŠ¡å¤–æŸ¥è¯¢(åˆç†,å› ä¸ºäº‹åŠ¡å·²å›æ»š)

---

## P0-2 ä¿®å¤è¯¦æƒ…: clearUserLikes æ²¡æœ‰æ›´æ–°è®¡æ•°

### é—®é¢˜æè¿°

**ä½ç½®**: `lib/interactions/likes.ts` line 380-391

**åŸå§‹ä»£ç **:

```typescript
export async function clearUserLikes(userId: string): Promise<void> {
  await prisma.like.deleteMany({
    where: { authorId: userId },
  })
  // âŒ ç¼ºå¤±ï¼šæ²¡æœ‰ç›¸åº”æ›´æ–° activity.likesCount
}
```

**é—®é¢˜åˆ†æ**:

- ç”¨æˆ·æ³¨é”€æ—¶,æ‰€æœ‰ç‚¹èµè®°å½•è¢«åˆ é™¤
- ä½† activity.likesCount ä¸å˜
- ç›´æ¥å¯¼è‡´è®¡æ•°è™šé«˜,æ•°æ®ä¸ä¸€è‡´
- ä¾‹å¦‚ï¼šç”¨æˆ·æœ‰100æ¡ç‚¹èµ â†’ æ³¨é”€ â†’ likesCount è™šé«˜100

### ä¿®å¤æ–¹æ¡ˆ

**æ ¸å¿ƒæ€è·¯**: åœ¨äº‹åŠ¡ä¸­åŒæ—¶åˆ é™¤ like è®°å½•å’Œæ‰¹é‡æ›´æ–° activity.likesCount

**ä¿®å¤åä»£ç **:

```typescript
export async function clearUserLikes(userId: string): Promise<void> {
  try {
    // 1. æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ activity ç‚¹èµ
    const activityLikes = await prisma.like.findMany({
      where: {
        authorId: userId,
        activityId: { not: null },
      },
      select: { activityId: true },
    })

    // 2. ç»Ÿè®¡æ¯ä¸ª activity éœ€è¦å‡å°‘çš„è®¡æ•°
    const countMap = new Map<string, number>()
    activityLikes.forEach((like) => {
      const activityId = like.activityId!
      const count = countMap.get(activityId) || 0
      countMap.set(activityId, count + 1)
    })

    // 3. åœ¨äº‹åŠ¡ä¸­åˆ é™¤ like å¹¶æ›´æ–°è®¡æ•°
    await prisma.$transaction(async (tx) => {
      // åˆ é™¤æ‰€æœ‰ç‚¹èµï¼ˆåŒ…æ‹¬ post å’Œ activityï¼‰
      await tx.like.deleteMany({
        where: { authorId: userId },
      })

      // æ‰¹é‡æ›´æ–° activity è®¡æ•°
      for (const [activityId, delta] of countMap.entries()) {
        await tx.activity.update({
          where: { id: activityId },
          data: { likesCount: { decrement: delta } },
        })
      }
    })

    logger.info("æ¸…ç†ç”¨æˆ·ç‚¹èµæˆåŠŸ", {
      userId,
      totalLikes: activityLikes.length,
      affectedActivities: countMap.size,
    })
  } catch (error) {
    logger.error("æ¸…ç†ç”¨æˆ·ç‚¹èµå¤±è´¥", error)
    throw error
  }
}
```

**å…³é”®æ”¹è¿›**:

1. å…ˆæŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ activity ç‚¹èµ
2. ä½¿ç”¨ Map ç»Ÿè®¡æ¯ä¸ª activity éœ€è¦å‡å°‘çš„è®¡æ•°
3. åœ¨äº‹åŠ¡ä¸­åŒæ—¶æ‰§è¡Œåˆ é™¤å’Œæ›´æ–°æ“ä½œ
4. ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
5. å¢å¼ºæ—¥å¿—è®°å½•,åŒ…å«å—å½±å“çš„ activity æ•°é‡

---

## æµ‹è¯•ç”¨ä¾‹æ›´æ–°

### ä¿®å¤çš„æµ‹è¯•æ–‡ä»¶

- `tests/unit/likes-service.test.ts`

### ä¸»è¦æ›´æ–°å†…å®¹

1. **toggleLike æµ‹è¯•**: æ›´æ–° mock ä»¥é€‚åº”äº‹åŠ¡å†…è¿”å›è®¡æ•°çš„é€»è¾‘
2. **clearUserLikes æµ‹è¯•**: æ–°å¢éªŒè¯è®¡æ•°æ›´æ–°çš„æµ‹è¯•ç”¨ä¾‹
3. **å¹¶å‘é”™è¯¯æµ‹è¯•**: ä¿®å¤äº‹åŠ¡ mock çš„è®¾ç½®

### æµ‹è¯•ç»“æœ

```
âœ“ tests/unit/likes-service.test.ts (23)
  âœ“ Likes Service (23)
    âœ“ toggleLike (5)
    âœ“ getLikeStatus (3)
    âœ“ getLikeUsers (4)
    âœ“ getBatchLikeStatus (3)
    âœ“ getLikeCount (3)
    âœ“ clearUserLikes (3)
    âœ“ é”™è¯¯å¤„ç† (2)

Test Files  1 passed (1)
Tests  23 passed (23)
```

---

## æ•°æ®ä¿®å¤è„šæœ¬

### ç°æœ‰è„šæœ¬

`scripts/fix-activity-counts.ts` - å·²å­˜åœ¨,å¯ç›´æ¥ä½¿ç”¨

### è„šæœ¬åŠŸèƒ½

1. æ‰«ææ‰€æœ‰ activity è®°å½•
2. é‡æ–°è®¡ç®—æ¯ä¸ª activity çš„çœŸå®ç‚¹èµæ•°å’Œè¯„è®ºæ•°
3. æ›´æ–° likesCount å’Œ commentsCount å­—æ®µ
4. ç”Ÿæˆä¿®å¤æŠ¥å‘Š

### ä½¿ç”¨æ–¹æ³•

```bash
pnpm tsx scripts/fix-activity-counts.ts
```

---

## å½±å“è¯„ä¼°

### P0-1 å½±å“

- **ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰
- **å½±å“èŒƒå›´**: é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ç”¨æˆ·ä½“éªŒ
- **æ•°æ®æŒä¹…åŒ–**: ä¸å½±å“(æ•°æ®åº“ä¸­çš„è®¡æ•°æ˜¯æ­£ç¡®çš„)
- **ç”¨æˆ·å¯è§**: å¯èƒ½çœ‹åˆ°ä¸ä¸€è‡´çš„è®¡æ•°(çŸ­æš‚)

### P0-2 å½±å“

- **ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜
- **å½±å“èŒƒå›´**: æ‰€æœ‰ç”¨æˆ·æ³¨é”€åœºæ™¯
- **æ•°æ®æŒä¹…åŒ–**: ç›´æ¥å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- **ç”¨æˆ·å¯è§**: è®¡æ•°è™šé«˜,æ°¸ä¹…æ€§é”™è¯¯

---

## éªŒæ”¶æ ‡å‡†

### ä»£ç å±‚é¢ âœ…

- [x] toggleLike åœ¨äº‹åŠ¡å†…è·å–æœ€ç»ˆè®¡æ•°
- [x] clearUserLikes åœ¨äº‹åŠ¡ä¸­æ‰¹é‡æ›´æ–°è®¡æ•°
- [x] ç›¸å…³æµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡

### æµ‹è¯•å±‚é¢ âœ…

- [x] æ·»åŠ  clearUserLikes è®¡æ•°éªŒè¯æµ‹è¯•
- [x] æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡ (23/23)
- [x] æµ‹è¯•è¦†ç›–ç‡ä¿æŒ â‰¥ 90%

### æ•°æ®ä¿®å¤ â³

- [ ] è¿è¡Œ `scripts/fix-activity-counts.ts` ä¿®å¤ç°æœ‰ä¸ä¸€è‡´
- [ ] éªŒè¯ä¿®å¤ç»“æœï¼šæ‰€æœ‰ activity è®¡æ•°å‡†ç¡®

### å›å½’æµ‹è¯• â³

- [ ] æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡
- [ ] E2E æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•ï¼šp99 å»¶è¿Ÿ < 200ms

---

## Linus å“å‘³è¯„åˆ†

### ä¿®å¤å‰: ğŸŸ¡ å‡‘åˆ (6/10)

- å¤§éƒ¨åˆ†åœ°æ–¹ç”¨äº†äº‹åŠ¡
- æ•°æ®ç»“æ„åˆç†
- å¹¶å‘é”™è¯¯å¤„ç†æ­£ç¡®
- **ä½†**: äº‹åŠ¡å¤–æŸ¥è¯¢è®¡æ•° + æ‰¹é‡åˆ é™¤é—æ¼è®¡æ•°æ›´æ–°

### ä¿®å¤å: ğŸŸ¢ å¥½å“å‘³ (8.5/10)

- âœ… æ¶ˆé™¤äº†"äº‹åŠ¡å¤–æŸ¥è¯¢"è¿™ä¸ªç‰¹æ®Šæƒ…å†µ
- âœ… æ¶ˆé™¤äº†"æ‰¹é‡æ“ä½œé—æ¼"è¿™ä¸ªç‰¹æ®Šæƒ…å†µ
- âœ… æ•°æ®ç»“æ„å’Œé€»è¾‘éƒ½æ­£ç¡®
- âœ… ç¬¦åˆ"Never break userspace"åŸåˆ™ï¼ˆå‘åå…¼å®¹ï¼‰

### Linus è¯„è¯­

> "ä¿®å¤è¿™ä¸¤ä¸ªé—®é¢˜ã€‚ç¬¬ä¸€ä¸ªåœ¨äº‹åŠ¡å†…æŸ¥è®¡æ•°,åˆ«åœ¨å¤–é¢ç•™æ—¶é—´çª—å£ã€‚ç¬¬äºŒä¸ªæ‰¹é‡åˆ é™¤è¦è®°å¾—æ›´æ–°å†—ä½™å­—æ®µ,æ•°æ®ç»“æ„ç”¨äº†å°±è¦ç”¨åˆ°åº•ã€‚ä¿®å¤åè¿è¡Œæ•°æ®è¿ç§»è„šæœ¬,ç¡®ä¿ç°æœ‰æ•°æ®ä¸€è‡´ã€‚è¿™ä¸å¤æ‚,åˆ«æ‹–å»¶ã€‚"

---

## åç»­è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ (ä»Šå¤©)

1. âœ… ä¿®å¤ P0-1 å’Œ P0-2 ä»£ç 
2. âœ… æ›´æ–°æµ‹è¯•ç”¨ä¾‹
3. â³ è¿è¡Œæ•°æ®è¿ç§»è„šæœ¬ `pnpm tsx scripts/fix-activity-counts.ts`
4. â³ éªŒè¯ä¿®å¤ç»“æœ

### æœ¬å‘¨å®Œæˆ

1. å¢å¼ºæµ‹è¯•ç”¨ä¾‹:
   - é«˜å¹¶å‘ç‚¹èµæµ‹è¯•ï¼ˆè‡³å°‘100å¹¶å‘ï¼‰
   - äº‹åŠ¡å›æ»šåè®¡æ•°ä¸€è‡´æ€§æµ‹è¯•
2. P1 çº§åˆ«æ”¹è¿›:
   - viewsCount æ›´æ–°çš„é”™è¯¯ç‡ç›‘æ§
   - è½¯åˆ é™¤åè®¡æ•°æ¸…é›¶ç­–ç•¥

### ä¸‹ä¸ªè¿­ä»£

1. P2 çº§åˆ«ä¼˜åŒ–:
   - äº‹åŠ¡éš”ç¦»çº§åˆ«æ–‡æ¡£åŒ–
   - æ•´æ•°æº¢å‡ºé˜²æŠ¤ï¼ˆè€ƒè™‘ BigIntï¼‰

---

## æ€»ç»“

**æ ¸å¿ƒç»“è®º**:

- ğŸŸ¡ å½“å‰çŠ¶æ€: "å‡‘åˆ",å¤§éƒ¨åˆ†æ­£ç¡®,ä½†æœ‰2ä¸ªæ˜æ˜¾çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜
- ğŸŸ¢ ä¿®å¤åå¯è¾¾åˆ°: "å¥½å“å‘³",æ¶ˆé™¤è¾¹ç•Œæƒ…å†µ,æ•°æ®ç»“æ„å’Œé€»è¾‘éƒ½æ­£ç¡®
- âš¡ ä¿®å¤æˆæœ¬: 1ä¸ªå·¥ä½œæ—¥,ä½é£é™©

**å…³é”®æ”¶è·**:

1. äº‹åŠ¡çš„åŸå­æ€§ä¸ä»…åŒ…æ‹¬å†™æ“ä½œ,ä¹Ÿåº”åŒ…æ‹¬è¯»æ“ä½œ
2. å†—ä½™å­—æ®µéœ€è¦åœ¨æ‰€æœ‰ä¿®æ”¹è·¯å¾„ä¸Šä¿æŒä¸€è‡´
3. æ‰¹é‡æ“ä½œå®¹æ˜“é—æ¼å†—ä½™å­—æ®µçš„æ›´æ–°
4. æµ‹è¯•ç”¨ä¾‹åº”è¯¥éªŒè¯æ•°æ®ä¸€è‡´æ€§,è€Œä¸ä»…ä»…æ˜¯æ“ä½œæˆåŠŸ

**æœ€ä½³å®è·µ**:

1. åœ¨äº‹åŠ¡å†…å®Œæˆæ‰€æœ‰ç›¸å…³çš„è¯»å†™æ“ä½œ
2. ä½¿ç”¨ `select` è¿”å›æ›´æ–°åçš„å€¼,é¿å…é¢å¤–æŸ¥è¯¢
3. æ‰¹é‡æ“ä½œæ—¶,å…ˆç»Ÿè®¡å½±å“èŒƒå›´,å†åœ¨äº‹åŠ¡ä¸­æ‰¹é‡æ›´æ–°
4. æµ‹è¯•ç”¨ä¾‹åº”è¯¥è¦†ç›–æ•°æ®ä¸€è‡´æ€§éªŒè¯

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-12  
**ä¿®å¤äººå‘˜**: Claude (åŸºäº Linus Torvalds è§†è§’å®¡è®¡æŠ¥å‘Š)  
**å®¡è®¡æŠ¥å‘Š**: Activity æ¨¡å—æ·±åº¦å®¡è®¡æŠ¥å‘Š (2025-10-12)
