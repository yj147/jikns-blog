# Phase 9 关注系统 - 质量保障与上线准备 PRD (v2.0)

## 1. 业务背景

### 1.1 项目现状

- **核心功能**：关注系统的服务层、API、Hooks、组件已完成开发并通过测试
- **API状态**：4个API端点全部实现（关注/取关、粉丝列表、关注列表、批量状态查询）
- **测试覆盖**：19个API测试全部通过，单元测试覆盖核心业务逻辑
- **集成进度**：Settings页面和Profile页面（`app/profile/[userId]/page.tsx`）已集成关注功能
- **监控基础**：性能监控指标（MetricType）已包含`FOLLOW_ACTION_DURATION`、`FOLLOW_ACTION_RATE_LIMIT`、`FEED_FOLLOWING_RESULT_COUNT`

### 1.2 业务目标

完成Phase
9关注系统的质量保障与上线准备，确保功能稳定、可监控、可回滚，达到生产环境就绪状态。本次工作聚焦于**验证现有实现**而非新增功能开发。

### 1.3 成功指标

- **质量目标**：E2E测试覆盖关键用户流程，连续3次通过
- **可观测性**：关注操作的3个性能指标在实际操作中被正确记录
- **灰度能力**：通过Feature Flag实现功能开关，支持快速回滚
- **文档完整**：实施文档准确反映当前状态，Release Note包含所有必要技术细节

### 1.4 ROI分析

- **风险降低**：E2E测试和Feature Flag降低生产环境故障风险
- **可维护性**：完整文档降低团队成员上手成本和沟通成本
- **上线信心**：质量保障工作确保功能稳定性，减少回滚概率

---

## 2. 用户故事与验收标准

### Epic 1: E2E测试补充（P0 - 必须）

#### User Story 1.1: 关注流程端到端测试

**作为** 测试工程师  
**我希望** 有完整的E2E测试覆盖关注系统的核心用户流程  
**以便** 确保功能在真实浏览器环境中正常工作，避免生产环境出现UI交互问题

**验收标准**：

- [ ] **测试环境配置**：
  - 使用真实的本地Supabase数据库（非Mock）
  - 在Playwright的`globalSetup`中自动seed测试数据（2-3个测试用户、预设关注关系）
  - 在`globalTeardown`中清理测试数据
  - 参考现有`tests/e2e/permissions-e2e.spec.ts`的setup模式

- [ ] **场景1：Feed页面关注推荐用户**：
  - 访问Feed页面，验证推荐用户卡片存在
  - 点击某推荐用户的关注按钮
  - 验证按钮文本从"关注"变为"已关注"
  - 验证按钮状态变化（颜色、图标）
  - 验证toast提示显示成功消息

- [ ] **场景2：关注流Tab验证**：
  - 在场景1的基础上，切换到"关注"Tab
  - 验证Tab可访问（非禁用状态）
  - 验证动态列表中出现被关注用户的内容
  - 验证列表数据来自`/api/activities?orderBy=following`

- [ ] **场景3：取消关注并验证乐观更新**：
  - 在已关注状态下，再次点击关注按钮（取消关注）
  - 验证按钮状态立即变为"关注"（乐观更新）
  - 等待API响应，验证状态保持正确（无回滚）
  - 切换回"关注"Tab，验证该用户的内容已不再显示

- [ ] **场景4：未登录用户访问控制**：
  - 清除登录状态，访问Feed页面
  - 验证"关注"Tab被禁用或隐藏
  - 验证推荐用户卡片的关注按钮提示需要登录

- [ ] **性能要求**：
  - 单个场景执行时间<10秒
  - 测试套件在CI环境稳定通过（连续3次）

#### User Story 1.2: 粉丝/关注列表测试

**作为** 测试工程师  
**我希望** E2E测试覆盖Settings页面的关注管理功能  
**以便** 验证列表查询、分页、搜索、交互功能的正确性

**验收标准**：

- [ ] 访问Settings页面，切换到"社交关系管理"Tab
- [ ] 验证"关注的人"和"粉丝"两个子Tab可访问
- [ ] 验证列表数据正确显示（用户名、头像、关注状态）
- [ ] 验证无限滚动加载（至少触发一次loadMore）
- [ ] 验证搜索过滤功能（输入用户名，列表即时更新）
- [ ] 在列表中点击关注/取关按钮，验证状态即时更新
- [ ] 验证数量统计显示正确（`pagination.total`）

**优先级**：P0（必须） **时间估算**：2-3小时（包括setup配置）

---

### Epic 2: Feature Flag灰度控制（P0 - 必须）

#### User Story 2.1: 关注功能灰度开关

**作为** 运维工程师  
**我希望** 通过环境变量控制关注功能的启用/禁用  
**以便** 在生产环境遇到问题时快速回滚，无需重新部署代码

**验收标准**：

- [ ] **后端实现**：
  - 在`lib/config/feature-flags.ts`中新增`feedFollowingStrict()`方法
  - 读取环境变量`FEATURE_FEED_FOLLOWING_STRICT`（类型：布尔值）
  - 默认值：`true`（开启关注功能）
  - 遵循现有flag的命名和实现模式

- [ ] **前端降级行为（Flag=false时）**：
  - **Feed页面**：
    - "关注"Tab完全隐藏（使用条件渲染：`{featureFlag && <Tab>}`）
    - 不影响其他Tab（"推荐"、"最新"等）的正常显示
  - **FollowButton组件**：
    - 组件显示但处于禁用状态（`disabled={!featureFlag}`）
    - Hover时显示tooltip提示："该功能暂时维护中"
    - 按钮样式变为灰色/禁用态
  - **Settings页面**：
    - "社交关系管理"Tab保持可访问（用户仍可查看现有关注列表）
    - 关注/取关按钮禁用，显示维护提示

- [ ] **配置文档**：
  - 在Release Note中说明环境变量的设置方法
  - 提供回滚操作步骤（设置`FEATURE_FEED_FOLLOWING_STRICT=false`）
  - 说明降级后的用户体验变化

**优先级**：P0（必须） **时间估算**：1小时

---

### Epic 3: 监控验证（P1 - 重要）

#### User Story 3.1: 性能指标验证

**作为** SRE工程师  
**我希望** 确认关注操作的性能指标在实际操作中被正确记录  
**以便** 在生产环境监控关注系统的健康状态，及时发现性能问题

**验收标准**：

- [ ] **手动测试验证**（通过应用日志）：
  - 执行一次关注操作，检查日志中是否记录`FOLLOW_ACTION_DURATION`指标
  - 触发速率限制（连续30次关注），检查`FOLLOW_ACTION_RATE_LIMIT`指标
  - 访问Feed的"关注"Tab，检查`FEED_FOLLOWING_RESULT_COUNT`指标

- [ ] **指标上下文验证**：
  - 验证指标包含`userId`字段
  - 验证指标包含`requestId`字段（用于分布式追踪）
  - 验证指标包含`timestamp`字段

- [ ] **监控脚本验证**（可选，P2优先级）：
  - 验证`scripts/collect-monitoring-data.sh`能正确采集关注指标
  - 如果时间允许，添加`--focus follow`参数支持
  - 如果时间不足，可在后续优化（不阻塞上线）

**优先级**：P1（重要，但可部分延后） **时间估算**：30分钟（手动验证） +
1小时（脚本优化，可选）

---

### Epic 4: 文档更新（P1 - 重要）

#### User Story 4.1: 实施状态同步

**作为** 项目管理者  
**我希望** 设计文档准确反映当前实施进度  
**以便** 团队成员和利益相关方了解项目真实状态，避免信息不对称

**验收标准**：

- [ ] 更新`docs/7-follow/Phase9-关注系统任务计划.md`
- [ ] 标记M0.5-M1的所有任务为✅（已完成）
- [ ] 更新M2-M4的实际状态（区分已完成、进行中、待开始）
- [ ] 新增"实际完成度分析"章节：
  - 说明Profile页面已存在且功能完整（无需路由重构）
  - 说明监控指标已包含在`lib/performance-monitor.ts`
  - 说明超预期完成的部分（Settings页面集成）
- [ ] 更新剩余工作清单（聚焦E2E测试和Feature Flag）

#### User Story 4.2: Release Note编写

**作为** 技术负责人  
**我希望** 有清晰的Release Note面向开发和运维团队  
**以便** 技术团队了解新功能、API变更、配置方法和回滚步骤

**验收标准**：

- [ ] 创建`docs/7-follow/Phase9-Release-Note.md`
- [ ] **核心内容**（使用技术语言，避免营销化表达）：
  1. **功能清单**：
     - 用户关注/取关（幂等操作，防止自关注）
     - 粉丝/关注列表查询（分页、游标支持）
     - 批量状态查询（最多50个用户ID）
     - Feed页面"关注"Tab（基于关注关系过滤动态）
  2. **API变更**：
     - `POST /api/users/[userId]/follow`：关注用户
     - `DELETE /api/users/[userId]/follow`：取消关注
     - `GET /api/users/[userId]/followers`：获取粉丝列表
     - `GET /api/users/[userId]/following`：获取关注列表
     - `POST /api/users/follow/status`：批量查询关注状态
  3. **配置说明**：
     - 环境变量：`FEATURE_FEED_FOLLOWING_STRICT`（默认true）
     - 速率限制：关注操作30次/分钟，批量查询20次/分钟
  4. **灰度上线步骤**：
     - 阶段A：内部测试账号验证
     - 阶段B：10%灰度用户
     - 阶段C：全量上线
  5. **回滚步骤**：
     - 设置`FEATURE_FEED_FOLLOWING_STRICT=false`
     - 重启应用
     - 验证UI降级行为正确
  6. **已知限制**：
     - 批量查询最多50个用户ID
     - 关注关系不支持隐私设置（全部公开）
     - 暂不支持推荐算法（Phase 10+）
  7. **兼容性说明**：
     - 向后兼容，无破坏性变更
     - 现有数据库schema无需迁移
     - 前端API调用保持统一响应格式

**优先级**：P1（重要） **时间估算**：1.5小时

---

## 3. 范围界定

### 3.1 In Scope（包含）

- ✅ E2E测试套件（关注流程、列表交互）
- ✅ Feature Flag实现（feedFollowingStrict）
- ✅ 性能监控手动验证（日志检查）
- ✅ 文档更新（任务计划、Release Note）
- ✅ 验证现有Profile页面功能（通过E2E测试覆盖）

### 3.2 Out of Scope（排除）

- ❌ 核心功能开发（已完成）
- ❌ Profile页面路由重构（现有实现已满足需求）
- ❌ 新增API端点（已完成）
- ❌ 性能优化（当前指标满足需求）
- ❌ 监控脚本的`--focus follow`参数（P2优先级，可后置）
- ❌ 推荐算法改进（Phase 10+）
- ❌ 推送通知系统（Phase 10+）

---

## 4. 技术约束

### 4.1 技术栈

- **测试框架**：Playwright 1.49.1（已配置）
- **测试数据**：真实本地Supabase数据库 + globalSetup/Teardown
- **Feature Flag**：`lib/config/feature-flags.ts`（已存在框架）
- **监控**：`lib/performance-monitor.ts`（MetricType已包含关注指标）
- **文档格式**：Markdown

### 4.2 质量标准

- **测试稳定性**：E2E测试连续3次通过
- **代码质量**：通过`pnpm quality:check`（lint + typecheck）
- **性能要求**：E2E单个场景<10秒
- **文档完整性**：包含所有必要章节（功能、API、配置、回滚）
- **Linus原则**：遵循"Never break userspace"，无破坏性变更

### 4.3 安全与合规

- 速率限制：关注操作30次/分钟，批量查询20次/分钟（已实现）
- CSRF保护：统一使用`secureFetch`与`X-CSRF-Token`（已实现）
- 审计日志：`USER_FOLLOW`、`USER_UNFOLLOW`动作记录（已实现）
- 权限控制：写操作强制`user-active`策略（已实现）

---

## 5. 数据要求

### 5.1 E2E测试数据

- **测试用户**：2-3个用户账号（user1, user2, user3）
- **关注关系**：预设关系（user1关注user2，user2关注user3）
- **动态数据**：每个用户至少1条动态内容（用于验证关注流）
- **清理策略**：测试后完全清理，避免数据污染

### 5.2 性能指标数据

- **指标字段**：type, value, unit, timestamp, context（userId, requestId）
- **存储位置**：应用日志（通过`logger`输出）
- **采集方式**：`performanceMonitor.recordMetric()`

---

## 6. 用户体验考虑

### 6.1 灰度降级体验

- 当Feature Flag关闭时，用户应看到**一致的降级体验**：
  - Feed页面：关注Tab消失，不影响其他Tab
  - 关注按钮：禁用态 + 明确的维护提示
  - Settings页面：可查看现有列表，但无法操作
- 提示文案统一使用："该功能暂时维护中"（避免技术术语）

### 6.2 E2E测试覆盖的UX关键点

- **乐观更新**：按钮状态立即变化，提升感知性能
- **错误回滚**：API失败时状态正确回滚，避免UI不一致
- **未登录提示**：明确引导用户登录，而非显示错误页面
- **空态处理**：未关注任何人时显示引导性文案

---

## 7. 风险与缓解

### 7.1 技术风险

| 风险                               | 等级 | 概率 | 影响     | 缓解措施                                               |
| ---------------------------------- | ---- | ---- | -------- | ------------------------------------------------------ |
| E2E测试Playwright环境配置失败      | 低   | 20%  | 阻塞测试 | 参考现有permissions-e2e.spec.ts，复用已验证的配置      |
| Feature Flag前端读取逻辑位置不明确 | 中   | 30%  | 实现延迟 | 在Architect阶段明确前端Hook实现（参考现有useAuth模式） |
| 性能指标未被正确记录               | 低   | 10%  | 监控失效 | 手动测试验证，查看应用日志确认指标输出                 |
| 文档更新遗漏关键信息               | 低   | 15%  | 沟通成本 | 使用Checklist验证文档完整性                            |

### 7.2 外部依赖

- Playwright浏览器环境：已配置，低风险
- 本地Supabase实例：通过`pnpm supabase:start`启动，已验证
- CI环境E2E支持：需验证（如CI不支持，可先在本地验证）

---

## 8. 时间估算

| 任务                     | 估算时间    | 优先级 |
| ------------------------ | ----------- | ------ |
| E2E测试开发（含setup）   | 2.5小时     | P0     |
| Feature Flag后端实现     | 0.5小时     | P0     |
| Feature Flag前端集成     | 0.5小时     | P0     |
| 性能指标手动验证         | 0.5小时     | P1     |
| 文档更新（任务计划）     | 0.5小时     | P1     |
| Release Note编写         | 1小时       | P1     |
| **总计（P0+P1）**        | **5.5小时** |        |
| 监控脚本优化（可选，P2） | 1小时       | P2     |

**建议时间窗口**：1个工作日（6-8小时，包含缓冲）

---

## 9. 验收流程

### 9.1 开发阶段验收

- [ ] E2E测试在本地环境连续3次通过
- [ ] Feature Flag前后端集成完成，可通过环境变量控制
- [ ] 性能指标在日志中可观察到
- [ ] 代码通过`pnpm quality:check`

### 9.2 Review阶段验收

- [ ] E2E测试代码遵循现有测试模式
- [ ] Feature Flag实现遵循现有flag模式
- [ ] 文档准确无歧义，包含所有必要信息

### 9.3 QA阶段验收

- [ ] 手动验证关注流程（关注→取关→关注流查询）
- [ ] 手动验证Feature Flag开关行为
- [ ] 验证性能指标记录正确
- [ ] 验证文档完整性（对照Checklist）

### 9.4 上线前验收

- [ ] Go/No-Go决策会议通过
- [ ] 灰度上线计划明确
- [ ] 回滚步骤已验证

---

## 10. 后续阶段交接

本PRD完成后，将移交给：

1. **Architect（Alex）**：
   - 输入：本PRD + 现有代码库分析
   - 输出：技术实施方案（E2E测试结构、Feature Flag位置、前端Hook设计）
   - 关键决策：前端如何读取Feature Flag、E2E测试的数据管理策略

2. **SM（Mike）**：
   - 输入：Architect方案
   - 输出：带时间估算的详细任务清单、里程碑定义
   - 关键工作：任务拆解、风险识别、资源分配

3. **Dev（通过Codex）**：
   - 输入：SM任务清单
   - 输出：可运行的代码、测试、文档
   - 执行方式：使用Codex（model: gpt-5, sandbox: danger-full-access）

4. **QA（Quinn）**：
   - 输入：Dev产出物
   - 输出：测试报告、质量评估、上线建议
   - 验证项：功能、灰度、性能、回滚

---

## 11. 附录

### 11.1 参考资料

- Phase9设计文档：`docs/7-follow/Phase9-关注系统设计.md`
- Phase9任务计划：`docs/7-follow/Phase9-关注系统任务计划.md`
- 现有E2E测试：`tests/e2e/permissions-e2e.spec.ts`
- Feature Flag实现：`lib/config/feature-flags.ts`
- 性能监控：`lib/performance-monitor.ts`

### 11.2 关键决策记录

- **决策1**：E2E测试使用真实数据库而非Mock
  → 原因：更接近生产环境，可发现数据库级别的问题
- **决策2**：Feature
  Flag关闭时部分降级（而非完全隐藏） → 原因：平衡用户体验和技术实现复杂度
- **决策3**：监控脚本优化降为P2优先级 → 原因：核心是指标记录，脚本聚合功能可后置
- **决策4**：跳过Profile页面路由重构 → 原因：现有实现已满足需求，遵循"Never
  break userspace"
- **决策5**：Release
  Note面向技术团队 → 原因：关注系统是后端功能，主要影响开发和运维
