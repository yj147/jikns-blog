name: Quality Check

# åœ¨æ‰€æœ‰åˆ†æ”¯çš„ Push å’Œ Pull Request ä¸Šè¿è¡Œ
on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["main", "develop"]

# å¹¶å‘æŽ§åˆ¶ï¼šåŒä¸€åˆ†æ”¯åªè¿è¡Œä¸€ä¸ªè´¨é‡æ£€æŸ¥
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-check:
    name: "ä»£ç è´¨é‡æ£€æŸ¥"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "ðŸ“¥ æ£€å‡ºä»£ç "
        uses: actions/checkout@v4

      - name: "ðŸ“¦ å®‰è£… pnpm"
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: "âš™ï¸ è®¾ç½® Node.js çŽ¯å¢ƒ"
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: "ðŸ“¥ å®‰è£…ä¾èµ–"
        run: pnpm install --frozen-lockfile

      - name: "ðŸ” ESLint ä»£ç è§„èŒƒæ£€æŸ¥"
        run: pnpm lint:check --max-warnings 1000

      - name: "ðŸŽ¯ TypeScript ç±»åž‹æ£€æŸ¥"
        run: pnpm type-check

      - name: "ðŸŽ¨ Prettier æ ¼å¼æ£€æŸ¥"
        run: pnpm format:check

      - name: "ðŸ§ª å…³é”®æµ‹è¯•ç”¨ä¾‹"
        run: pnpm test:critical
        timeout-minutes: 5

      - name: "ðŸ“Š æµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š"
        run: |
          pnpm test:coverage --reporter=json --reporter=text-summary > coverage-summary.txt || true
          if [ -f coverage-summary.txt ]; then
            echo "## æµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -10 coverage-summary.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: "âœ… è´¨é‡æ£€æŸ¥å®Œæˆ"
        if: success()
        run: |
          echo "## âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "- Prettier: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "- å…³é”®æµ‹è¯•: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY

      - name: "âŒ è´¨é‡æ£€æŸ¥å¤±è´¥"
        if: failure()
        run: |
          echo "## âŒ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åŽé‡æ–°æäº¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ ä¿®å¤å»ºè®®:" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡Œ \`pnpm lint --fix\` ä¿®å¤ ESLint é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡Œ \`pnpm format\` ä¿®å¤æ ¼å¼é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡Œ \`pnpm type-check\` æ£€æŸ¥ç±»åž‹é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡Œ \`pnpm test:critical\` æŸ¥çœ‹æµ‹è¯•å¤±è´¥è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
