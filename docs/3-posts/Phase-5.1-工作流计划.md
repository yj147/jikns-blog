# Phase 5.1 Post CRUD + Markdown 工作流计划

**生成时间**: 2025-08-26  
**项目**: 现代化博客与社交动态平台  
**阶段**: Phase 5.1 - 文章管理系统实施  
**预计工期**: 5-6 天

## 📋 执行摘要

本工作流计划基于《Post-CRUD-设计.md》和《编辑器选型决策.md》，为 Phase
5.1 文章管理系统的实施提供详细的任务分解、并行化策略和质量保障措施。

### 核心目标

- ✅ 实现完整的文章 CRUD 功能
- ✅ 集成 Markdown 编辑器
- ✅ 构建权限控制系统
- ✅ 支持图片上传和 SEO 优化
- ✅ 达到 90%+ 测试覆盖率

### 并行化策略

- 🚀 **基础设施并行**: 数据库、类型系统、工具函数同时开发
- 🚀 **组件并行**: UI 组件独立开发，后期集成
- 🚀 **测试并行**: 多种测试类型同时执行
- 🚀 **预期效率提升**: 60% 时间节省

---

## 🔄 前置条件检查清单

在开始实施前，必须完成以下前置任务：

### 环境配置

- [ ] Supabase 本地 Docker 环境运行中
- [ ] PostgreSQL 数据库可访问
- [ ] 环境变量文件 `.env.local` 已配置
- [ ] Node.js 22.x 和 pnpm 9.12.0 已安装

### 项目依赖

- [ ] Prisma 6.14.x 已安装和初始化
- [ ] @uiw/react-md-editor 4.0.4 已安装
- [ ] Vitest 2.x 测试框架已配置
- [ ] shadcn/ui 组件库已集成

### 数据库准备

- [ ] Prisma schema 文件已创建
- [ ] 数据库连接字符串已配置
- [ ] Supabase Storage bucket 已创建

---

## 📅 Phase 5.1.1: 核心基础设施（第1天）

### 🎯 目标

建立项目的数据层基础和类型系统，为后续开发提供坚实基础。

### 并行任务组 A：数据库基础设施

```bash
# 可并行执行的命令
pnpm prisma init
pnpm prisma generate
docker-compose up -d
```

**任务清单**：

- [ ] 配置 Prisma 连接 Supabase 本地数据库
- [ ] 实现 Post 数据模型定义
- [ ] 创建关联模型（Tag, PostTag, Comment, Like）
- [ ] 生成初始迁移文件
- [ ] 配置 Supabase Storage bucket

**预期产出**：

- `prisma/schema.prisma` - 完整的数据模型
- `supabase/migrations/*.sql` - 数据库迁移文件
- `lib/prisma.ts` - Prisma 客户端实例

### 并行任务组 B：类型系统定义

**任务清单**：

- [ ] 创建 Post 相关 TypeScript 类型定义
- [ ] 实现 Zod Schema 验证规则
- [ ] 定义 API 结果和错误类型
- [ ] 创建权限角色枚举

**预期产出**：

- `types/post.ts` - Post 相关类型
- `lib/schemas/post.ts` - Zod 验证 Schema
- `types/api.ts` - API 响应类型
- `types/auth.ts` - 认证授权类型

### 并行任务组 C：工具函数库

**任务清单**：

- [ ] 实现 slug 生成和去重函数
- [ ] 创建内容清洗和安全函数
- [ ] 开发缓存管理工具
- [ ] 构建统一错误处理

**预期产出**：

- `lib/utils/slug.ts` - Slug 处理工具
- `lib/utils/sanitize.ts` - 内容清洗工具
- `lib/utils/cache.ts` - 缓存管理
- `lib/utils/error-handler.ts` - 错误处理

### 🚀 并行执行优化

- 三个任务组可同时进行，无依赖关系
- 使用多终端或后台任务执行
- 预计完成时间：6-8 小时

---

## 📅 Phase 5.1.2: Server Actions 实现（第2天）

### 🎯 目标

实现完整的文章管理后端逻辑，包括 CRUD 操作和权限控制。

### 串行任务链

**执行顺序严格按照依赖关系**：

1. **权限验证中间件**（2小时）
   - [ ] 实现 `getCurrentUser` 函数
   - [ ] 创建 `requireAuth` 中间件
   - [ ] 创建 `requireAdmin` 中间件
   - [ ] 实现 `withAuth` 装饰器

2. **创建文章 API**（2小时）
   - [ ] 实现 `createPost` Server Action
   - [ ] 处理 slug 生成逻辑
   - [ ] 实现标签关联处理
   - [ ] 添加输入验证

3. **更新文章 API**（2小时）
   - [ ] 实现 `updatePost` Server Action
   - [ ] 处理 slug 冲突检测
   - [ ] 实现标签更新逻辑
   - [ ] 处理发布状态变更

4. **查询文章 API**（2小时）
   - [ ] 实现 `getPosts` 分页查询
   - [ ] 实现 `getPost` 单篇查询
   - [ ] 添加搜索和筛选功能
   - [ ] 实现浏览次数统计

5. **状态操作 API**（1小时）
   - [ ] 实现 `publishPost` 功能
   - [ ] 实现 `unpublishPost` 功能
   - [ ] 实现 `togglePinPost` 功能
   - [ ] 实现 `deletePost` 功能

6. **图片上传 API**（1小时）
   - [ ] 实现 `uploadPostImage` 功能
   - [ ] 集成 Supabase Storage
   - [ ] 添加文件验证
   - [ ] 实现 URL 生成

**预期产出**：

- `lib/actions/posts.ts` - 所有 Server Actions
- `lib/auth/permissions.ts` - 权限验证逻辑
- `lib/utils/post-state.ts` - 状态机实现

---

## 📅 Phase 5.1.3: 编辑器和 UI 组件（第3天）

### 🎯 目标

构建用户界面组件，包括 Markdown 编辑器和表单组件。

### 并行任务组 D：编辑器开发

**任务清单**：

- [ ] 集成 @uiw/react-md-editor
- [ ] 实现图片拖拽上传
- [ ] 添加粘贴图片支持
- [ ] 创建自动保存 Hook
- [ ] 实现工具栏扩展

**预期产出**：

- `components/editor/markdown-editor.tsx`
- `hooks/use-auto-save.ts`
- `lib/markdown/renderer.ts`

### 并行任务组 E：UI 组件开发

**任务清单**：

- [ ] 创建 PostForm 综合表单组件
- [ ] 实现 PostList 列表组件
- [ ] 开发 PostCard 卡片组件
- [ ] 创建 PostStatusBadge 状态标识
- [ ] 实现 PostActions 操作菜单

**预期产出**：

- `components/admin/post-form.tsx`
- `components/admin/post-list.tsx`
- `components/ui/post-card.tsx`
- `components/ui/post-status-badge.tsx`

### 🚀 并行执行优化

- 编辑器和 UI 组件可同时开发
- 使用 Storybook 进行独立组件开发（可选）
- 预计完成时间：6-8 小时

---

## 📅 Phase 5.1.4: 页面集成（第4天）

### 🎯 目标

将组件集成到实际页面中，实现完整的用户流程。

### 串行任务链

1. **文章创建页面**（2小时）
   - [ ] 创建 `/admin/posts/create` 页面
   - [ ] 集成 PostForm 组件
   - [ ] 实现提交处理逻辑
   - [ ] 添加成功/失败反馈

2. **文章编辑页面**（2小时）
   - [ ] 创建 `/admin/posts/edit/[id]` 页面
   - [ ] 实现数据预加载
   - [ ] 处理更新逻辑
   - [ ] 添加删除确认

3. **文章列表页面**（3小时）
   - [ ] 创建 `/admin/posts` 页面
   - [ ] 实现分页和搜索
   - [ ] 添加批量操作
   - [ ] 集成状态筛选

4. **路由和导航**（1小时）
   - [ ] 更新管理员导航菜单
   - [ ] 添加面包屑导航
   - [ ] 实现路由保护
   - [ ] 配置页面元数据

**预期产出**：

- `app/admin/posts/page.tsx`
- `app/admin/posts/create/page.tsx`
- `app/admin/posts/edit/[id]/page.tsx`
- 更新的导航组件

---

## 📅 Phase 5.1.5: 测试实施（第5天）

### 🎯 目标

确保代码质量，达到 90%+ 的测试覆盖率。

### 并行测试组

#### 测试组 F：单元测试

**任务清单**：

- [ ] Server Actions 单元测试
- [ ] 工具函数单元测试
- [ ] 状态机逻辑测试
- [ ] 权限验证测试

**测试文件**：

- `tests/lib/actions/posts.test.ts`
- `tests/lib/utils/*.test.ts`
- `tests/lib/auth/*.test.ts`

#### 测试组 G：组件测试

**任务清单**：

- [ ] MarkdownEditor 组件测试
- [ ] PostForm 表单测试
- [ ] PostList 列表测试
- [ ] UI 组件快照测试

**测试文件**：

- `tests/components/editor/*.test.tsx`
- `tests/components/admin/*.test.tsx`

#### 测试组 H：集成测试

**任务清单**：

- [ ] API 端到端测试
- [ ] 数据库事务测试
- [ ] 权限流程测试
- [ ] 文件上传测试

**测试文件**：

- `tests/integration/posts-api.test.ts`
- `tests/integration/auth-flow.test.ts`

### 🚀 并行执行优化

- 三种测试类型可同时运行
- 使用 `vitest --run` 并行模式
- 预计完成时间：6-8 小时

---

## 📅 Phase 5.1.6: 质量保障和优化（第6天）

### 🎯 目标

确保代码符合质量标准，优化性能，准备交付。

### 质量检查任务

1. **代码质量检查**（2小时）
   - [ ] 运行 ESLint 检查并修复
   - [ ] TypeScript 严格模式验证
   - [ ] 清理未使用的代码
   - [ ] 代码格式化（Prettier）

2. **测试覆盖率验证**（1小时）
   - [ ] 生成覆盖率报告
   - [ ] 确保单元测试 >90%
   - [ ] 确保组件测试 >80%
   - [ ] 补充缺失的测试

3. **性能优化**（2小时）
   - [ ] 分析 bundle 大小
   - [ ] 优化数据库查询
   - [ ] 实现查询缓存
   - [ ] 图片懒加载优化

4. **安全审查**（2小时）
   - [ ] XSS 防护验证
   - [ ] SQL 注入防护检查
   - [ ] 文件上传安全验证
   - [ ] 权限边界测试

5. **文档更新**（1小时）
   - [ ] 更新 API 文档
   - [ ] 编写使用指南
   - [ ] 更新 README
   - [ ] 创建部署说明

**质量门禁标准**：

- ✅ ESLint 0 错误
- ✅ TypeScript 0 错误
- ✅ 测试覆盖率 >90%
- ✅ 性能基准达标
- ✅ 安全扫描通过

---

## 🎯 关键性能指标（KPI）

### 性能指标

| 指标         | 目标值 | 验收标准    |
| ------------ | ------ | ----------- |
| API 响应时间 | <200ms | P95 分位数  |
| 编辑器初始化 | <100ms | 首次渲染    |
| 图片上传     | <2s    | 10MB 文件   |
| 页面加载     | <1s    | FCP 指标    |
| Bundle 增量  | <200KB | gzip 压缩后 |

### 质量指标

| 指标           | 目标值 | 验收标准  |
| -------------- | ------ | --------- |
| 单元测试覆盖率 | >90%   | 语句覆盖  |
| 组件测试覆盖率 | >80%   | 分支覆盖  |
| E2E 测试通过率 | 100%   | 核心流程  |
| 代码复杂度     | <10    | 圈复杂度  |
| 技术债务比率   | <5%    | SonarQube |

---

## 🚨 风险管理

### 高风险项及缓解措施

| 风险                | 可能性 | 影响 | 缓解措施               |
| ------------------- | ------ | ---- | ---------------------- |
| **Prisma 连接问题** | 中     | 高   | 准备原生 SQL 备选方案  |
| **编辑器兼容性**    | 低     | 中   | 降级到 textarea + 预览 |
| **图片上传失败**    | 中     | 中   | 实现重试和本地缓存     |
| **性能不达标**      | 低     | 高   | 提前进行性能测试       |

### 应急预案

1. **数据库连接失败**：使用 Supabase 云端数据库
2. **编辑器崩溃**：提供纯文本编辑模式
3. **测试覆盖不足**：延长测试阶段 1 天
4. **性能瓶颈**：实施缓存和分页优化

---

## ✅ 交付清单

### 代码交付物

- [ ] Server Actions 完整实现
- [ ] React 组件库
- [ ] 管理页面实现
- [ ] 数据库迁移文件
- [ ] 测试套件

### 文档交付物

- [ ] API 使用文档
- [ ] 组件使用指南
- [ ] 部署说明书
- [ ] 测试报告
- [ ] 性能测试报告

### 质量保证

- [ ] 代码审查通过
- [ ] 测试全部通过
- [ ] 性能基准达标
- [ ] 安全扫描通过
- [ ] 文档完整性检查

---

## 🔄 每日站会议题

### Day 1 - 基础设施

- 确认环境配置完成
- 同步数据模型理解
- 识别技术障碍

### Day 2 - Server Actions

- 验证权限逻辑
- API 设计评审
- 集成问题讨论

### Day 3 - UI 组件

- 组件设计评审
- 编辑器集成状态
- UX 反馈收集

### Day 4 - 页面集成

- 用户流程验证
- 路由设计确认
- 集成测试准备

### Day 5 - 测试

- 测试覆盖率评审
- Bug 优先级排序
- 修复计划制定

### Day 6 - 交付

- 最终质量检查
- 部署准备确认
- 下一阶段规划

---

## 🎉 成功标准

Phase 5.1 成功完成的标志：

1. **功能完整性**
   - ✅ 管理员可以创建、编辑、发布、删除文章
   - ✅ Markdown 编辑器正常工作
   - ✅ 图片上传功能可用
   - ✅ SEO 字段支持完整

2. **质量标准**
   - ✅ 测试覆盖率达标
   - ✅ 无严重 Bug
   - ✅ 性能指标达标
   - ✅ 安全审查通过

3. **用户体验**
   - ✅ 界面响应流畅
   - ✅ 错误提示清晰
   - ✅ 操作反馈及时
   - ✅ 数据保存可靠

---

## 📝 备注

- 本计划基于 6 天工期制定，可根据实际情况调整
- 并行任务需要团队协作或个人多任务切换
- 每日结束前进行进度同步和障碍识别
- 保持灵活性，必要时调整优先级

**文档版本**: 1.0  
**最后更新**: 2025-08-26  
**下一步行动**: 开始 Phase 5.1.1 基础设施配置
