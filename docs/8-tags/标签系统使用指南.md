# 标签系统使用指南

**版本**: v1.0  
**更新日期**: 2025-10-09  
**适用对象**: 管理员和普通用户

---

## 目录

1. [系统概述](#系统概述)
2. [管理员使用指南](#管理员使用指南)
3. [用户使用指南](#用户使用指南)
4. [常见问题解答](#常见问题解答)
5. [最佳实践](#最佳实践)

---

## 系统概述

标签系统是博客内容组织和检索的核心功能，支持：

- **标签管理**：管理员可创建、编辑、删除标签
- **标签云**：用户可浏览所有标签，按文章数量排序
- **标签详情**：查看特定标签下的所有文章
- **标签筛选**：在博客列表页按标签筛选文章
- **标签自动补全**：文章编辑时智能推荐标签
- **热门标签推荐**：在文章详情页显示热门标签

---

## 管理员使用指南

### 1. 访问标签管理页面

1. 登录管理员账号
2. 访问 `/admin/tags` 或通过导航栏进入"标签管理"
3. 页面显示所有标签列表，包括：
   - 标签名称和颜色
   - URL 路径（slug）

- 关联的文章数量（仅统计已发布文章）
  - 创建时间
  - 操作按钮（编辑、删除）

### 2. 创建新标签

**步骤**：

1. 点击页面右上角的"创建标签"按钮
2. 在弹出的对话框中填写：
   - **标签名称**（必填）：1-50个字符，支持中英文、数字、空格、连字符和下划线
   - **标签描述**（可选）：最多200个字符，用于标签详情页的说明
   - **标签颜色**（可选）：选择或输入 #RRGGBB 格式的颜色代码
3. 系统会自动生成 URL 路径（slug），实时显示在表单中
4. 点击"创建标签"按钮提交

**注意事项**：

- 标签名称必须唯一，不能与现有标签重复
- URL 路径会自动根据标签名称生成，无需手动输入
- 颜色用于标签的视觉标识，建议选择与内容主题相关的颜色

**示例**：

```
标签名称: JavaScript
标签描述: JavaScript 编程语言相关文章
标签颜色: #F7DF1E (JavaScript 官方黄色)
自动生成的 slug: javascript
```

### 3. 编辑标签

**步骤**：

1. 在标签列表中找到要编辑的标签
2. 点击该标签行右侧的"编辑"按钮（铅笔图标）
3. 在弹出的对话框中修改标签信息
4. 点击"保存更改"按钮提交

**注意事项**：

- 修改标签名称会自动重新生成 URL 路径
- 修改标签不会影响已关联的文章
- 如果新名称与其他标签重复，系统会提示错误

### 4. 删除标签

**步骤**：

1. 在标签列表中找到要删除的标签
2. 点击该标签行右侧的"删除"按钮（垃圾桶图标）
3. 在确认对话框中查看警告信息：
   - 如果标签关联了文章，会显示文章数量
   - 删除后，这些文章的标签关联将被移除
4. 点击"确认删除"按钮完成删除

**注意事项**：

- 删除操作不可撤销，请谨慎操作
- 删除标签会自动移除所有文章的关联关系，并触发计数重算与缓存刷新
- 建议在删除前确认标签是否还在使用中

### 5. 搜索和排序标签

**搜索功能**：

- 在搜索框中输入关键词，实时过滤标签列表
- 支持模糊匹配标签名称
- 搜索参数会自动剥离非法字符（如
  `#`、`%`、表情），若输入最终为空将退回完整列表，不会再触发整页错误
- 搜索结果会自动更新，无需点击搜索按钮

**排序功能**：

- 点击排序选择器，选择排序方式：
  - **文章数（多到少）**：默认排序，显示最常用的标签
  - **文章数（少到多）**：显示使用较少的标签
  - **名称（A-Z）**：按字母顺序排序
  - **名称（Z-A）**：按字母倒序排序
  - **创建时间（新到旧）**：显示最新创建的标签
  - **创建时间（旧到新）**：显示最早创建的标签

### 7. API 接入与速率限制

- Server Actions 统一位于 `lib/actions/tags/`：
  - `getTags(options)`：分页获取标签列表（支持
    `page`、`limit`、`orderBy`、`order`、`search` 参数）。
  - `getTag(slugOrId)`：根据 ID 或 slug 查询标签详情。
  - `getPopularTags(limit)`：获取热门标签（按文章数降序）。
- `searchTags(query, limit)`：搜索标签（模糊匹配名称）。
- `createTag(data)`：创建新标签（需管理员权限）。
- `updateTag(tagId, data)`：更新标签字段（需管理员权限）。
- `deleteTag(tagId)`：删除标签（需管理员权限）。
- 为保护管理接口，创建/更新/删除操作共享限流规则：**每 60 秒最多 8 次**，超限返回
  `429 RATE_LIMIT_EXCEEDED`，响应体中包含 `retryAfter` 秒级提示。
- 读操作中的 `getTag` 与 `searchTags` 共用 `search` 限流桶：**30 次 /
  30 秒 / 每 IP（登录用户切换为 userId）**。一旦触发 429，同样会返回
  `retryAfter`（单位：秒），请按该时间退避重试，可配合指数退避（例如
  `sleep(retryAfter * 1.5)`）以避免再次击穿。
- `getTags` 分页接口目前仅依赖缓存而不做速率限制：命中
  `revalidateTag("tags:list")` 或 `tags:detail`
  标签即会自动清空缓存，可放心读取。
- 列表查询默认缓存 120 秒并打上 `tags:list` 缓存标签；详情查询打上 `tags:detail`
  缓存标签；任何标签写操作会触发 `revalidateTag("tags:list")` 和
  `revalidateTag("tags:detail")`，保证前端可刷新出最新数据。
- 推荐第三方集成应用在收到 429 时读取 `retryAfter` 并退避重试。

**CSRF 约束**：

- 所有写接口（POST/PATCH/DELETE `/api/tags`）必须携带 `X-CSRF-Token`
  头；`GET /api/csrf-token` 会一次性生成 token，并同时写入响应 JSON 与
  `csrf-token` HttpOnly Cookie，两个值完全一致，可直接复用。
- 客户端如果检测到 403 `CSRF_INVALID`，只需重新调用 `/api/csrf-token`
  并刷新 token，即可恢复操作；无需再手动拼 cookie。

### 6. 在文章编辑中使用标签

**标签自动补全**（如果已集成）：

1. 在文章编辑页面找到"标签"字段
2. 开始输入标签名称，系统会自动搜索匹配的标签
3. 从下拉列表中选择已有标签，或创建新标签
4. 已选标签会显示在输入框下方，可点击删除
5. 支持键盘导航：
   - 上下箭头键：选择建议标签
   - 回车键：确认选择或创建新标签
   - ESC 键：关闭下拉列表
   - Backspace 键：删除最后一个标签

**最佳实践**：

- 优先使用已有标签，避免创建重复或相似的标签
- 每篇文章建议添加 3-5 个标签
- 标签应准确描述文章的主题和内容
- 避免使用过于宽泛或过于具体的标签

---

## 用户使用指南

### 1. 浏览标签云

**访问方式**：

- 直接访问 `/tags` 页面
- 或通过导航栏的"标签"链接

**功能说明**：

- 标签云以网格形式展示所有标签
- 标签大小根据文章数量动态调整：
  - 文章数 ≥ 20：大字体
  - 文章数 ≥ 10：中等字体
  - 文章数 ≥ 5：小字体
  - 文章数 < 5：基础字体
- 每个标签显示：
  - 标签名称
  - 文章数量
  - 自定义颜色（如果设置）
- 点击标签可跳转到标签详情页

**搜索标签**：

- 在搜索框中输入关键词
- 实时过滤标签列表
- URL 会自动更新为 `/tags?q=关键词`

### 2. 查看标签详情

**访问方式**：

- 从标签云点击标签
- 或直接访问 `/tags/[标签slug]`

**页面内容**：

- **标签信息**：
  - 标签名称和颜色
  - 标签描述（如果有）
- 关联的文章数量（仅统计已发布文章）
- **文章列表**：
  - 显示该标签下的所有已发布文章
  - 每页显示 10 篇文章
  - 支持分页浏览
- **返回按钮**：点击返回标签云页面

### 3. 使用标签筛选文章

**在博客列表页**：

1. 访问 `/blog` 页面
2. 在侧边栏找到"热门标签"或"标签筛选"组件
3. 点击任意标签进行筛选
4. URL 会更新为 `/blog?tag=[标签slug]`
5. 文章列表会自动更新，只显示该标签的文章

**清除筛选**：

- 点击"清除筛选"或"查看全部"按钮
- 或点击已选中的标签取消选择

**多标签筛选**（如果支持）：

- 可以选择多个标签
- 文章必须同时包含所有选中的标签（AND 逻辑）

### 4. 发现热门标签

**在文章详情页**：

- 侧边栏会显示"热门标签"组件
- 展示最常用的 8-10 个标签
- 点击标签可快速跳转到标签详情页

---

## 常见问题解答

### Q1: 为什么我创建的标签名称被拒绝？

**A**: 可能的原因：

1. 标签名称已存在（不区分大小写）
2. 标签名称包含不支持的特殊字符
3. 标签名称长度超过 50 个字符

**解决方案**：

- 检查是否有相同或相似的标签
- 使用字母、数字、中文、空格、连字符或下划线
- 缩短标签名称

### Q2: 删除标签会影响文章吗？

**A**: 删除标签不会删除文章本身，但会：

- 移除文章与该标签的关联关系
- 文章仍然存在，只是不再显示该标签
- 文章的其他标签不受影响

### Q3: 如何合并重复的标签？

**A**: 目前系统不支持自动合并标签，建议：

1. 创建一个统一的标签名称
2. 手动编辑相关文章，替换旧标签为新标签
3. 删除不再使用的旧标签

### Q4: 标签的 URL 路径（slug）可以自定义吗？

**A**: 不可以。URL 路径由系统根据标签名称自动生成，确保：

- URL 友好（小写字母、连字符）
- 唯一性（不会重复）
- 一致性（相同名称生成相同 slug）

### Q5: 为什么标签的文章数量不准确？

**A**: 可能的原因：

1. 数据库同步延迟（通常几秒内自动更新）
2. 缓存未刷新（刷新页面即可）
3. 数据不一致（联系管理员触发标签重算，并检查审计日志定位原因）

---

## 最佳实践

### 管理员最佳实践

1. **标签命名规范**：
   - 使用简洁、准确的名称
   - 避免使用缩写或行话
   - 保持命名风格一致（如全部使用中文或英文）

2. **标签层级控制**：
   - 控制标签总数在 50-100 个以内
   - 定期清理不再使用的标签
   - 避免创建过于相似的标签

3. **标签描述编写**：
   - 简要说明标签的用途和范围
   - 帮助用户理解标签的含义
   - 提高内容的可发现性

4. **记录与审计**：
   - `createTag`/`updateTag`/`deleteTag` 均通过 `auditLogger.logEvent`
     写入审计日志，记录 requestId、管理员 ID、IP、User-Agent、目标标签以及成功/失败原因。
   - 出现计数异常时，先查看审计日志定位具体操作，再触发
     `syncPostTags`/`recalculateTagCounts` 修复
   - 审计日志存放在 `logs/audit-*.log`，便于导出与合规审查

### 用户最佳实践

1. **高效浏览**：
   - 使用标签云快速了解博客的主题分布
   - 通过热门标签发现最受欢迎的内容
   - 使用搜索功能快速定位感兴趣的标签

2. **精准筛选**：
   - 使用标签筛选功能缩小文章范围
   - 结合多个标签进行精确查找
   - 利用标签详情页浏览特定主题的所有文章

3. **内容发现**：
   - 关注文章详情页的热门标签推荐
   - 探索相关标签，发现更多感兴趣的内容
   - 通过标签建立知识体系

---

## 技术支持

如有问题或建议，请联系：

- 项目仓库：[GitHub Issues]
- 邮箱：[support@example.com]

---

_最后更新: 2025-10-09_  
_版本: v1.0_
