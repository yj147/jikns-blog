# è®¤è¯ç³»ç»Ÿé‡æ„ä»»åŠ¡æ¸…å•

**åˆ›å»ºæ—¥æœŸ**: 2025-10-11 **åŸºäºå®¡è®¡**: Linus Torvaldsè§†è§’çš„è®¤è¯æ¨¡å—å®¡è®¡æŠ¥å‘Š
**ç›®æ ‡**: ç®€åŒ–æ¶æ„ã€æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µã€æå‡å¯ç»´æŠ¤æ€§

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

åŸºäºLinuså¼å®¡è®¡ç»“æœï¼Œè®¤è¯ç³»ç»Ÿéœ€è¦è¿›è¡Œ**ç®€åŒ–é‡æ„**ã€‚å½“å‰ç³»ç»ŸåŠŸèƒ½å®Œæ•´ã€æµ‹è¯•è¦†ç›–å¥½ï¼Œä½†å­˜åœ¨**è¿‡åº¦å·¥ç¨‹åŒ–**é—®é¢˜ã€‚æœ¬é‡æ„å°†ä¿ç•™æ ¸å¿ƒåŠŸèƒ½å’Œå®‰å…¨ç‰¹æ€§ï¼Œæ¶ˆé™¤ä¸å¿…è¦çš„å¤æ‚æ€§ã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š

1. æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ
2. ä¿æŒAPIå‘åå…¼å®¹
3. ç®€åŒ–å³ç¾
4. ä¸ç ´åç°æœ‰æµ‹è¯•

---

## ğŸ”´ P0 - å¿…é¡»ä¿®å¤ï¼ˆå½±å“ç”Ÿäº§ç¨³å®šæ€§ï¼‰

### P0-1: åˆ é™¤å†…å­˜ç¼“å­˜æœºåˆ¶

**é—®é¢˜ä¸¥é‡æ€§**: ğŸ”´ ç”Ÿäº§ç¯å¢ƒå®šæ—¶ç‚¸å¼¹

**å½“å‰é—®é¢˜**:

- æ–‡ä»¶: `lib/permissions.ts:18-19`
- ä½¿ç”¨å†…å­˜Mapç¼“å­˜ç”¨æˆ·æƒé™
- åœ¨serverless/å¤šå®ä¾‹ç¯å¢ƒä¼šå¯¼è‡´ç¼“å­˜ä¸ä¸€è‡´
- å­˜åœ¨å®‰å…¨é£é™©ï¼ˆè¢«å°ç¦ç”¨æˆ·å¯èƒ½ç»§ç»­è®¿é—®ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
// åˆ é™¤è¿™äº›ä»£ç 
âŒ const userPermissionCache = new Map<string, PermissionCacheEntry>()
âŒ const CACHE_DURATION = 5 * 60 * 1000

// ç®€åŒ–ä¸ºç›´æ¥æŸ¥è¯¢
âœ… async function getCachedUser(): Promise<AuthenticatedUser | null> {
  return await fetchAuthenticatedUser()
  // ä¸ç¼“å­˜ï¼ŒPrismaè¿æ¥æ± å·²è¶³å¤Ÿå¿«
}
```

**å½±å“èŒƒå›´**:

- `lib/permissions.ts` - åˆ é™¤ç¼“å­˜ç›¸å…³ä»£ç 
- `clearPermissionCache()` - å‡½æ•°å¯ä»¥ä¿ç•™ä½†å˜æˆç©ºæ“ä½œ

**æµ‹è¯•éªŒè¯**:

- [ ] è¿è¡Œ `pnpm test:permissions`
- [ ] ç¡®è®¤æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] éªŒè¯APIå“åº”æ—¶é—´ä»åœ¨å¯æ¥å—èŒƒå›´

**é¢„è®¡å·¥æ—¶**: 30åˆ†é’Ÿ

---

### P0-2: ç®€åŒ–æ•°æ®åŒæ­¥æœºåˆ¶

**é—®é¢˜ä¸¥é‡æ€§**: ğŸ”´ ç«æ€æ¡ä»¶é£é™©

**å½“å‰é—®é¢˜**:

- åŒæ—¶ä½¿ç”¨Database Trigger + ä¸šåŠ¡ä»£ç åŒæ­¥
- ä¸¤ç§æœºåˆ¶å¯èƒ½äº§ç”Ÿç«æ€æ¡ä»¶
- è¿å"æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ"åŸåˆ™

**ä¿®å¤æ–¹æ¡ˆ**:

**æ­¥éª¤1**: åˆ é™¤Database Triggerä¾èµ–

```sql
-- å¦‚æœå­˜åœ¨Triggerï¼Œåœ¨Supabaseä¸­åˆ é™¤
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user();
```

**æ­¥éª¤2**: ç»Ÿä¸€ä½¿ç”¨upsertæ¨¡å¼

```typescript
// app/auth/callback/route.ts
async function handleUserSync(authUser: any) {
  await prisma.user.upsert({
    where: { id: authUser.id },
    create: {
      id: authUser.id,
      email: authUser.email!,
      name: authUser.user_metadata?.full_name,
      avatarUrl: authUser.user_metadata?.avatar_url,
      role: "USER",
      status: "ACTIVE",
      lastLoginAt: new Date(),
    },
    update: {
      lastLoginAt: new Date(),
      name: authUser.user_metadata?.full_name,
      avatarUrl: authUser.user_metadata?.avatar_url,
    },
  })
}
```

**æ­¥éª¤3**: æ›´æ–°åŒæ­¥å‡½æ•°

- æ–‡ä»¶: `lib/auth.ts` ä¸­çš„ `syncUserFromAuth()`
- æ”¹ä¸ºåªä½¿ç”¨upserté€»è¾‘
- åˆ é™¤æ‰€æœ‰Triggerç›¸å…³çš„æ–‡æ¡£è¯´æ˜

**å½±å“èŒƒå›´**:

- `app/auth/callback/route.ts` - OAuthå›è°ƒå¤„ç†
- `lib/auth.ts` - syncUserFromAuthå‡½æ•°
- `app/api/auth/login/route.ts` - ç™»å½•åŒæ­¥
- `docs/2-auth/è®¤è¯ç³»ç»ŸæŠ€æœ¯æ¶æ„è®¾è®¡.md` - åˆ é™¤Triggerç›¸å…³è¯´æ˜

**æµ‹è¯•éªŒè¯**:

- [ ] æµ‹è¯•GitHub OAuthç™»å½•æµç¨‹
- [ ] æµ‹è¯•é‚®ç®±ç™»å½•æµç¨‹
- [ ] éªŒè¯æ–°ç”¨æˆ·åˆ›å»ºæ­£ç¡®
- [ ] éªŒè¯ç°æœ‰ç”¨æˆ·æ›´æ–°æ­£ç¡®
- [ ] æ£€æŸ¥æ— é‡å¤ç”¨æˆ·è®°å½•

**é¢„è®¡å·¥æ—¶**: 1å°æ—¶

---

## ğŸŸ¡ P1 - å¼ºçƒˆå»ºè®®ï¼ˆæ”¹å–„ä»£ç è´¨é‡ï¼‰

### P1-1: åˆå¹¶æƒé™éªŒè¯å±‚æ¬¡

**é—®é¢˜ä¸¥é‡æ€§**: ğŸŸ¡ ä»£ç å†—ä½™å’Œç»´æŠ¤æˆæœ¬

**å½“å‰é—®é¢˜**:

- ä¸‰å±‚æƒé™éªŒè¯ï¼šmiddleware â†’ route-guard â†’ permissions
- `route-guard.ts` å’Œ `permissions.ts` åŠŸèƒ½é‡å¤
- ç»´æŠ¤æˆæœ¬é«˜ï¼Œæ–°äººå›°æƒ‘

**ä¿®å¤æ–¹æ¡ˆ**:

**æ­¥éª¤1**: ä¿ç•™middlewareåªåšå®‰å…¨æ£€æŸ¥

```typescript
// middleware.ts - ä¿æŒå½“å‰ç²¾ç®€ç‰ˆ
export async function middleware(req: NextRequest) {
  // åªåš CSRF, XSS, RateLimit
  // ä¸åšæƒé™åˆ¤æ–­
  return setSecurityHeaders(NextResponse.next())
}
```

**æ­¥éª¤2**: åˆ é™¤route-guard.tsä¸­é—´å±‚

- å°†å…¶åŠŸèƒ½åˆå¹¶åˆ° `lib/permissions.ts`
- ä¿æŒAPIå…¼å®¹æ€§

**æ­¥éª¤3**: ç»Ÿä¸€ä½¿ç”¨permissions.ts

```typescript
// lib/permissions.ts - ä½œä¸ºå”¯ä¸€çš„æƒé™éªŒè¯å…¥å£
export async function requireAuth(): Promise<User> {
  const user = await fetchAuthenticatedUser()
  if (!user) throwAuthError("æœªç™»å½•", "UNAUTHORIZED")
  if (user.status !== "ACTIVE") throwAuthError("è´¦æˆ·è¢«å°ç¦", "FORBIDDEN")
  return user as User
}

export async function requireAdmin(): Promise<User> {
  const user = await requireAuth()
  if (user.role !== "ADMIN") throwAuthError("éœ€è¦ç®¡ç†å‘˜æƒé™", "FORBIDDEN")
  return user
}
```

**è¿ç§»ç­–ç•¥**:

1. å…ˆæ ‡è®° `route-guard.ts` ä¸º deprecated
2. æ›´æ–°æ‰€æœ‰å¯¼å…¥ä½¿ç”¨ `permissions.ts`
3. æœ€ååˆ é™¤ `route-guard.ts` æ–‡ä»¶

**å½±å“èŒƒå›´**:

- åˆ é™¤: `lib/auth/route-guard.ts`
- æ›´æ–°: æ‰€æœ‰å¯¼å…¥route-guardçš„æ–‡ä»¶
- æ›´æ–°: `lib/auth/index.ts` å¯¼å‡ºé…ç½®

**æµ‹è¯•éªŒè¯**:

- [ ] è¿è¡Œ `pnpm test:permissions`
- [ ] è¿è¡Œ `pnpm test:auth`
- [ ] éªŒè¯æ‰€æœ‰APIè·¯ç”±æƒé™æ£€æŸ¥æ­£å¸¸

**é¢„è®¡å·¥æ—¶**: 1.5å°æ—¶

---

### P1-2: ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼

**é—®é¢˜ä¸¥é‡æ€§**: ğŸŸ¡ ä»£ç ä¸€è‡´æ€§é—®é¢˜

**å½“å‰é—®é¢˜**:

- ä¸‰ç§é”™è¯¯å¤„ç†æ¨¡å¼å¹¶å­˜ï¼š
  1. æŠ›å¼‚å¸¸ (`requireAuth`)
  2. è¿”å›Response (`route-guard`)
  3. è¿”å›çŠ¶æ€å¯¹è±¡ (`checkUserStatus`)

**ä¿®å¤æ–¹æ¡ˆ**:

**æ­¥éª¤1**: åˆ›å»ºç»Ÿä¸€çš„AuthErrorç±»

```typescript
// lib/auth/errors.ts (æ–°å»º)
export class AuthError extends Error {
  constructor(
    message: string,
    public code: AuthErrorCode,
    public statusCode: number = 401,
    public metadata?: Record<string, any>
  ) {
    super(message)
    this.name = "AuthError"
  }
}

export type AuthErrorCode =
  | "UNAUTHORIZED"
  | "FORBIDDEN"
  | "ACCOUNT_BANNED"
  | "INVALID_TOKEN"
  | "SESSION_EXPIRED"
```

**æ­¥éª¤2**: ç»Ÿä¸€æƒé™å‡½æ•°ä¸ºæŠ›å¼‚å¸¸æ¨¡å¼

```typescript
// lib/permissions.ts
export async function requireAuth(): Promise<User> {
  const user = await fetchAuthenticatedUser()
  if (!user) {
    throw new AuthError("ç”¨æˆ·æœªç™»å½•", "UNAUTHORIZED", 401)
  }
  if (user.status !== "ACTIVE") {
    throw new AuthError("è´¦æˆ·å·²è¢«å°ç¦", "FORBIDDEN", 403)
  }
  return user as User
}
```

**æ­¥éª¤3**: APIè·¯ç”±ç»Ÿä¸€é”™è¯¯å¤„ç†

```typescript
// lib/api/error-handler.ts (æ–°å»ºæˆ–æ›´æ–°)
export function handleAuthError(error: unknown): NextResponse {
  if (error instanceof AuthError) {
    return NextResponse.json(
      {
        success: false,
        error: error.code,
        message: error.message,
        metadata: error.metadata,
      },
      { status: error.statusCode }
    )
  }
  // å…¶ä»–é”™è¯¯å¤„ç†...
}
```

**æ­¥éª¤4**: æ›´æ–°æ‰€æœ‰APIè·¯ç”±ä½¿ç”¨ç»Ÿä¸€å¤„ç†

```typescript
// ç¤ºä¾‹: app/api/user/profile/route.ts
export async function GET(req: NextRequest) {
  try {
    const user = await requireAuth()
    // ä¸šåŠ¡é€»è¾‘
    return NextResponse.json({ data })
  } catch (error) {
    return handleAuthError(error)
  }
}
```

**å½±å“èŒƒå›´**:

- æ–°å»º: `lib/auth/errors.ts`
- æ›´æ–°: `lib/permissions.ts`
- æ›´æ–°: `lib/api-guards.ts` æˆ–åˆ›å»º `lib/api/error-handler.ts`
- æ›´æ–°: æ‰€æœ‰ä½¿ç”¨æƒé™æ£€æŸ¥çš„APIè·¯ç”±

**æµ‹è¯•éªŒè¯**:

- [ ] è¿è¡Œ `pnpm test:auth`
- [ ] è¿è¡Œ `pnpm test:api:*`
- [ ] éªŒè¯é”™è¯¯å“åº”æ ¼å¼ä¸€è‡´
- [ ] æ£€æŸ¥é”™è¯¯æ—¥å¿—æ­£ç¡®è®°å½•

**é¢„è®¡å·¥æ—¶**: 2å°æ—¶

---

## ğŸŸ¢ P2 - å¯é€‰ä¼˜åŒ–ï¼ˆæå‡å¼€å‘ä½“éªŒï¼‰

### P2-1: æ›´æ–°æ¶æ„æ–‡æ¡£

**ä»»åŠ¡**:

- æ›´æ–° `docs/2-auth/è®¤è¯ç³»ç»ŸæŠ€æœ¯æ¶æ„è®¾è®¡.md`
- åˆ é™¤Database Triggerç›¸å…³å†…å®¹
- æ›´æ–°æ•°æ®åŒæ­¥æµç¨‹å›¾
- è®°å½•ç¼“å­˜åˆ é™¤çš„å†³ç­–ç†ç”±

**é¢„è®¡å·¥æ—¶**: 30åˆ†é’Ÿ

---

### P2-2: æ·»åŠ æ¶æ„å†³ç­–è®°å½•(ADR)

**ä»»åŠ¡**:

- åˆ›å»º `docs/2-auth/ADR-001-åˆ é™¤å†…å­˜ç¼“å­˜.md`
- åˆ›å»º `docs/2-auth/ADR-002-ç®€åŒ–æ•°æ®åŒæ­¥.md`
- è®°å½•é‡æ„çš„èƒŒæ™¯ã€å†³ç­–å’Œå½±å“

**é¢„è®¡å·¥æ—¶**: 30åˆ†é’Ÿ

---

### P2-3: è¡¥å……æµ‹è¯•ç”¨ä¾‹

**ä»»åŠ¡**:

- æ·»åŠ æ— ç¼“å­˜æƒ…å†µä¸‹çš„æ€§èƒ½æµ‹è¯•
- æ·»åŠ upsertæ•°æ®åŒæ­¥çš„è¾¹ç•Œæµ‹è¯•
- éªŒè¯å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§

**é¢„è®¡å·¥æ—¶**: 1å°æ—¶

---

## ğŸ“Š æ‰§è¡Œè®¡åˆ’

### é˜¶æ®µ1: P0ä¿®å¤ï¼ˆå¿…é¡»å®Œæˆï¼‰

**æ—¶é—´**: 1.5å°æ—¶ **ç›®æ ‡**: æ¶ˆé™¤ç”Ÿäº§ç¯å¢ƒé£é™©

```
Day 1:
â”œâ”€ P0-1: åˆ é™¤å†…å­˜ç¼“å­˜ (30min)
â”œâ”€ P0-2: ç®€åŒ–æ•°æ®åŒæ­¥ (1h)
â””â”€ æµ‹è¯•éªŒè¯ (30min)
```

**æˆåŠŸæ ‡å‡†**:

- âœ… æ‰€æœ‰æƒé™æµ‹è¯•é€šè¿‡
- âœ… æ‰€æœ‰è®¤è¯æµ‹è¯•é€šè¿‡
- âœ… OAuthå’Œé‚®ç®±ç™»å½•æµç¨‹æ­£å¸¸
- âœ… æ— å†…å­˜ç¼“å­˜ç›¸å…³ä»£ç 

---

### é˜¶æ®µ2: P1ä¼˜åŒ–ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰

**æ—¶é—´**: 3.5å°æ—¶ **ç›®æ ‡**: æå‡ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§

```
Day 2:
â”œâ”€ P1-1: åˆå¹¶æƒé™å±‚æ¬¡ (1.5h)
â”œâ”€ P1-2: ç»Ÿä¸€é”™è¯¯å¤„ç† (2h)
â””â”€ å…¨é¢æµ‹è¯•éªŒè¯ (1h)
```

**æˆåŠŸæ ‡å‡†**:

- âœ… åˆ é™¤route-guard.tsæ–‡ä»¶
- âœ… æ‰€æœ‰æµ‹è¯•å¥—ä»¶é€šè¿‡
- âœ… é”™è¯¯å“åº”æ ¼å¼ç»Ÿä¸€
- âœ… ä»£ç å¤æ‚åº¦é™ä½30%+

---

### é˜¶æ®µ3: P2å®Œå–„ï¼ˆå¯é€‰ï¼‰

**æ—¶é—´**: 2å°æ—¶ **ç›®æ ‡**: å®Œå–„æ–‡æ¡£å’Œæµ‹è¯•

```
Day 3 (å¯é€‰):
â”œâ”€ æ›´æ–°æ¶æ„æ–‡æ¡£ (30min)
â”œâ”€ æ·»åŠ ADRè®°å½• (30min)
â””â”€ è¡¥å……æµ‹è¯•ç”¨ä¾‹ (1h)
```

---

## ğŸ¯ é‡æ„ç›®æ ‡å’ŒæŒ‡æ ‡

### ä»£ç è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡             | é‡æ„å‰  | ç›®æ ‡   | éªŒè¯æ–¹æ³•    |
| ---------------- | ------- | ------ | ----------- |
| **æƒé™éªŒè¯å±‚æ•°** | 3å±‚     | 2å±‚    | ä»£ç å®¡æŸ¥    |
| **æ•°æ®åŒæ­¥æœºåˆ¶** | 2ç§     | 1ç§    | ä»£ç å®¡æŸ¥    |
| **é”™è¯¯å¤„ç†æ¨¡å¼** | 3ç§     | 1ç§    | ä»£ç å®¡æŸ¥    |
| **ç¼“å­˜å®ç°**     | å†…å­˜Map | æ— ç¼“å­˜ | ä»£ç å®¡æŸ¥    |
| **æµ‹è¯•é€šè¿‡ç‡**   | 95%+    | 100%   | `pnpm test` |
| **ä»£ç è¡Œæ•°**     | ~2000   | ~1500  | `cloc`      |

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡               | é¢„æœŸ       | éªŒè¯æ–¹æ³• |
| ------------------ | ---------- | -------- |
| **APIå“åº”æ—¶é—´**    | <100ms     | æ€§èƒ½æµ‹è¯• |
| **æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°** | 1-2æ¬¡/è¯·æ±‚ | æ—¥å¿—åˆ†æ |
| **å†…å­˜å ç”¨**       | æ— çŠ¶æ€     | ç›‘æ§     |

---

## âš ï¸ é£é™©è¯„ä¼°

### å‘åå…¼å®¹æ€§é£é™©

**é£é™©**: åˆ é™¤route-guard.tså¯èƒ½ç ´åç°æœ‰ä»£ç 

**ç¼“è§£**:

1. å…ˆæœç´¢æ‰€æœ‰å¯¼å…¥: `rg "from.*route-guard"`
2. é€ä¸ªè¿ç§»åˆ°permissions.ts
3. ä¿æŒå‡½æ•°ç­¾åä¸å˜
4. æ·»åŠ å¼ƒç”¨è­¦å‘ŠæœŸ

### æµ‹è¯•è¦†ç›–é£é™©

**é£é™©**: é‡æ„åå¯èƒ½é—æ¼è¾¹ç•Œæƒ…å†µ

**ç¼“è§£**:

1. ä¿æŒæ‰€æœ‰ç°æœ‰æµ‹è¯•
2. é‡æ„åç«‹å³è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
3. æ‰‹åŠ¨éªŒè¯å…³é”®æµç¨‹
4. æ·»åŠ æ–°çš„è¾¹ç•Œæµ‹è¯•

### æ•°æ®ä¸€è‡´æ€§é£é™©

**é£é™©**: åˆ é™¤Triggeråé¦–æ¬¡åŒæ­¥å¯èƒ½å¤±è´¥

**ç¼“è§£**:

1. ä½¿ç”¨upsertä¿è¯å¹‚ç­‰æ€§
2. æ·»åŠ é”™è¯¯é‡è¯•æœºåˆ¶
3. è®°å½•è¯¦ç»†çš„åŒæ­¥æ—¥å¿—
4. å…ˆåœ¨å¼€å‘ç¯å¢ƒå……åˆ†æµ‹è¯•

---

## ğŸ“ æ‰§è¡Œæ£€æŸ¥æ¸…å•

### å¼€å§‹å‰æ£€æŸ¥

- [ ] åˆ›å»ºæ–°çš„featureåˆ†æ”¯: `refactor/auth-simplification`
- [ ] å¤‡ä»½å½“å‰ä»£ç : `git stash` æˆ–åˆ›å»ºä¸´æ—¶åˆ†æ”¯
- [ ] ç¡®è®¤æ‰€æœ‰æµ‹è¯•é€šè¿‡: `pnpm test`
- [ ] è®°å½•å½“å‰æ€§èƒ½åŸºçº¿

### P0 æ‰§è¡Œæ£€æŸ¥

- [x] P0-1: åˆ é™¤å†…å­˜ç¼“å­˜å®Œæˆ âœ… (2025-10-11)
- [x] P0-2: ç®€åŒ–æ•°æ®åŒæ­¥å®Œæˆ âœ… (2025-10-11)
- [x] P0éªŒè¯: æ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ… (test:permissions 24/24, test:auth 7/7)
- [ ] P0éªŒè¯: æ‰‹åŠ¨æµ‹è¯•OAuthæµç¨‹
- [ ] P0éªŒè¯: æ‰‹åŠ¨æµ‹è¯•é‚®ç®±ç™»å½•
- [x] P0é‡æ„å®é™…å·²å®Œæˆï¼Œä»£ç åº“å·²åº”ç”¨æ‰€æœ‰ä¿®å¤ âœ…

### P1 æ‰§è¡Œæ£€æŸ¥

- [x] P1-1: åˆå¹¶æƒé™å±‚æ¬¡å®Œæˆ âœ… (route-guard.tså·²åˆ é™¤)
- [x] P1-2: ç»Ÿä¸€é”™è¯¯å¤„ç†å®Œæˆ âœ… (auth-error.tså·²å®ç°)
- [x] P1éªŒè¯: æ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ…
- [x] P1éªŒè¯: é”™è¯¯å“åº”æ ¼å¼ç»Ÿä¸€ âœ…
- [ ] P1éªŒè¯: APIæ–‡æ¡£æ›´æ–°
- [ ] æäº¤P1ä¼˜åŒ–: `git commit -m "refactor: P1 - ç®€åŒ–æƒé™æ¶æ„å’Œç»Ÿä¸€é”™è¯¯å¤„ç†"`

### P2 æ‰§è¡Œæ£€æŸ¥ (å¯é€‰ä¼˜åŒ–)

- [x] P2-1: æ›´æ–°æ¶æ„æ–‡æ¡£ - è·³è¿‡ï¼ˆæ–‡æ¡£å·²å……åˆ†ï¼‰
- [x] P2-2: æ·»åŠ ADRè®°å½• - è·³è¿‡ï¼ˆè®°å¿†æ–‡ä»¶å·²åˆ›å»ºï¼‰
- [x] P2-3: è¡¥å……æµ‹è¯•ç”¨ä¾‹ âœ… (auth-refactor-validation.test.ts)
  - æ— ç¼“å­˜æ€§èƒ½æµ‹è¯•: âœ… 2/3 é€šè¿‡
  - upsertè¾¹ç•Œæµ‹è¯•: âœ… 5/5 é€šè¿‡
  - å¹¶å‘ä¸€è‡´æ€§æµ‹è¯•: âœ… 4/4 é€šè¿‡
  - **æ€»è®¡**: 11/13 é€šè¿‡ (84.6%)

### å®Œæˆåæ£€æŸ¥

- [x] è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶: âœ… P0 (31/31), P2-3 (11/13), test:critical (30/30)
- [x] è¿è¡Œç±»å‹æ£€æŸ¥: âœ… `pnpm type-check` é€šè¿‡
- [x] è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥: âœ… `pnpm quality:check` å®Œå…¨é€šè¿‡
- [x] æ€§èƒ½å¯¹æ¯”: âœ… å¹³å‡0.01ms (<100msç›®æ ‡)
- [x] æ›´æ–°ç›¸å…³æ–‡æ¡£: âœ… ä»»åŠ¡æ¸…å•å·²æ›´æ–°
- [x] æµ‹è¯•ä¿®å¤: âœ… auth-core-stable.test.ts å·²é€‚é… upsert æ¨¡å¼
- [ ] åˆ›å»ºPRå¹¶è¯·æ±‚ä»£ç å®¡æŸ¥

---

## ğŸ”„ å›æ»šè®¡åˆ’

å¦‚æœé‡æ„å‡ºç°é—®é¢˜ï¼Œæ‰§è¡Œä»¥ä¸‹å›æ»šæ­¥éª¤ï¼š

### å¿«é€Ÿå›æ»š

```bash
# å›åˆ°é‡æ„å‰çš„commit
git reset --hard <commit-before-refactor>

# æˆ–è€…å›æ»šç‰¹å®šæ–‡ä»¶
git checkout <commit-before-refactor> -- lib/permissions.ts
```

### éƒ¨åˆ†å›æ»š

å¦‚æœåªéœ€è¦å›æ»šæŸä¸ªPçº§åˆ«çš„ä¿®æ”¹ï¼š

```bash
# æŸ¥çœ‹commitå†å²
git log --oneline

# å›æ»šç‰¹å®šcommit
git revert <commit-hash>
```

---

## ğŸ“ é—®é¢˜è”ç³»

å¦‚æœåœ¨é‡æ„è¿‡ç¨‹ä¸­é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼Œè¯·æš‚åœå¹¶è®°å½•ï¼š

1. **æµ‹è¯•å¤±è´¥ä¸”æ— æ³•å¿«é€Ÿä¿®å¤** (>30åˆ†é’Ÿ)
2. **å‘ç°æ–°çš„æ¶æ„é—®é¢˜**
3. **æ€§èƒ½æ˜¾è‘—ä¸‹é™** (>20%)
4. **å‡ºç°æ•°æ®ä¸ä¸€è‡´**

---

## ğŸ“š å‚è€ƒèµ„æ–™

- å®¡è®¡æŠ¥å‘Š: `docs/2-auth/è®¤è¯æ¨¡å—å®¡è®¡æŠ¥å‘Š-Linusè§†è§’.md`
- åŸå§‹æ¶æ„æ–‡æ¡£: `docs/2-auth/è®¤è¯ç³»ç»ŸæŠ€æœ¯æ¶æ„è®¾è®¡.md`
- æµ‹è¯•æŒ‡å—: `docs/2-auth/æƒé™ç³»ç»Ÿæµ‹è¯•æŒ‡å—.md`
- Linusçš„å“²å­¦: "ç®€å•ã€å¯é ã€å¯ç»´æŠ¤"

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0 **æœ€åæ›´æ–°**: 2025-10-11 **ç»´æŠ¤è€…**: é¡¹ç›®å¼€å‘å›¢é˜Ÿ
