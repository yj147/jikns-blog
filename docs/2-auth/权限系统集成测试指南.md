# æƒé™ç³»ç»Ÿé›†æˆæµ‹è¯•æŒ‡å—

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•è¿è¡Œå’Œç»´æŠ¤åšå®¢é¡¹ç›®çš„æƒé™ç³»ç»Ÿé›†æˆæµ‹è¯•å¥—ä»¶ï¼Œç¡®ä¿ç³»ç»Ÿè¾¾åˆ° 85% ä»¥ä¸Šçš„æµ‹è¯•è¦†ç›–ç‡å’Œé«˜è´¨é‡æ ‡å‡†ã€‚

## ğŸ“‹ æµ‹è¯•è¦†ç›–èŒƒå›´

### æ ¸å¿ƒæµ‹è¯•æ¨¡å—

- **è®¤è¯ç³»ç»Ÿ**: ç”¨æˆ·ç™»å½•ã€æ³¨å†Œã€ä¼šè¯ç®¡ç†
- **æƒé™æ§åˆ¶**: è§’è‰²éªŒè¯ã€èµ„æºè®¿é—®æ§åˆ¶
- **ä¸­é—´ä»¶**: è·¯å¾„çº§æƒé™æ£€æŸ¥ã€é‡å®šå‘é€»è¾‘
- **API ç«¯ç‚¹**: æƒé™ä¿æŠ¤çš„ API è·¯ç”±éªŒè¯
- **å‰ç«¯ç»„ä»¶**: ProtectedRouteã€AdminOnly ç­‰æƒé™ç»„ä»¶
- **å®‰å…¨é˜²æŠ¤**: XSSã€CSRFã€SQLæ³¨å…¥ç­‰å®‰å…¨æµ‹è¯•

### æµ‹è¯•ç±»å‹

- **å•å…ƒæµ‹è¯•**: ç‹¬ç«‹å‡½æ•°å’Œç»„ä»¶æµ‹è¯•
- **é›†æˆæµ‹è¯•**: æ¨¡å—é—´åä½œæµ‹è¯•
- **ç«¯åˆ°ç«¯æµ‹è¯•**: å®Œæ•´ç”¨æˆ·æµç¨‹æµ‹è¯•
- **æ€§èƒ½æµ‹è¯•**: æƒé™æ£€æŸ¥æ€§èƒ½åŸºå‡†æµ‹è¯•
- **å®‰å…¨æµ‹è¯•**: æ”»å‡»é˜²æŠ¤å’Œè¾¹ç•Œæµ‹è¯•

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…ä¾èµ–
pnpm install

# å¯åŠ¨æœ¬åœ° Supabase æœåŠ¡
pnpm run supabase:start

# æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ
pnpm run type-check
```

### 2. è¿è¡Œæµ‹è¯•å¥—ä»¶

```bash
# è¿è¡Œå®Œæ•´çš„æƒé™ç³»ç»Ÿæµ‹è¯•å¥—ä»¶
pnpm run test:permissions:full

# ä»…è¿è¡Œé›†æˆæµ‹è¯•
pnpm run test:permissions:integration

# è¿è¡Œæ€§èƒ½æµ‹è¯•
pnpm run test:permissions:performance

# è¿è¡Œå®‰å…¨æµ‹è¯•
pnpm run test:permissions:security

# è¿è¡Œå‰ç«¯ç»„ä»¶æµ‹è¯•
pnpm run test:permissions:components
```

### 3. ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
# ç”Ÿæˆè¯¦ç»†çš„è¦†ç›–ç‡æŠ¥å‘Š
pnpm run test:coverage:permissions

# ç”Ÿæˆ HTML æ ¼å¼æŠ¥å‘Šå¹¶è‡ªåŠ¨æ‰“å¼€
pnpm run test:coverage:report
```

## ğŸ“Š æµ‹è¯•å‘½ä»¤è¯¦è§£

### åŸºç¡€æµ‹è¯•å‘½ä»¤

```bash
# ç›‘å¬æ¨¡å¼è¿è¡Œæƒé™æµ‹è¯•
pnpm run test:permissions:watch

# è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆéœ€è¦ Playwrightï¼‰
pnpm run test:permissions:e2e

# CI æ¨¡å¼è¿è¡Œæµ‹è¯•
pnpm run test:ci
```

### è¦†ç›–ç‡å’Œè´¨é‡æ£€æŸ¥

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pnpm run test:coverage:permissions

# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶å¹¶ç”Ÿæˆè´¨é‡æŠ¥å‘Š
pnpm run test:permissions:full
```

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ integration/                    # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ permissions.test.ts         # æƒé™ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ middleware.test.ts          # ä¸­é—´ä»¶æƒé™æ§åˆ¶æµ‹è¯•
â”‚   â”œâ”€â”€ api-permissions.test.ts     # API æƒé™æ§åˆ¶æµ‹è¯•
â”‚   â”œâ”€â”€ component-permissions.test.tsx  # å‰ç«¯æƒé™ç»„ä»¶æµ‹è¯•
â”‚   â”œâ”€â”€ security-edge-cases.test.ts # å®‰å…¨è¾¹ç¼˜æ¡ˆä¾‹æµ‹è¯•
â”‚   â””â”€â”€ middleware-performance.test.ts  # ä¸­é—´ä»¶æ€§èƒ½æµ‹è¯•
â”œâ”€â”€ e2e/                           # ç«¯åˆ°ç«¯æµ‹è¯•
â”‚   â””â”€â”€ permissions-e2e.spec.ts   # æƒé™ç³»ç»Ÿç«¯åˆ°ç«¯æµ‹è¯•
â”œâ”€â”€ helpers/                       # æµ‹è¯•è¾…åŠ©å·¥å…·
â”‚   â”œâ”€â”€ test-data.ts              # æ ‡å‡†æµ‹è¯•æ•°æ®
â”‚   â””â”€â”€ coverage-reporter.ts       # è¦†ç›–ç‡æŠ¥å‘Šå·¥å…·
â”œâ”€â”€ __mocks__/                     # Mock æ–‡ä»¶
â”‚   â”œâ”€â”€ supabase.ts               # Supabase å®¢æˆ·ç«¯ Mock
â”‚   â””â”€â”€ prisma.ts                 # Prisma å®¢æˆ·ç«¯ Mock
â””â”€â”€ setup.ts                      # æµ‹è¯•ç¯å¢ƒé…ç½®
```

## ğŸ¯ æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

### è´¨é‡æ ‡å‡†

- **æ€»ä½“è¦†ç›–ç‡**: â‰¥ 85%
- **å…³é”®è·¯å¾„è¦†ç›–**: 100%
- **å®‰å…¨æµ‹è¯•é€šè¿‡**: â‰¥ 5/6 é¡¹
- **æ€§èƒ½åŸºå‡†**: å•æ¬¡æƒé™æ£€æŸ¥ < 10ms
- **ç¼ºé™·é£é™©**: MEDIUM æˆ–ä»¥ä¸‹

### æ¨¡å—è¦†ç›–ç‡è¦æ±‚

- **lib/auth.ts**: â‰¥ 90%
- **lib/permissions.ts**: â‰¥ 95%
- **middleware.ts**: â‰¥ 85%
- **lib/security.ts**: â‰¥ 80%
- **æƒé™ç»„ä»¶**: â‰¥ 85%

## ğŸ›¡ï¸ å®‰å…¨æµ‹è¯•æ£€æŸ¥é¡¹

### å¿…é¡»é€šè¿‡çš„å®‰å…¨æµ‹è¯•

1. **XSS é˜²æŠ¤**: è¾“å…¥æ¸…ç†å’Œå†…å®¹å®‰å…¨ç­–ç•¥
2. **CSRF é˜²æŠ¤**: ä»¤ç‰ŒéªŒè¯å’Œæ¥æºæ£€æŸ¥
3. **SQL æ³¨å…¥é˜²æŠ¤**: å‚æ•°åŒ–æŸ¥è¯¢å’Œè¾“å…¥éªŒè¯
4. **ä¼šè¯å®‰å…¨**: ä¼šè¯åŠ«æŒé˜²æŠ¤å’ŒæŒ‡çº¹éªŒè¯
5. **é€Ÿç‡é™åˆ¶**: é˜²æ­¢æš´åŠ›ç ´è§£å’Œ DDoS æ”»å‡»
6. **è¾“å…¥éªŒè¯**: æ¶æ„è¾“å…¥æ£€æµ‹å’Œæ¸…ç†

### è¾¹ç¼˜æ¡ˆä¾‹æµ‹è¯•

- æƒé™æå‡æ”»å‡»é˜²æŠ¤
- ä¼šè¯åŠ«æŒæ£€æµ‹
- JWT ä»¤ç‰Œä¼ªé€ é˜²æŠ¤
- å¹¶å‘æƒé™æ£€æŸ¥ç«æ€æ¡ä»¶
- ç¼“å­˜æŠ•æ¯’æ”»å‡»é˜²æŠ¤

## ğŸ“ˆ æ€§èƒ½åŸºå‡†æµ‹è¯•

### æ€§èƒ½æŒ‡æ ‡è¦æ±‚

- **å•æ¬¡æƒé™æ£€æŸ¥**: < 10ms
- **æ‰¹é‡æƒé™æ£€æŸ¥**: æ¯”å•ä¸ªæ£€æŸ¥å¿« â‰¥ 20%
- **å¹¶å‘æƒé™éªŒè¯**: 50ä¸ªå¹¶å‘ < 500ms
- **æƒé™ç¼“å­˜å‘½ä¸­**: ç¬¬äºŒæ¬¡è®¿é—®å¿« â‰¥ 50%
- **ä¸­é—´ä»¶å¤„ç†**: < 50ms

### æ€§èƒ½ä¼˜åŒ–éªŒè¯

- æƒé™ç¼“å­˜æœºåˆ¶æœ‰æ•ˆæ€§
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- æ‰¹é‡æ“ä½œæ€§èƒ½æå‡
- å†…å­˜ä½¿ç”¨å’Œæ¸…ç†

## ğŸ”§ æµ‹è¯•ç¯å¢ƒé…ç½®

### ç¯å¢ƒå˜é‡è®¾ç½®

```bash
# æµ‹è¯•ç¯å¢ƒå˜é‡ï¼ˆ.env.testï¼‰
NODE_ENV=test
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=test-anon-key
NEXT_PUBLIC_SITE_URL=http://localhost:3000

# å¯é€‰é…ç½®
RUN_E2E=true                    # æ˜¯å¦è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
TEST_TIMEOUT=30000              # æµ‹è¯•è¶…æ—¶æ—¶é—´
COVERAGE_THRESHOLD=85           # è¦†ç›–ç‡é˜ˆå€¼
```

### Vitest é…ç½®

```typescript
// vitest.config.ts å…³é”®é…ç½®
export default defineConfig({
  test: {
    environment: "jsdom",
    setupFiles: "./tests/setup.ts",
    testTimeout: 30000,
    coverage: {
      provider: "v8",
      thresholds: {
        global: {
          statements: 80,
          branches: 75,
          functions: 80,
          lines: 80,
        },
      },
    },
  },
})
```

## ğŸ“‹ å¸¸è§é—®é¢˜è§£å†³

### æµ‹è¯•å¤±è´¥æ’æŸ¥

1. **æ•°æ®åº“è¿æ¥é—®é¢˜**

   ```bash
   # æ£€æŸ¥ Supabase æœåŠ¡çŠ¶æ€
   pnpm run supabase:start
   docker ps | grep supabase
   ```

2. **Mock é…ç½®é—®é¢˜**

   ```bash
   # æ¸…ç† Mock çŠ¶æ€
   rm -rf node_modules/.vitest
   pnpm run test:permissions:integration
   ```

3. **ä¾èµ–ç‰ˆæœ¬å†²çª**
   ```bash
   # é‡æ–°å®‰è£…ä¾èµ–
   rm -rf node_modules pnpm-lock.yaml
   pnpm install
   ```

### æ€§èƒ½æµ‹è¯•è°ƒä¼˜

1. **æƒé™ç¼“å­˜é…ç½®**
   - æ£€æŸ¥ç¼“å­˜è¿‡æœŸæ—¶é—´è®¾ç½®
   - éªŒè¯ç¼“å­˜é”®çš„å”¯ä¸€æ€§
   - ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

2. **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**
   - ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
   - å‡å°‘ä¸å¿…è¦çš„å­—æ®µæŸ¥è¯¢
   - æ‰¹é‡æ“ä½œæ›¿ä»£å•ä¸ªæŸ¥è¯¢

## ğŸš¦ CI/CD é›†æˆ

### GitHub Actions é…ç½®

```yaml
name: æƒé™ç³»ç»Ÿæµ‹è¯•
on: [push, pull_request]

jobs:
  permissions-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "18"
      - run: pnpm install
      - run: pnpm run supabase:start
      - run: pnpm run test:permissions:full
      - run: pnpm run test:coverage:permissions
```

### è´¨é‡é—¨æ§

æµ‹è¯•å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰èƒ½é€šè¿‡ï¼š

- æ‰€æœ‰æ ¸å¿ƒæµ‹è¯•é€šè¿‡
- è¦†ç›–ç‡è¾¾åˆ° 85% ä»¥ä¸Š
- å®‰å…¨æµ‹è¯•é€šè¿‡ â‰¥ 5 é¡¹
- æ€§èƒ½æµ‹è¯•ç¬¦åˆåŸºå‡†è¦æ±‚
- ç¼ºé™·é£é™©è¯„çº§ä¸º MEDIUM æˆ–ä»¥ä¸‹

## ğŸ“ æµ‹è¯•æŠ¥å‘Š

### HTML æŠ¥å‘Š

è¿è¡Œæµ‹è¯•åï¼Œä¼šåœ¨ `coverage/` ç›®å½•ç”Ÿæˆä»¥ä¸‹æŠ¥å‘Šï¼š

- `permissions-test-report.html`: è¯¦ç»†çš„å¯è§†åŒ–æŠ¥å‘Š
- `permissions-test-report.json`: æœºå™¨å¯è¯»çš„JSONæŠ¥å‘Š

### æŠ¥å‘Šå†…å®¹

1. **æµ‹è¯•æ‘˜è¦**: é€šè¿‡ç‡ã€æ‰§è¡Œæ—¶é—´ã€æ€»ä½“çŠ¶å†µ
2. **æ¨¡å—è¦†ç›–ç‡**: å„ä¸ªæ¨¡å—çš„è¯¦ç»†è¦†ç›–æƒ…å†µ
3. **å®‰å…¨æµ‹è¯•ç»“æœ**: å„é¡¹å®‰å…¨æ£€æŸ¥çš„é€šè¿‡çŠ¶æ€
4. **æ€§èƒ½æŒ‡æ ‡**: å“åº”æ—¶é—´ã€ååé‡ç­‰æ€§èƒ½æ•°æ®
5. **è´¨é‡æŒ‡æ ‡**: ä»£ç å¤æ‚åº¦ã€å¯ç»´æŠ¤æ€§ã€æŠ€æœ¯å€ºåŠ¡
6. **å…³é”®è·¯å¾„è¦†ç›–**: é‡è¦ä¸šåŠ¡æµç¨‹çš„æµ‹è¯•è¦†ç›–

## ğŸ”„ æŒç»­æ”¹è¿›

### æµ‹è¯•ç»´æŠ¤

- å®šæœŸæ›´æ–°æµ‹è¯•ç”¨ä¾‹ä»¥åæ˜ ä¸šåŠ¡å˜åŒ–
- ç›‘æ§æµ‹è¯•æ‰§è¡Œæ—¶é—´ï¼Œä¼˜åŒ–æ…¢é€Ÿæµ‹è¯•
- æ ¹æ®ç”Ÿäº§ç¯å¢ƒåé¦ˆå¢åŠ è¾¹ç¼˜æ¡ˆä¾‹æµ‹è¯•
- ä¿æŒæµ‹è¯•æ•°æ®çš„çœŸå®æ€§å’Œå¤šæ ·æ€§

### è´¨é‡æå‡

- è®¾ç½®æ›´ä¸¥æ ¼çš„è¦†ç›–ç‡é˜ˆå€¼
- å¢åŠ å¤æ‚åœºæ™¯çš„é›†æˆæµ‹è¯•
- å¼•å…¥å˜å¼‚æµ‹è¯•éªŒè¯æµ‹è¯•è´¨é‡
- å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡å’Œæ¸—é€æµ‹è¯•

---

## ğŸ“ æ”¯æŒ

å¦‚æœåœ¨è¿è¡Œæµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. æ‰€æœ‰ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…
2. Supabase æœ¬åœ°æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
3. ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®é…ç½®
4. æµ‹è¯•æ•°æ®åº“æ˜¯å¦å¯è®¿é—®

æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒé¡¹ç›®æ ¹ç›®å½•çš„ `CLAUDE.md` æ–‡ä»¶ã€‚
