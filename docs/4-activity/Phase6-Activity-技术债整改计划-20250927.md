# Phase 6：Activity 模块技术债整改计划（2025-09-27）

## 目标

- 在 2025-10-05 前关闭审计报告中列出的 P0/P1 技术债，恢复 Activity
  Feed 的稳定分页、筛选与权限行为。
- 对 P2 优化项给出明确节奏与验收标准，为后续演进做好文档与测试准备。

## 风险分级回顾

| 等级 | 问题                                                                | 影响                            | 对应任务 |
| ---- | ------------------------------------------------------------------- | ------------------------------- | -------- |
| P0   | 游标分页返回 `createdAt`，查询却使用 `id`，导致第二页起 Prisma 抛错 | 无限滚动崩溃                    | T1       |
| P0   | 置顶/含图筛选仅前端处理，无法获取完整结果                           | 筛选误导运营与用户              | T2       |
| P1   | 分页元数据 `total` 失真，`following` 排序未实现                     | 运营指标不可信 / 功能与预期不符 | T3、T4   |
| P1   | 速率限制使用进程内内存存储                                          | 多实例部署时限流失效            | T5       |
| P2   | 搜索/筛选全在客户端执行                                             | 数据量大时性能下降              | T6       |

## 任务总览

| 编号 | 优先级 | 任务                                                   | 负责人建议                  | 截止时间   | 验收方式                                               |
| ---- | ------ | ------------------------------------------------------ | --------------------------- | ---------- | ------------------------------------------------------ |
| T1   | P0     | 统一游标协议并补充分页回归测试                         | Activity Backend            | 2025-09-29 | Vitest/契约测试覆盖第二页请求；Playwright 无限滚动验证 |
| T2   | P0     | 实现服务端筛选（`isPinned`/`hasImages`）或临时隐藏选项 | Activity Backend & Frontend | 2025-09-29 | API 返回过滤结果；UI 验证筛选生效；文档更新            |
| T3   | P1     | 提供真实分页元数据或明确语义                           | Activity Backend            | 2025-10-02 | API 返回总量或 `approximate` 字段；监控脚本取值正确    |
| T4   | P1     | 明确 `orderBy=following` 行为（实现或禁用）            | Activity Backend            | 2025-10-02 | 新增测试覆盖关注过滤；或 API 返回 400 并更新文档       |
| T5   | P1     | 将限流迁移至集中式存储并加监控                         | Platform Infra              | 2025-10-03 | Redis/Upstash 集成示例通过；限流命中率上报             |
| T6   | P2     | 规划服务端搜索与筛选逐步迁移方案                       | Activity Product & Backend  | 2025-10-10 | 输出设计 RFC，列出阶段目标与指标                       |

## 任务细化

### T1 统一游标协议

- **子任务**
  1. 调整 `lib/repos/activity-repo.ts` 使 `nextCursor` 返回最后一条记录的
     `id`，并将游标查询切换为
     `{ cursor: { id }, orderBy: [{ createdAt: "desc" }, { id: "desc" }] }`。
  2. 更新 `hooks/use-activities.ts`，确保第二页起优先使用游标；回退偏移时强制
     `page` 参数与游标互斥。
  3. 新增契约测试：模拟第一页+第二页请求，断言 200 与结果不重复。
  4. Playwright 场景（或手动脚本）验证无限滚动连续加载三页无报错。
- **风险**：旧客户端可能仍依赖 `cursor=createdAt`；需在 API 文档中同步说明。

### T2 服务端筛选支持

- **方案**：首选在 `ActivityQueryParams` 与仓储层增加 `isPinned`、`hasImages`
  字段；若本迭代无法完工，则在 UI 暂时隐藏开关并说明。
- **子任务**
  1. 扩展 `activityQuerySchema`、`listActivities`
     支持新过滤条件，并添加相应 Prisma 查询。
  2. 更新 `app/api/activities/route.ts` 将前端传参透传至仓储层。
  3. `ActivityList`
     仅在服务端支持时才启用筛选；否则在 tooltip/文档中提示“当前仅对已加载数据过滤”。
  4. 补充单元测试或 e2e 场景验证置顶/含图筛选。
- **风险**：新增 where 条件可能影响现有索引，需要观察查询计划。

### T3 可信分页元数据

- **子任务**
  1. 在仓储层增加 `totalCount` 查询或返回 `hasMore` + `nextCursor`
     组合，并更新响应结构。
  2. 更新 `createSuccessResponse` 调用处的 `pagination.total` 语义（真实总数或
     `approximateTotal`）。
  3. 同步 `monitoring-data` 汇总脚本与前端展示逻辑。
- **风险**：追加 count 查询可能带来性能开销，需考虑缓存或只在第一页计算。

### T4 `following` 排序策略

- **选项**
  - **实现**：连表 `Followers`
    或缓存当前用户关注列表，只返回其关注的作者动态；需要权限与缓存支持。
  - **禁用**：短期内返回 400 并在 UI 中隐藏下拉项，同时更新文档。
- **子任务**：根据产品决策选择路径；无论结果如何，需在契约测试中覆盖。

### T5 集中式限流

- **子任务**
  1. 引入 Redis/Upstash 客户端（或复用现有 `lib/rate-limit` 基础设施）存储计数。
  2. 增加运行环境变量配置（写入 `.env.example`）和失败降级策略。
  3. 在 `monitoring-data` 增补限流命中率/拒绝率指标。
  4. 更新安全与运维文档，标注依赖。
- **风险**：部署阶段需要 DevOps 支持；切换时注意限流键一致性。

### T6 服务端搜索/筛选迁移计划

- **交付**：撰写 RFC（`docs/4-activity/`）定义阶段性目标、性能预算、指标采集与回滚策略。
- **参考指标**：响应耗时 < 200ms（P95）、带宽降低 30%、页面交互成功率 > 99%。

## 交付检查清单

- [ ] 新增/调整的 API 均有契约或单元测试覆盖。
- [ ] 前端筛选/排序与后端能力保持一致，文案/tooltip 已同步。
- [ ] 监控脚本与指标面板更新，覆盖限流命中率、分页错误率。
- [ ] 文档：更新
      `docs/4-activity/Phase6-系统设计.md`、`docs/monitoring-validation-plan.md`，记录变更。
- [ ] 关键 PR 在合入前执行
      `pnpm quality:check`、`pnpm test --runInBand`，并附带验证步骤。

## 沟通与里程碑

- **2025-09-29**：T1、T2 完成（恢复基础可用性）。
- **2025-10-02**：T3、T4 完成（纠正指标与关注流行为）。
- **2025-10-03**：T5 完成（限流多实例生效，监控上线）。
- **2025-10-10**：T6 交付设计方案，准备后续迭代。
