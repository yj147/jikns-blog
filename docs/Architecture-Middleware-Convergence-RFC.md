# 中间件收敛 RFC

## 现状分析

### 当前职责范围（过重）

1. **安全防护**：SecurityMiddleware 全套检查（CSRF、XSS、速率限制、会话安全）
2. **权限控制**：路径级别的认证和授权检查
3. **用户缓存**：维护用户权限缓存（5分钟过期）
4. **日志记录**：请求日志、安全日志、性能监控
5. **路径匹配**：复杂的通配符路径匹配逻辑

### 当前 Matcher 范围（过宽）

```javascript
matcher: ["/((?!_next/static|_next/image|favicon.ico|.*\\.).*)"]
```

**问题**：几乎拦截所有请求，包括不需要处理的静态资源和公开页面

### 性能影响

- 每个请求都经过完整的安全检查流程
- 用户权限缓存可能导致权限更新延迟
- 复杂的路径匹配逻辑增加处理时间

## 收敛方案

### 核心原则

1. **最小职责**：中间件只做跨路由的通用处理
2. **业务下沉**：业务逻辑和权限检查下沉到具体路由
3. **性能优先**：减少不必要的处理，提升响应速度

### 新的职责范围（精简）

1. **基础安全头**：仅设置必要的安全响应头
2. **来源校验**：防止 CSRF 的基础校验
3. **请求日志**：最基本的访问日志（可选）
4. **认证传递**：仅传递认证状态，不做权限判断

### 新的 Matcher 范围（收紧）

```javascript
matcher: [
  // API 路由（需要安全头和来源校验）
  "/api/:path*",
  // 需要认证的页面路由
  "/admin/:path*",
  "/profile/:path*",
  "/settings/:path*",
  // 登录相关路由（需要特殊处理）
  "/login",
  "/logout",
  "/auth/:path*",
]
```

### 下沉到路由的职责

#### API 路由层

- **权限校验**：每个 API 自行检查用户角色和权限
- **速率限制**：根据具体 API 的需求设置不同限制
- **输入验证**：API 特定的参数和请求体验证
- **业务逻辑**：完整的业务处理逻辑

#### 页面路由层

- **权限检查**：通过 Server Components 或 getServerSideProps 检查
- **数据预取**：根据用户权限获取相应数据
- **重定向逻辑**：未授权时的页面重定向

## 实施步骤

### 第一阶段：中间件精简

1. **移除**：
   - SecurityMiddleware 的复杂检查
   - 用户权限缓存逻辑
   - 路径级别的权限判断
2. **保留**：
   - 基础安全头设置
   - CSRF Token 验证（仅 POST/PUT/DELETE）
   - 基础请求日志

### 第二阶段：路由增强

1. **创建权限检查工具**：

   ```typescript
   // lib/auth/route-guard.ts
   export async function requireAuth(request: NextRequest)
   export async function requireAdmin(request: NextRequest)
   ```

2. **API 路由模板**：
   ```typescript
   // 每个需要认证的 API 开头
   const auth = await requireAuth(request)
   if (!auth.success) return auth.response
   ```

### 第三阶段：验证和调优

1. 性能测试：对比精简前后的响应时间
2. 安全审计：确保安全性不降低
3. 监控观察：观察生产环境表现

## 风险评估

### 潜在风险

1. **安全降级**：移除集中式安全检查可能遗漏某些路由
2. **重复代码**：每个路由都需要权限检查代码
3. **维护成本**：分散的权限逻辑可能更难维护

### 缓解措施

1. **标准化工具**：提供统一的权限检查函数
2. **代码审查**：严格审查新增 API 的权限实现
3. **测试覆盖**：确保所有需要认证的路由都有测试

## 性能预期

### 改进指标

- **首屏加载**：减少 20-30ms（公开页面无需中间件处理）
- **API 响应**：减少 10-15ms（移除不必要的检查）
- **内存使用**：减少权限缓存的内存占用

### 监控指标

- 中间件处理时间
- API 路由响应时间
- 认证失败率
- 安全事件频率

## 决策记录

- **为什么收敛**：当前中间件职责过重，影响性能和可维护性
- **为什么下沉**：路由级别的权限控制更灵活，更易于测试
- **为什么保留基础功能**：跨路由的通用安全需求仍需集中处理
