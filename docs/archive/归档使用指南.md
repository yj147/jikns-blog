# 归档功能使用指南

更新时间：2025-11-09

## 页面入口

- 桌面端：导航栏 `归档` 菜单，或直接访问 `/archive`
- 移动端：侧边菜单 → `归档`
- 年份 / 月份详情路径分别为 `/archive/:year` 与 `/archive/:year/:month`

## 时间线懒加载

1. 初始展示最近 3 年文章（从第 0 年开始）。
2. 滚动到页面底部或点击「加载更多年份」按钮时，请求 `/api/archive/chunk`
   获取后续年份。
3. 拉取过程中会显示骨架占位，重复年份会自动去重。

## 快速导航

- 顶部导航列出所有年份。
- 归档首页：点击按钮会平滑滚动到对应年份，并预取年份页路由。
- 年份详情页：当前年份按钮不可点击，其它年份按钮为链接，将通过 Next.js 路由跳转。
- 返回顶部按钮仅在桌面端滚动超过 300px 时出现。

## 搜索

- 支持按关键字检索标题、摘要、正文。
- 使用 PostgreSQL GIN 索引 + `websearch_to_tsquery('simple')`，与
  `search_vector` 的 `simple` 字典保持一致，确保 nodejieba 拆分的 token 能命中。
- 输入长度需在 2~100 个字符之间，超出范围会直接提示错误。
- 可选按年份筛选，历史关键字保存在 `localStorage.archive-search-history`。
- 搜索区使用 `aria-live="polite"` 提供阅读器提示。

## 月份分组

- 点击月份行可展开文章列表，展开区域拥有 `role="region"` 和语义化 `aria-label`。
- 每月最多展示前 5 篇文章，其余通过「查看更多」链接跳转至月份详情页。
- Server Action `getArchiveData` 仅返回前 5 条记录，并使用 `count`
  字段标识剩余数量，避免 `/api/archive/chunk` 传输冗余数据。

## 统计信息

- 卡片展示文章总量、时间跨度、年均产出及发布时间范围。
- 数据来源于 `getArchiveStats()`，缓存 1 小时。

## 性能基线（2025-11-09）

### /api/archive/chunk

- **首次加载**：≈ 150ms（含数据库 + RSC 序列化）
- **缓存命中**：≈ 6ms（`unstable_cache`）
- **Payload 大小**：≈ 8KB（5 篇/月 × 12 月 × 1 年）

### 搜索接口 `/api/archive/search`

- **GIN 全文检索**：≈ 45-60ms（`ts_rank` 排序）
- **最大返回**：20 条，按相关度/发布时间排序
- **短查询**：< 2 个字符直接返回 `QUERY_TOO_SHORT`
- **长查询**：> 100 个字符直接返回 `QUERY_TOO_LONG`

### 优化里程碑

- 2025-11-09：数据库层按月裁剪为前 5 条，减少 ~60% 传输体积。
- 2025-11-09：迁移到 PostgreSQL `websearch_to_tsquery`，查询速度提升约 3 倍。

## 可访问性与键盘操作

- 所有交互按钮和链接均带有 `aria-*` 属性。
- 键盘导航顺序：年份按钮 → 月份折叠按钮 → 文章链接。
- 搜索错误信息通过 `role="alert"` 提示。

## 测试命令

```bash
# 归档模块覆盖率（lines ≥ 85%、branches ≥ 70%）
pnpm test:archive:coverage

# 全局质量门槛（CI 推荐）
pnpm test:coverage

# 组件与 Hook 快速回归
pnpm vitest run tests/components/archive/archive-*.test.tsx tests/hooks/use-intersection-observer.test.tsx \
  --coverage.enabled --coverage.include='components/archive/**' --coverage.include='hooks/use-intersection-observer.ts'

# E2E：Chromium / Firefox / 移动端
pnpm playwright test tests/e2e/archive.spec.ts --project=chromium
pnpm playwright test tests/e2e/archive.spec.ts --project=firefox
pnpm playwright test tests/e2e/archive.spec.ts --project=mobile-chrome

# Safari/WebKit（需系统安装 GTK4/WebKit 依赖）
pnpm playwright test tests/e2e/archive.spec.ts --project=webkit
```

最新性能基准（Chromium 本地开发环境）：

- DOMContentLoaded：≈ 1.85s
- Load Event：≈ 2.33s
- 请求数：11
- JS Heap：≈ 82.4 MB

## 常见问题

1. **懒加载未触发**：确认页面底部元素在视口内，或检查 `IntersectionObserver`
   polyfill。
2. **搜索无响应**：浏览器禁止 `localStorage`
   时历史记录会禁用，但搜索仍可用；若收到 200 + `QUERY_TOO_SHORT` 或 400 +
   `QUERY_TOO_LONG`，请调整关键字长度。
3. **WebKit 无法运行测试**：使用 `npx playwright install-deps`
   安装所需系统依赖后重试。
