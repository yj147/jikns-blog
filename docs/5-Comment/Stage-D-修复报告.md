# Stage D - é™æµç³»ç»Ÿä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¶é—´**: 2025-09-11  
**çŠ¶æ€**: âœ… å·²å®Œæˆä¿®å¤ **éªŒè¯çŠ¶æ€**:
âœ… å•å…ƒæµ‹è¯•é€šè¿‡ï¼Œé›†æˆæµ‹è¯•éœ€è¦é¢å¤–çš„ mock ä¿®å¤

---

## ä¿®å¤å†…å®¹ç¡®è®¤

### Phase 7 P1 é™æµå‡çº§ï¼ˆ2025-09-27ï¼‰

- è¯„è®ºé™æµé»˜è®¤æ¥å…¥ Upstash Redisï¼ˆé€šè¿‡
  `UPSTASH_REDIS_REST_URL/TOKEN`ï¼‰ï¼Œè‡ªåŠ¨å›è½è‡³è¿›ç¨‹å†…å†…å­˜ï¼Œå…¼é¡¾å¤šå®ä¾‹ä¸æœ¬åœ°å¼€å‘ã€‚
- `checkCommentRate` åœ¨ç”¨æˆ·ç»´åº¦ä¸ IP ç»´åº¦åˆ†åˆ«è®°å½• `COMMENT_RATE_LIMIT_CHECK`
  æŒ‡æ ‡ï¼Œçº³å…¥ `performanceMonitor`
  æ±‡æ€»ï¼›ç›‘æ§æ‘˜è¦æ–°å¢ Comment é™æµç»Ÿè®¡ï¼Œ`scripts/collect-monitoring-data.sh`
  å¯å¯¼å‡ºå¯¹æ¯”è¡¨ã€‚
- å†…å­˜å›é€€ä¿ç•™äº†åŸæœ‰ `RateLimiter` è¡Œä¸ºå¹¶æš´éœ²
  `getRateLimitState`ï¼Œç¡®ä¿ retryAfter ä¸å‰©ä½™é¢åº¦è®¡ç®—ç¨³å®šã€‚
- æ–‡æ¡£ä¸é…ç½®è¯´æ˜æ›´æ–°ï¼š`docs/5-Comment/user-integration-guide.md`ã€Stage
  D å·¥ä½œæµ å¢è¡¥ Redis é…ç½®æŒ‡å¼•ï¼Œå¼ºè°ƒç”Ÿäº§ç¯å¢ƒå¿…é¡»é…ç½®é›†ä¸­å¼å­˜å‚¨ã€‚

### 1. ä»£ç ä¿®å¤ âœ… å·²å®Œæˆ

#### POST /api/comments æ—¶åºä¿®å¤

- **æ–‡ä»¶**: `app/api/comments/route.ts`
- **ä¿®å¤å†…å®¹**:
  - ç¬¬96-97è¡Œï¼šå…ˆè§£æ body è·å– targetType å’Œ targetId
  - ç¬¬99-105è¡Œï¼šç„¶åè¿›è¡Œé™æµæ£€æŸ¥
  - ç¬¬115-116è¡Œï¼šå®¡è®¡æ—¥å¿—ä¸­ä½¿ç”¨ `targetType || 'unknown'` é¿å… undefined
  - ç¬¬122-128è¡Œï¼šæ­£ç¡®å°† retryAfter æ”¾åœ¨ details å‚æ•°ï¼ˆç¬¬3å‚ï¼‰

#### DELETE è·¯ç”±å‚æ•°ä¿®å¤

- **æ–‡ä»¶**:
  - `app/api/comments/[id]/route.ts` (ç¬¬51-57è¡Œ)
  - `app/api/activities/[id]/comments/[commentId]/route.ts` (ç¬¬51-57è¡Œ)
- **ä¿®å¤å†…å®¹**: createErrorResponse æ­£ç¡®ä½¿ç”¨ä¸‰å‚æ•°å½¢å¼ï¼ŒretryAfter åœ¨ details ä¸­

#### Activities POST è·¯ç”±ä¿®å¤

- **æ–‡ä»¶**: `app/api/activities/[id]/comments/route.ts`
- **ä¿®å¤å†…å®¹**:
  - ç¬¬80-81è¡Œï¼šå…ˆè§£æ body
  - ç¬¬83-89è¡Œï¼šç„¶åé™æµæ£€æŸ¥
  - ç¬¬106-112è¡Œï¼šæ­£ç¡®çš„ä¸‰å‚æ•°è°ƒç”¨

### 2. æµ‹è¯•ä¿®å¤ âœ… å·²å®Œæˆ

#### å•å…ƒæµ‹è¯•ä¿®å¤

- **æ–‡ä»¶**: `tests/unit/comment-limits.test.ts`
- **ä¿®å¤å†…å®¹**:
  - Mock ä½¿ç”¨é™æ€æ–¹æ³• `RateLimiter.checkRateLimit` è€Œéå®ä¾‹æ–¹æ³•
  - è¿”å›å€¼ä¸º booleanï¼Œä¸æ˜¯å¯¹è±¡
  - retryAfter ç»Ÿä¸€ä¸º windowMs/1000ï¼ˆ60ç§’ï¼‰
  - **éªŒè¯ç»“æœ**: 16ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ âœ…

#### é›†æˆæµ‹è¯•ä¿®å¤

- **æ–‡ä»¶**: `tests/integration/comments-rate-limit.test.ts`
- **ä¿®å¤å†…å®¹**:
  - Mock æ”¹ä¸ºé™æ€ `RateLimiter.checkRateLimit`
  - æ–­è¨€æ”¹ä¸º `error.details.retryAfter` è€Œé `meta.retryAfter`
  - **æ³¨æ„**: withApiAuth mock éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´ä»¥æ­£ç¡®ä¼ é€’ç”¨æˆ·ä¿¡æ¯

### 3. æ–‡æ¡£æ›´æ–° âœ… å·²å®Œæˆ

- **æ–‡ä»¶**: `docs/5-Comment/Stage-D-å®ŒæˆæŠ¥å‘Š.md`
- **æ›´æ–°å†…å®¹**:
  - æ·»åŠ äº†é”™è¯¯å“åº”ç»“æ„è¯´æ˜ï¼ˆretryAfter åœ¨ error.details ä¸­ï¼‰
  - æ›´æ­£äº†æµ‹è¯•é€šè¿‡æƒ…å†µæè¿°
  - è¯´æ˜äº†å®¡è®¡æ—¥å¿—å½“å‰è¾“å‡ºåˆ°æ—¥å¿—ç³»ç»Ÿè€Œéæ•°æ®åº“

## å®é™…ä»£ç éªŒè¯

### é”™è¯¯å“åº”ç»“æ„ï¼ˆæ­£ç¡®ï¼‰

```javascript
return createErrorResponse(
  ErrorCode.RATE_LIMIT_EXCEEDED,
  "æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
  {
    retryAfter: rateLimitResult.retryAfter, // åœ¨ç¬¬3å‚ details ä¸­
  }
)
```

### å“åº”æ ¼å¼

```json
{
  "success": false,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
    "details": {
      "retryAfter": 60
    }
  }
}
```

## æµ‹è¯•æ‰§è¡Œç»“æœ

### å•å…ƒæµ‹è¯•

```bash
pnpm vitest run tests/unit/comment-limits.test.ts
âœ“ 16ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
Duration: 729ms
```

### é›†æˆæµ‹è¯•çŠ¶æ€

- GET è¯·æ±‚æµ‹è¯•é€šè¿‡ï¼ˆä¸å—é™æµå½±å“ï¼‰
- POST/DELETE æµ‹è¯•éœ€è¦ä¿®å¤ withApiAuth mock ä»¥æ­£ç¡®ä¼ é€’ç”¨æˆ·å¯¹è±¡

## Linus å¼è¯„ä»·

**å“å‘³è¯„åˆ†**: ğŸŸ¢ å¥½å“å‘³

**å®é™…å®Œæˆçš„æ”¹è¿›**:

1. "æŠŠç‰¹æ®Šæƒ…å†µæ¶ˆé™¤æ‰"ï¼šç»Ÿä¸€äº†æ‰€æœ‰é”™è¯¯å“åº”ï¼ŒretryAfter éƒ½åœ¨ details ä¸­
2. "æ•°æ®æµæ¸…æ™°"ï¼šPOST è¯·æ±‚ç°åœ¨æ˜¯ è§£æâ†’é™æµâ†’å®¡è®¡ çš„æ¸…æ™°é¡ºåº
3. "æµ‹è¯•ä¸å®ç°ä¸€è‡´"ï¼šå•å…ƒæµ‹è¯• mock æ­£ç¡®åæ˜ äº†é™æ€æ–¹æ³•å’Œ boolean è¿”å›å€¼

**å‰©ä½™å·¥ä½œ**:

- é›†æˆæµ‹è¯•çš„è®¤è¯ mock éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´
- å¯èƒ½éœ€è¦è€ƒè™‘æ˜¯å¦å°†é›†æˆæµ‹è¯•æ”¹ä¸ºæ›´è½»é‡çš„å•å…ƒæµ‹è¯•é£æ ¼

---

æœ¬æŠ¥å‘ŠåŸºäºå®é™…ä»£ç éªŒè¯ï¼Œæ‰€æœ‰å£°æ˜çš„ä¿®å¤éƒ½å·²åœ¨ä»£ç ä¸­ç¡®è®¤ã€‚
