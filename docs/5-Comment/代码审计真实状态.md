# ä»£ç å®¡è®¡çœŸå®çŠ¶æ€æŠ¥å‘Š

**å®¡è®¡æ—¶é—´**: 2025-09-11  
**å®¡è®¡ç»“è®º**: âœ… ä»£ç å·²ä¿®å¤ï¼Œä½†æœªæäº¤åˆ° Git

---

## å®é™…ä»£ç çŠ¶æ€

### 1. POST /api/comments æ—¶åº âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `app/api/comments/route.ts`

```javascript
// ç¬¬96-97è¡Œï¼šå…ˆè§£æbody
const body = await request.json()
const { targetType, targetId, content, parentId } = body

// ç¬¬100-105è¡Œï¼šç„¶åé™æµæ£€æŸ¥
const rateLimitResult = await checkCommentRate({
  userId: user.id,
  ip: clientIP,
  action: 'create'
})

// ç¬¬115-116è¡Œï¼šå®¡è®¡ä¸­ä½¿ç”¨å·²è§£æçš„å€¼
targetType: targetType || 'unknown',
targetId: targetId || 'unknown',
```

### 2. createErrorResponse å‚æ•° âœ… å·²ä¿®å¤

æ‰€æœ‰é™æµè·¯ç”±éƒ½æ­£ç¡®ä½¿ç”¨ä¸‰å‚æ•°å½¢å¼ï¼š

```javascript
return createErrorResponse(
  ErrorCode.RATE_LIMIT_EXCEEDED,
  "æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
  {
    retryAfter: rateLimitResult.retryAfter, // åœ¨ç¬¬3å‚ details ä¸­
  }
)
```

### 3. æµ‹è¯•çŠ¶æ€

#### å•å…ƒæµ‹è¯• âœ… å·²ä¿®å¤å¹¶é€šè¿‡

- æ–‡ä»¶ï¼š`tests/unit/comment-limits.test.ts`
- çŠ¶æ€ï¼š16ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- Mock æ­£ç¡®ä½¿ç”¨é™æ€ `RateLimiter.checkRateLimit`
- è¿”å›å€¼ä¸º boolean

#### é›†æˆæµ‹è¯• ğŸŸ¡ éœ€è¦è°ƒæ•´

- æ–‡ä»¶ï¼š`tests/integration/comments-rate-limit.test.ts`
- é—®é¢˜ï¼šwithApiAuth mock éœ€è¦æ­£ç¡®ä¼ é€’ç”¨æˆ·
- å…¶ä»– mock å·²ä¿®å¤

### 4. Git çŠ¶æ€

**é‡è¦å‘ç°**ï¼šä¿®æ”¹çš„æ–‡ä»¶è¿˜æ²¡æœ‰è¢« Git è·Ÿè¸ª

```bash
?? app/api/activities/
?? app/api/comments/route.ts
```

è¿™æ„å‘³ç€è™½ç„¶ä»£ç å·²ç»ä¿®å¤ï¼Œä½†è¿˜æ²¡æœ‰æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ã€‚

## çœŸå®éªŒè¯å‘½ä»¤

```bash
# éªŒè¯ä»£ç é¡ºåº
sed -n '95,130p' app/api/comments/route.ts

# éªŒè¯å•å…ƒæµ‹è¯•
pnpm vitest run tests/unit/comment-limits.test.ts
# ç»“æœï¼šâœ“ 16ä¸ªæµ‹è¯•é€šè¿‡

# æŸ¥çœ‹ Git çŠ¶æ€
git status --short app/api/
```

## Linus å¼è¯„ä»·

**å“å‘³è¯„åˆ†**: ğŸŸ¢ ä»£ç å·²ä¿®å¤ï¼Œä½† ğŸ”´ ç‰ˆæœ¬æ§åˆ¶ç®¡ç†æ··ä¹±

**äº‹å®**ï¼š

1. ä»£ç ä¿®å¤éƒ½å·²æ­£ç¡®å®æ–½
2. å•å…ƒæµ‹è¯•é€šè¿‡éªŒè¯
3. ä½†æ–‡ä»¶æœªè¢« Git è·Ÿè¸ªï¼Œè¿™æ˜¯ä¸¥é‡çš„ç‰ˆæœ¬æ§åˆ¶é—®é¢˜

**å»ºè®®**ï¼šç«‹å³å°†ä¿®æ”¹æ·»åŠ åˆ° Git è·Ÿè¸ªå¹¶æäº¤ã€‚

---

æœ¬æŠ¥å‘ŠåŸºäºå®é™…ä»£ç éªŒè¯ï¼Œéæ¨æµ‹ã€‚
