# Phase 11 / M1: 数据库迁移和全文搜索基础设施 - 完成报告

**版本**: v1.0  
**完成日期**: 2025-10-09  
**实际工期**: 0.5 天  
**状态**: ✅ 已完成

> **重构提示（2025-11-09）**：本文档记录的是 Phase
> 11 历史实施过程。当前搜索 Server Actions 已拆分为 `lib/actions/search/`
> 目录，仓储层拆分为
> `lib/repos/search/{posts,activities,users,tags}.ts`。如需最新架构，请参阅
> [README.md](../../README.md) 与 [搜索功能设计文档.md](./搜索功能设计文档.md)。

---

## 执行摘要

M1 阶段成功完成了搜索功能的基础设施建设，为 Post 模型添加了全文搜索支持，为 User 模型添加了模糊搜索索引。所有核心验收标准均已达成，数据库迁移已成功应用到本地开发环境。

### 关键成果

- ✅ 创建并应用了数据库迁移文件
- ✅ 更新了 Prisma schema 并重新生成了 Prisma Client
- ✅ 创建了全文搜索测试脚本并验证了搜索功能
- ✅ 英文搜索功能完全正常，相关性排序正确
- ⚠️ 中文分词存在已知限制（使用 `simple` 配置）

---

## 任务完成情况

### T1.1: 创建数据库迁移文件 ✅

**文件**: `supabase/migrations/20251009100000_add_post_search_vector.sql`

**实施内容**:

1. **启用 pg_trgm 扩展**

   ```sql
   CREATE EXTENSION IF NOT EXISTS pg_trgm;
   ```

2. **为 Post 表添加 search_vector 列**
   - 使用 `GENERATED ALWAYS AS` 自动生成搜索向量
   - 字段权重设置：
     - 标题 (title): 权重 A（最高）
     - 摘要 (excerpt) 和 SEO 描述 (seoDescription): 权重 B
     - 正文 (content): 权重 C（最低）

3. **创建 GIN 索引**

   ```sql
   CREATE INDEX idx_posts_search_vector
     ON posts USING GIN (search_vector);
   ```

4. **为 User 表创建 pg_trgm 索引**
   - `idx_users_name_trgm`: 用于模糊搜索用户名
   - `idx_users_bio_trgm`: 用于模糊搜索用户简介

**验收标准达成**:

- ✅ 迁移文件创建成功
- ✅ 本地数据库执行迁移无错误
- ✅ `search_vector` 列自动生成并包含正确内容
- ✅ GIN 索引创建成功

**遇到的问题与解决**:

- **问题**: 初始迁移文件使用了错误的列名 `seo_description`（snake_case）
- **解决**: 修正为正确的 camelCase 列名 `"seoDescription"`（需要加引号）

---

### T1.2: 更新 Prisma Schema ✅

**文件**: `prisma/schema.prisma`

**实施内容**:

在 Post 模型中添加了 `searchVector` 字段：

```prisma
model Post {
  // ... 其他字段
  searchVector   Unsupported("tsvector")? @map("search_vector")
  // ... 其他字段
}
```

**执行步骤**:

1. 编辑 `prisma/schema.prisma` 文件
2. 运行 `pnpm db:generate` 重新生成 Prisma Client
3. 验证 TypeScript 类型定义正确

**验收标准达成**:

- ✅ Prisma schema 更新成功
- ✅ Prisma Client 重新生成无错误
- ✅ TypeScript 类型检查通过（新增字段没有引入新的类型错误）

---

### T1.3: 验证全文搜索功能 ✅

**文件**: `scripts/test-search.ts`

**测试场景**:

1. **测试 1: 搜索 'Next.js'** ✅
   - 找到 2 篇文章
   - 相关性排序正确（标题匹配排名更高）

2. **测试 2: 搜索 'React'** ✅
   - 找到 2 篇文章
   - 相关性排序正确

3. **测试 3: 搜索 'modern'** ✅
   - 找到 1 篇文章
   - 搜索结果准确

4. **测试 4: 搜索 '类型'** ⚠️
   - 找到 0 篇文章
   - **已知限制**: PostgreSQL 的 `simple` 配置不支持中文分词

5. **测试 5: 验证权重排序** ✅
   - 标题中的关键词排名确实高于内容中的关键词
   - 权重设置生效

**验收标准达成**:

- ✅ 全文搜索查询返回正确结果
- ✅ 相关性排序符合预期
- ⚠️ 中英文搜索部分正常工作（英文完全正常，中文需要完整词组）

**测试输出示例**:

```
测试 1: 搜索 'Next.js'
✅ 找到 2 篇文章:
   1. Next.js 15 新特性详解 (相关性: 0.7033379)
   2. Building Modern Web Applications (相关性: 0.24317084)

测试 5: 验证权重排序（标题权重 > 内容权重）
✅ 找到 2 篇文章:
   1. TypeScript 高级类型技巧 (相关性: 0.7033379)
   2. Building Modern Web Applications (相关性: 0.24317084)
```

---

## 技术实现细节

### 数据库架构

**search_vector 生成逻辑**:

```sql
GENERATED ALWAYS AS (
  setweight(to_tsvector('simple', coalesce(title, '')), 'A') ||
  setweight(to_tsvector('simple', coalesce(excerpt, '')), 'B') ||
  setweight(to_tsvector('simple', coalesce("seoDescription", '')), 'B') ||
  setweight(to_tsvector('simple', coalesce(content, '')), 'C')
) STORED
```

**权重说明**:

- **A 权重**: 标题字段，最高优先级
- **B 权重**: 摘要和 SEO 描述，中等优先级
- **C 权重**: 正文内容，较低优先级

这种权重设置确保了搜索结果的相关性排序符合用户预期。

### 索引策略

1. **GIN 索引**: 用于 Post 的全文搜索
   - 索引名: `idx_posts_search_vector`
   - 类型: GIN (Generalized Inverted Index)
   - 优势: 快速的全文搜索性能

2. **pg_trgm 索引**: 用于 User 的模糊搜索
   - 索引名: `idx_users_name_trgm`, `idx_users_bio_trgm`
   - 类型: GIN with trigram operator class
   - 优势: 支持模糊匹配和前缀搜索

---

## 已知限制与后续优化建议

### 中文分词限制

**问题描述**:

- 当前使用 PostgreSQL 的 `simple` 配置
- `simple` 配置使用空格分词，不支持中文分词
- 搜索单个中文词（如"类型"）无法找到包含该词的文章

**影响范围**:

- 中文关键词搜索需要使用完整词组或英文关键词
- 英文搜索完全不受影响

**后续优化方案**:

1. **短期方案**: 在前端提示用户使用完整词组，并通过 nodejieba 生成 token（已在 Phase
   11 实施）
2. **中期方案**: 根据需要扩充 nodejieba 词典，或接入 Meilisearch/Typesense 处理更复杂的召回
3. **长期方案**: 如迁移到自托 PG，可评估 zhparser；更大的流量可考虑 Elasticsearch
   / 语义搜索

### 性能优化建议

1. **缓存机制**: 在 M4 阶段实施搜索结果缓存
2. **查询优化**: 使用 `EXPLAIN ANALYZE` 分析查询计划
3. **索引维护**: 定期运行 `VACUUM` 和 `ANALYZE` 维护索引

---

## 新增或修改的文件清单

### 新增文件

1. **supabase/migrations/20251009100000_add_post_search_vector.sql**
   - 数据库迁移文件
   - 添加全文搜索支持和模糊搜索索引

2. **scripts/test-search.ts**
   - 全文搜索测试脚本
   - 包含中英文搜索测试用例

3. **docs/9-search/M1-完成报告.md**
   - 本完成报告

### 修改文件

1. **prisma/schema.prisma**
   - 在 Post 模型中添加 `searchVector` 字段

---

## 质量保证

### 代码质量检查

- ✅ Prettier 格式化通过
- ✅ TypeScript 类型检查通过（新增字段没有引入新的类型错误）
- ✅ 数据库迁移成功应用

### 测试覆盖

- ✅ 创建了完整的测试脚本
- ✅ 测试了中英文搜索场景
- ✅ 验证了相关性排序和权重设置

---

## 下一步计划

M1 阶段的基础设施已经完全就绪，建议按照以下顺序继续 M2 阶段的开发：

### M2: 搜索 API 和仓储层实现

1. **T2.1**: 创建搜索仓储层（`lib/repos/search/{posts,activities,users,tags}.ts`）
   - 实现 `searchPosts()` 函数
   - 实现 `searchActivities()` 函数
   - 实现 `searchUsers()` 函数
   - 实现 `searchTags()` 函数

2. **T2.2**: 实现统一搜索 Server Action（`lib/actions/search/`）
   - 参数验证（使用 Zod schema）
   - 并行执行多个搜索查询
   - 合并结果并按相关性排序
   - 实现分页逻辑

3. **T2.3**: 实现搜索建议 API
   - 查询标签名称（前缀匹配）
   - 查询文章标题（前缀匹配）
   - 查询用户名（前缀匹配）

4. **T2.4**: 编写搜索 API 单元测试
   - 测试覆盖率 > 85%
   - 边界情况测试完整

---

## 总结

M1 阶段成功完成了搜索功能的基础设施建设，为后续的搜索 API 和 UI 开发奠定了坚实的基础。虽然存在中文分词的已知限制，但这是一个可接受的技术权衡，可以在后续阶段通过应用层分词、外部搜索（Meilisearch/Typesense）或自托 PG +
zhparser 等方式逐步优化。

所有核心验收标准均已达成，项目可以顺利进入 M2 阶段的开发。
