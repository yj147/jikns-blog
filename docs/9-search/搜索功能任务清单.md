# Phase 11：搜索功能任务清单

**版本**: v1.0  
**发布日期**: 2025-10-09  
**预计工期**: 4-5 天  
**关联文档**: [搜索功能设计文档.md](./搜索功能设计文档.md)

> **重构提示（2025-11-09）**：本文档记录的是 Phase
> 11 历史实施过程。当前搜索 Server Actions 已拆分为 `lib/actions/search/`
> 目录，仓储层拆分为
> `lib/repos/search/{posts,activities,users,tags}.ts`。如需最新架构，请参阅
> [README.md](../../README.md) 与 [搜索功能设计文档.md](./搜索功能设计文档.md)。

---

## 里程碑概览

| 里程碑 | 主要内容                     | 预计工期 | 依赖关系 | 状态                |
| ------ | ---------------------------- | -------- | -------- | ------------------- |
| M1     | 数据库迁移和全文搜索基础设施 | 0.5 天   | 无       | ✅ 已完成           |
| M2     | 搜索 API 和仓储层实现        | 1.5 天   | M1       | ✅ 已完成           |
| M3     | 搜索 UI 组件和页面           | 1.5 天   | M2       | ✅ 已完成           |
| M4     | 高级功能和性能优化           | 1 天     | M3       | ✅ 已完成（已简化） |
| M5     | 测试和文档完善               | 0.5 天   | M4       | ✅ 已完成           |

**总计**: 5 天 | **状态**: ✅ 全部完成

> **架构简化说明**: M4 阶段的缓存和速率限制功能已基于 Linus
> Torvalds 式技术审计进行简化。详见 [架构简化说明.md](./架构简化说明.md)。

---

## M1: 数据库迁移和全文搜索基础设施

**目标**: 为 Post 模型添加全文搜索支持，建立搜索基础设施。

### T1.1: 创建数据库迁移文件

**描述**: 为 Post 模型添加 `search_vector` 字段和 GIN 索引。

**工作量**: 0.5 小时

**实施步骤**:

1. 创建迁移文件：`supabase/migrations/YYYYMMDDHHMMSS_add_post_search_vector.sql`
2. 添加 `search_vector` 生成列（包含 title, excerpt, seoDescription, content）
3. 创建 GIN 索引：`idx_posts_search_vector`
4. 为 User 模型添加 pg_trgm 索引（name, bio）
5. 启用 `pg_trgm` 扩展

**验收标准**:

- ✅ 迁移文件创建成功
- ✅ 本地数据库执行迁移无错误
- ✅ `search_vector` 列自动生成并包含正确内容
- ✅ GIN 索引创建成功

**参考**:

- `prisma/migrations/20250927193542_add_activity_search_vector/migration.sql`
- 设计文档第 5.2 节

---

### T1.2: 更新 Prisma Schema

**描述**: 在 Prisma schema 中添加 `search_vector` 字段定义。

**工作量**: 0.5 小时

**实施步骤**:

1. 编辑 `prisma/schema.prisma`
2. 在 `Post` 模型中添加：
   ```prisma
   searchVector  Unsupported("tsvector")? @map("search_vector")
   ```
3. 运行 `pnpm db:generate` 重新生成 Prisma Client
4. 验证类型定义正确

**验收标准**:

- ✅ Prisma schema 更新成功
- ✅ Prisma Client 重新生成无错误
- ✅ TypeScript 类型检查通过

---

### T1.3: 验证全文搜索功能

**描述**: 编写测试脚本验证 PostgreSQL 全文搜索功能正常工作。

**工作量**: 0.5 小时

**实施步骤**:

1. 创建测试脚本：`scripts/test-search.ts`
2. 插入测试数据（包含中英文内容）
3. 执行全文搜索查询
4. 验证搜索结果和相关性排序
5. 清理测试数据

**验收标准**:

- ✅ 全文搜索查询返回正确结果
- ✅ 相关性排序符合预期
- ✅ 中英文搜索均正常工作

---

## M2: 搜索 API 和仓储层实现

**目标**: 实现统一的搜索 API 和各内容类型的搜索逻辑。

### T2.1: 创建搜索仓储层

**描述**: 实现 `lib/repos/search/{posts,activities,users,tags}.ts`
系列，封装各类型的搜索查询逻辑。

**工作量**: 2 小时

**实施步骤**:

1. 创建 `lib/repos/search/{posts,activities,users,tags}.ts`
2. 实现 `searchPosts()` 函数：
   - 使用 `$queryRaw` 执行全文搜索
   - 使用 `ts_rank` 计算相关性评分
   - 支持日期、标签、作者过滤
   - 返回包含评分的结果
3. 实现 `searchActivities()` 函数（复用现有逻辑）
4. 实现 `searchUsers()` 函数（使用 pg_trgm 模糊搜索）
5. 实现 `searchTags()` 函数（复用 Phase 10 逻辑）

**验收标准**:

- ✅ 所有搜索函数实现完成
- ✅ 全文搜索查询正确
- ✅ 相关性评分计算准确
- ✅ 过滤条件正常工作
- ✅ TypeScript 类型安全

**参考**:

- `lib/repos/activity-repo.ts` (Activity 搜索实现)
- `lib/actions/tags.ts` (标签搜索实现)

---

### T2.2: 实现统一搜索 Server Action

**描述**: 创建
`lib/actions/search/`（search-content.ts、search-suggestions.ts、search-authors.ts、utils.ts），实现统一的搜索入口。

**工作量**: 2 小时

**实施步骤**:

1. 创建 `lib/actions/search/` 目录结构
2. 定义 `SearchParams` 和 `SearchResults` 类型
3. 实现 `searchContent()` Server Action：
   - 参数验证（使用 Zod schema）
   - 根据 `type` 参数决定搜索范围
   - 并行执行多个搜索查询（Promise.all）
   - 合并结果并按相关性排序
   - 实现分页逻辑
   - 返回统一的 ApiResponse 格式
4. 实现错误处理和日志记录

**验收标准**:

- ✅ `searchContent()` 函数实现完成
- ✅ 参数验证正确
- ✅ 并行查询正常工作
- ✅ 结果合并和排序正确
- ✅ 分页功能正常
- ✅ 错误处理完善

---

### T2.3: 实现搜索建议 API

**描述**: 实现 `getSearchSuggestions()` Server Action，提供实时搜索建议。

**工作量**: 1.5 小时

**实施步骤**:

1. 在 `lib/actions/search/search-suggestions.ts` 中添加 `getSearchSuggestions()`
   函数
2. 实现搜索建议逻辑：
   - 查询标签名称（前缀匹配，最多 2 条）
   - 查询文章标题（前缀匹配，最多 2 条）
   - 查询用户名（前缀匹配，最多 1 条）
   - 合并结果并按匹配度排序
3. 实现缓存机制（可选）
4. 添加速率限制

**验收标准**:

- ✅ 搜索建议功能正常工作
- ✅ 建议结果相关且有用
- ✅ 响应时间 < 200ms
- ✅ 速率限制生效

---

### T2.4: 编写搜索 API 单元测试

**描述**: 为搜索 API 编写完整的单元测试。

**工作量**: 2 小时

**实施步骤**:

1. 创建 `tests/actions/search.test.ts`
2. 编写测试用例：
   - 搜索文章（全文搜索和相关性排序）
   - 搜索动态
   - 搜索用户
   - 搜索标签
   - 高级过滤（日期、标签、作者）
   - 分页功能
   - 参数验证
   - 权限控制
3. 使用 Mock 数据和 Prisma Mock
4. 确保测试覆盖率 > 85%

**验收标准**:

- ✅ 所有测试用例通过
- ✅ 测试覆盖率 > 85%
- ✅ 边界情况测试完整

---

## M3: 搜索 UI 组件和页面

**目标**: 实现搜索相关的 UI 组件和搜索结果页面。

### T3.1: 创建全局搜索框组件

**描述**: 实现导航栏中的全局搜索框组件。

**工作量**: 2 小时

**实施步骤**:

1. 创建 `components/search/search-bar.tsx`
2. 实现搜索框 UI：
   - 输入框（带搜索图标）
   - 占位符文本
   - 快捷键提示（Ctrl/Cmd + K）
3. 实现搜索逻辑：
   - 输入防抖（300ms）
   - 按回车触发搜索
   - 跳转到搜索结果页
4. 集成到 `components/navigation.tsx`
5. 实现快捷键功能（使用 `useHotkeys` hook）

**验收标准**:

- ✅ 搜索框 UI 美观且响应式
- ✅ 防抖功能正常工作
- ✅ 快捷键功能正常
- ✅ 搜索跳转正确

---

### T3.2: 创建搜索建议组件

**描述**: 实现搜索框的下拉建议列表组件。

**工作量**: 2 小时

**实施步骤**:

1. 创建 `components/search/search-suggestions.tsx`
2. 实现建议列表 UI：
   - 下拉菜单（使用 shadcn/ui Popover）
   - 建议项（带图标和类型标识）
   - 键盘导航（上下箭头选择）
3. 集成搜索建议 API
4. 实现搜索历史记录：
   - 从 localStorage 读取历史
   - 显示最近 5 条搜索
   - 点击历史项快速搜索
5. 实现节流（500ms）

**验收标准**:

- ✅ 建议列表 UI 美观
- ✅ 实时建议功能正常
- ✅ 键盘导航流畅
- ✅ 搜索历史记录正常

---

### T3.3: 创建搜索结果页面

**描述**: 实现搜索结果展示页面 `/search/page.tsx`。

**工作量**: 3 小时

**实施步骤**:

1. 创建 `app/search/page.tsx`
2. 实现页面布局：
   - 搜索结果标题（显示关键词和总数）
   - 结果分组标签（全部/文章/动态/用户/标签）
   - 侧边栏（高级过滤器）
   - 主内容区（搜索结果列表）
   - 分页组件
3. 实现数据获取：
   - 从 URL 参数获取搜索条件
   - 调用 `searchContent()` Server Action
   - 处理加载状态和错误状态
4. 实现 SEO 优化：
   - 动态生成 meta 标签
   - 设置 canonical URL
5. 实现响应式布局

**验收标准**:

- ✅ 页面布局美观且响应式
- ✅ 数据获取正常
- ✅ 加载和错误状态处理完善
- ✅ SEO 优化完整

---

### T3.4: 创建搜索结果卡片组件

**描述**: 实现各类型内容的搜索结果卡片组件。

**工作量**: 2 小时

**实施步骤**:

1. 创建 `components/search/search-result-card.tsx`
2. 实现文章结果卡片：
   - 标题（加粗，可点击）
   - 摘要（最多 200 字符）
   - 元信息（作者、日期、阅读量）
   - 标签列表
3. 实现动态结果卡片
4. 实现用户结果卡片
5. 实现标签结果卡片
6. 实现关键词高亮功能（可选）

**验收标准**:

- ✅ 所有卡片组件实现完成
- ✅ 卡片 UI 美观且一致
- ✅ 点击跳转正确
- ✅ 响应式布局正常

---

### T3.5: 创建高级过滤器组件

**描述**: 实现搜索结果页的高级过滤器侧边栏。

**工作量**: 2 小时

**实施步骤**:

1. 创建 `components/search/search-filters.tsx`
2. 实现过滤器 UI：
   - 内容类型复选框（文章/动态/用户/标签）
   - 日期范围选择器（使用 shadcn/ui DatePicker）
   - 标签选择器（多选）
   - 作者选择器（单选）
   - 排序方式单选框（相关性/最新发布）
3. 实现过滤逻辑：
   - 更新 URL 参数
   - 触发搜索重新执行
4. 实现"清除所有过滤"按钮

**验收标准**:

- ✅ 过滤器 UI 美观且易用
- ✅ 所有过滤条件正常工作
- ✅ URL 参数同步正确
- ✅ 清除过滤功能正常

---

## M4: 高级功能和性能优化 ⚡ _已简化_

**目标**: 实现搜索缓存、速率限制等高级功能，优化性能。

**实际完成**: 基于 Linus Torvalds 式技术审计，简化了缓存策略和速率限制功能。

### T4.1: 搜索结果实时化 ✅ _已简化_

**描述**: 评估缓存策略后，确认搜索结果保持实时查询，避免由缓存导致的可见性风险。

**工作量**: 1.5 小时

**实际实施**:

1. ✅ 移除 `lib/cache/search-cache.ts`，改为完全依赖 PostgreSQL 索引
2. ✅ 保留搜索建议的 per-query 缓存（60s），通过 Next.js `unstable_cache` 实现
3. ✅ 在文档与测试中同步更新“实时查询 + 建议缓存”方案

**理由**:

- 实时结果可确保 deletedAt/status 变更立即生效
- 减少维护成本，无需追踪缓存命中率
- 平均查询耗时 < 200ms，足够支撑当前规模

**验收标准**:

- ✅ 代码中不存在搜索结果缓存逻辑
- ✅ 搜索建议命中缓存时仍能在 60 秒内刷新
- ✅ 文档准确描述实时化策略

---

### T4.2: 实现速率限制 ⚡ _已上线_

**描述**: 为搜索 API 添加速率限制，防止滥用。

**工作量**: 1 小时

**实际实施**:

1. ✅ 创建速率限制模块 `lib/rate-limit/search-limits.ts`
2. ✅ 默认启用用户 60 次/分钟、IP 120 次/分钟的配额，可通过
   `SEARCH_RATE_LIMIT_*` 配置
3. ✅ `searchContent`、`getSearchSuggestions`、`searchAuthorCandidates`
   全量接入；`SEARCH_RATE_LIMIT_ENABLED=false` 时可即时关闭

**策略说明**:

- 将复杂逻辑压缩为单一 helper，方便测试与维护
- 兼容分布式部署（依赖 `applyDistributedRateLimit`）
- 用户体验优先：超限时返回 `RATE_LIMIT_EXCEEDED` 并附带 `retryAfter`

**验收标准**:

- ✅ 速率限制模块已创建并被所有入口调用
- ✅ 默认阈值和窗口可通过环境变量调整
- ✅ 关闭功能无需改代码，只需配置

---

### T4.3: 性能优化和监控 ⚡ _已简化_

**描述**: 优化搜索性能，添加性能监控。

**工作量**: 1.5 小时

**实际实施**:

1. ✅ 优化数据库查询：
   - 使用 Set 去重，避免重复查询
   - 并行查询提升性能
   - 明确字段列表，避免展开运算符
2. ✅ 优化前端性能：
   - 搜索防抖（300ms）
   - 图片懒加载
   - 代码分割
3. ❌ 性能监控（已移除）：
   - ~~记录搜索查询时间~~
   - ~~记录缓存命中率~~
   - ~~记录搜索失败率~~

**简化原因**:

- 性能监控代码污染业务逻辑
- 个人博客不需要复杂的性能监控
- 如需监控，可使用外部工具（如 Vercel Analytics）

**验收标准**:

- ✅ 搜索响应时间 < 1 秒
- ✅ 前端渲染流畅
- ✅ 代码简洁，无性能监控污染

---

## M5: 测试和文档完善

**目标**: 完成集成测试、E2E 测试和用户文档。

### T5.1: 编写集成测试

**描述**: 编写搜索功能的集成测试。

**工作量**: 1.5 小时

**实施步骤**:

1. 创建 `tests/integration/search.test.ts`
2. 编写测试场景：
   - 端到端搜索流程
   - 搜索建议功能
   - 搜索历史记录
   - 缓存功能
3. 使用真实数据库（测试环境）
4. 确保测试可重复执行

**验收标准**:

- ✅ 所有集成测试通过
- ✅ 测试覆盖核心场景
- ✅ 测试稳定可靠

---

### T5.2: 编写 E2E 测试

**描述**: 使用 Playwright 编写搜索功能的 E2E 测试。

**工作量**: 2 小时

**实施步骤**:

1. 创建 `tests/e2e/search.spec.ts`
2. 编写测试场景：
   - 用户在导航栏输入搜索关键词
   - 用户选择搜索建议
   - 用户在搜索结果页使用高级过滤器
   - 用户点击搜索结果跳转到详情页
   - 用户使用搜索历史快速搜索
3. 添加截图和视频录制
4. 确保测试在 CI/CD 中运行

**验收标准**:

- ✅ 所有 E2E 测试通过
- ✅ 测试覆盖关键用户流程
- ✅ 测试在 CI/CD 中稳定运行

---

### T5.3: 编写用户文档

**描述**: 编写搜索功能的用户使用指南。

**工作量**: 1 小时

**实施步骤**:

1. 创建 `docs/9-search/搜索功能使用指南.md`
2. 编写内容：
   - 如何使用全局搜索框
   - 如何使用搜索建议
   - 如何使用高级过滤器
   - 搜索技巧和最佳实践
   - 常见问题解答
3. 添加截图和示例

**验收标准**:

- ✅ 用户文档完整清晰
- ✅ 包含足够的示例和截图
- ✅ 覆盖所有主要功能

---

### T5.4: 编写实施总结报告

**描述**: 编写 Phase 11 的实施总结报告。

**工作量**: 0.5 小时

**实施步骤**:

1. 创建 `docs/9-search/Phase11-实施总结报告.md`
2. 总结内容：
   - 实施过程回顾
   - 完成的功能清单
   - 遇到的问题和解决方案
   - 性能指标和测试结果
   - 后续优化建议
3. 更新项目 README

**验收标准**:

- ✅ 总结报告完整
- ✅ 包含所有关键信息
- ✅ README 更新完成

---

## 风险评估

### 技术难点

| 难点                    | 风险等级 | 应对方案                                                                             |
| ----------------------- | -------- | ------------------------------------------------------------------------------------ |
| PostgreSQL 全文搜索性能 | 中       | 1. 优化索引和查询<br>2. 实施缓存<br>3. 预留升级接口                                  |
| 中文分词效果            | 中       | 1. 使用 nodejieba 生成 token + simple 配置<br>2. 自托环境可评估 zhparser/Meilisearch |
| 搜索结果相关性          | 低       | 1. 调整字段权重<br>2. 收集用户反馈                                                   |
| UI 响应性能             | 低       | 1. 实施防抖节流<br>2. 虚拟滚动                                                       |

### 潜在问题和应对方案

1. **问题**: 搜索结果过多导致性能下降
   - **应对**: 限制每页结果数量，实施分页加载

2. **问题**: 搜索建议响应慢
   - **应对**: 实施缓存，优化查询，使用索引

3. **问题**: 搜索历史记录占用过多存储
   - **应对**: 限制历史记录数量（最多 10 条），定期清理

4. **问题**: 移动端搜索体验差
   - **应对**: 优化移动端 UI，简化过滤器，使用抽屉式布局

---

## 验收标准总结

### 功能完整性

- ✅ 支持文章、动态、用户、标签的全文搜索
- ✅ 搜索结果按相关性排序
- ✅ 支持高级过滤器（类型、日期、标签、作者）
- ✅ 搜索建议功能正常工作
- ✅ 搜索历史记录功能正常

### 性能指标

- ✅ 搜索响应时间 < 1 秒
- ✅ 搜索建议响应时间 < 200ms
- ✅ 前端渲染流畅，无明显卡顿
- ✅ 缓存命中率 > 50%

### 质量标准

- ✅ 单元测试覆盖率 > 85%
- ✅ 所有集成测试和 E2E 测试通过
- ✅ TypeScript 编译无错误
- ✅ ESLint 和 Prettier 检查通过
- ✅ 无安全漏洞

### 用户体验

- ✅ 搜索功能易于发现和使用
- ✅ 搜索结果相关且有用
- ✅ 移动端和桌面端体验良好
- ✅ 错误提示友好清晰

---

_本任务清单作为 Phase
11 搜索功能实施的执行指南，所有任务必须按顺序完成并通过验收标准。_
