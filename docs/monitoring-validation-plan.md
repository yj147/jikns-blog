# é”™è¯¯ç›‘æ§éªŒè¯è®¡åˆ’

# ä»»åŠ¡Bï¼šEnhancedErrorMonitor ç”Ÿäº§éªŒè¯

## ğŸ¯ éªŒè¯ç›®æ ‡

- éªŒè¯æ–°ç›‘æ§ç³»ç»Ÿçš„å‡†ç¡®æ€§å’Œç¨³å®šæ€§
- è°ƒæ•´é˜ˆå€¼ä»¥é¿å…è¯¯æŠ¥
- æ”¶é›†ä¸€å‘¨å®é™…æ•°æ®ä½œä¸ºåŸºå‡†

## ğŸ“Š ç›‘æ§æŒ‡æ ‡é…ç½®

### 1. é¢„ç”Ÿäº§ç¯å¢ƒé…ç½®

```typescript
// lib/observability/error-monitor.ts é¢„ç”Ÿäº§é…ç½®
const PREPROD_CONFIG = {
  // æŠ¥è­¦é˜ˆå€¼ï¼ˆåˆå§‹ä¿å®ˆè®¾ç½®ï¼‰
  thresholds: {
    errorRate: 0.05, // 5% é”™è¯¯ç‡è§¦å‘
    p95Latency: 3000, // 3ç§’ P95 å»¶è¿Ÿ
    consecutiveErrors: 10, // è¿ç»­10ä¸ªé”™è¯¯
  },

  // é‡‡æ ·ç‡
  sampling: {
    errors: 1.0, // 100% é”™è¯¯é‡‡æ ·
    traces: 0.1, // 10% è¿½è¸ªé‡‡æ ·
  },

  // æŠ¥è­¦æ¸ é“
  alerts: {
    email: false, // æš‚ä¸å‘é‚®ä»¶
    slack: true, // Slack é€šçŸ¥
    dashboard: true, // ä»ªè¡¨æ¿æ˜¾ç¤º
  },
}
```

### 2. æ•°æ®æ”¶é›†ç‚¹

- `/api/auth/*` - è®¤è¯ç›¸å…³é”™è¯¯
- `/api/user/*` - ç”¨æˆ·æ“ä½œé”™è¯¯
- `/api/admin/*` - ç®¡ç†å‘˜æ“ä½œé”™è¯¯
- `/api/posts/*` - å†…å®¹æ“ä½œé”™è¯¯
- `Server Actions / Posts` - è®°å½•æ–‡ç« åˆ›å»ºã€å‘å¸ƒã€åˆ é™¤ã€æ‰¹é‡åˆ é™¤çš„æˆåŠŸç‡ä¸è€—æ—¶

### 3. Posts æŒ‡æ ‡æ–°å¢

| æŒ‡æ ‡                             | æè¿°                         | é‡‡é›†æ–¹å¼                              | é˜ˆå€¼å»ºè®®                |
| -------------------------------- | ---------------------------- | ------------------------------------- | ----------------------- |
| `postActionMetrics.totalActions` | Posts Server Action è°ƒç”¨æ€»æ•° | `performanceMonitor.recordPostAction` | ä½œä¸ºè¶‹åŠ¿è§‚å¯Ÿï¼Œä¸è®¾é˜ˆå€¼  |
| `postActionMetrics.failureRate`  | æ“ä½œå¤±è´¥ç‡                   | ç›‘æ§æ—¥æŠ¥å±•ç¤ºï¼Œ>10% è§¦å‘å‘Šè­¦           | 10%ï¼ˆé¢„è®¾ï¼‰             |
| `actions[].averageDuration`      | å„æ“ä½œå¹³å‡è€—æ—¶               | é£ä¹¦æ—¥æŠ¥ + Grafana                    | 1500msï¼ˆè½¯é˜ˆå€¼ï¼‰        |
| `actions[].p95Duration`          | å„æ“ä½œ P95 è€—æ—¶              | Grafana                               | 2500msï¼ˆè½¯é˜ˆå€¼ï¼‰        |
| `actions[].failureCount`         | å„æ“ä½œå¤±è´¥æ¬¡æ•°               | Slack å‘Šè­¦                            | è¿ç»­ 3 æ¬¡å¤±è´¥ï¼ˆç¡¬é˜ˆå€¼ï¼‰ |

> `scripts/collect-monitoring-data.sh`
> åœ¨æ¯æ—¥æ‘˜è¦ä¸­è‡ªåŠ¨æ¸²æŸ“ Posts æŒ‡æ ‡æ‘˜è¦åŠ Markdown è¡¨æ ¼ï¼Œå¯ç›´æ¥å¤åˆ¶è¿›æ—¥æŠ¥/å‘¨æŠ¥ã€‚

## ğŸ“… éªŒè¯æ—¶é—´è¡¨

### Day 1ï¼ˆ2025-09-26ï¼‰

- [x] éƒ¨ç½²ç›‘æ§é…ç½®åˆ°é¢„ç”Ÿäº§ï¼ˆ2025-09-26 23:07ï¼‰
- [x] éªŒè¯æ•°æ®æ”¶é›†æ­£å¸¸ï¼ˆ`monitoring-data/metrics-20250926-230723.json`ï¼‰
- [ ] è®¾ç½® Grafana ä»ªè¡¨æ¿

### Day 2-6

- [ ] æ¯æ—¥æ£€æŸ¥é”™è¯¯æ¨¡å¼
- [ ] è®°å½•è¯¯æŠ¥æƒ…å†µ
- [ ] æ”¶é›†æ€§èƒ½åŸºå‡†æ•°æ®

### Day 7

- [ ] ç”Ÿæˆåˆ†ææŠ¥å‘Š
- [ ] æå‡ºé˜ˆå€¼è°ƒæ•´å»ºè®®
- [ ] ç¼–å†™è¿ç»´æ–‡æ¡£

## ğŸ•’ Cron è‡ªåŠ¨åŒ–è®¡åˆ’

> ç›®æ ‡ï¼šåœ¨éªŒè¯æœŸé—´æ¯å°æ—¶é‡‡é›†ä¸€æ¬¡ç›‘æ§å¿«ç…§ï¼Œå½¢æˆ 7 å¤©è¿ç»­æ•°æ®ã€‚

1. å»ºè®®ä½¿ç”¨ä»“åº“è‡ªå¸¦è„šæœ¬è¿½åŠ  cronï¼ˆå®‰å…¨å¹‚ç­‰ï¼‰ï¼š
   ```bash
   bash scripts/install-monitoring-cron.sh
   ```
2. ç¡®è®¤ `monitoring-data/cron.log` äº§ç”Ÿæ—¥å¿—åï¼Œå°†å…¶åŠ å…¥
   `.gitignore`ï¼ˆå·²å¿½ç•¥ç›®å½•æ— éœ€é¢å¤–è®¾ç½®ï¼‰ã€‚
3. è‹¥ä½¿ç”¨ç³»ç»Ÿçº§è®¡åˆ’ä»»åŠ¡ï¼Œè¯·åœ¨å®Œæˆåï¼Œå°†å®é™…ç”Ÿæ•ˆçš„ cron è®°å½•äºä¸‹è¡¨ï¼Œä»¥ä¾¿è¿ç»´äº¤æ¥ã€‚

| æ—¥æœŸ       | çŠ¶æ€           | å¤‡æ³¨                                                                                           |
| ---------- | -------------- | ---------------------------------------------------------------------------------------------- |
| 2025-09-26 | âœ… æ‰‹åŠ¨æ‰§è¡Œ    | `metrics-20250926-230723.json` / `daily-summary-20250926.md`                                   |
| 2025-09-26 | âœ… cron å·²å®‰è£… | 17:55 UTC æ‰§è¡Œ `scripts/install-monitoring-cron.sh`ï¼Œ`monitoring-data/cron.log` è®°å½•å®‰è£…ä¿¡æ¯   |
| 2025-09-27 | âœ… æ‰‹åŠ¨éªŒè¯    | 02:11 UTC æ‰‹åŠ¨è¿è¡Œé‡‡é›†è„šæœ¬ï¼Œç”Ÿæˆ `metrics-20250927-021150.json` ä¸ `daily-summary-20250927.md` |
| 2025-09-28 | â˜              |                                                                                                |
| 2025-09-29 | â˜              |                                                                                                |
| 2025-09-30 | â˜              |                                                                                                |
| 2025-10-01 | â˜              |                                                                                                |
| 2025-10-02 | â˜              |                                                                                                |

## ğŸ“ å·¡æ£€è®°å½•æ¨¡æ¿

> æ¯æ—¥å·¡æ£€å®Œæˆåï¼Œä»¥ `daily-summary-YYYYMMDD.md` è¿½åŠ ä»¥ä¸‹å­—æ®µï¼š

```markdown
## å·¡æ£€æ¦‚è§ˆï¼ˆYYYY-MM-DDï¼‰

- é‡‡é›†æ‰¹æ¬¡ï¼šmetrics-YYYYMMDD-HHMMSS.json
- é”™è¯¯æ€»æ•° / é”™è¯¯ç‡ï¼š
- å‘Šè­¦æƒ…å†µï¼š
- è¯¯æŠ¥/æ¼æŠ¥ï¼š
- é˜ˆå€¼å»ºè®®ï¼š
- Posts æ“ä½œæ‘˜è¦ï¼š
- Activity é™æµæ‘˜è¦ï¼š
- Activity æœç´¢æ‘˜è¦ï¼š
- å¤‡æ³¨ï¼š
```

## ğŸ“ˆ é¢„æœŸæˆæœ

### ç›‘æ§å¿«ç…§æ¨¡æ¿

```json
{
  "period": "2024-XX-XX to 2024-XX-XX",
  "summary": {
    "totalErrors": 0,
    "errorRate": 0.0,
    "p95Latency": 0,
    "falsePositives": 0
  },
  "patterns": {
    "auth": { "count": 0, "types": [] },
    "api": { "count": 0, "types": [] }
  },
  "recommendations": {
    "thresholdAdjustments": {},
    "newAlertRules": []
  }
}
```

## ğŸ”§ éªŒè¯è„šæœ¬

```bash
# æ£€æŸ¥ç›‘æ§çŠ¶æ€
curl -X GET https://preprod.api/monitoring/health

# æ¨¡æ‹Ÿé”™è¯¯åœºæ™¯
./scripts/simulate-errors.sh --type auth --count 5

# å¯¼å‡ºç›‘æ§æ•°æ®
./scripts/export-monitoring-data.sh --days 7
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒç›´æ¥å¯ç”¨æ¿€è¿›çš„æŠ¥è­¦è§„åˆ™
2. ä¿ç•™åŸæœ‰ç›‘æ§ç³»ç»Ÿä½œä¸ºå¤‡ä»½
3. æ–‡æ¡£åŒ–æ‰€æœ‰é˜ˆå€¼è°ƒæ•´çš„åŸå› 
4. å»ºç«‹å›æ»šè®¡åˆ’ä»¥é˜²æ–°ç³»ç»Ÿå‡ºç°é—®é¢˜

## âœ… å®æ—¶æ‰§è¡Œè®°å½•

- 2025-09-26 23:07ï¼š`bash scripts/collect-monitoring-data.sh` å®Œæˆé¦–æ¬¡é‡‡æ ·ï¼Œç”Ÿæˆ
  `metrics-20250926-230723.json` ä¸ `daily-summary-20250926.md`
- 2025-09-26 17:55 UTCï¼š`bash scripts/install-monitoring-cron.sh`
  å®‰è£…å°æ—¶ cronï¼Œå½“å‰ crontab è¯¦è§ `monitoring-data/cron.log`
- 2025-09-27
  14:12ï¼šè„šæœ¬åœ¨æœ¬åœ°éªŒè¯å‚æ•°é™åˆ¶åæ‰‹åŠ¨æ‰§è¡Œï¼Œ`daily-summary-20250927.md`
  å±•ç¤º Posts æ“ä½œè¡¨æ ¼
- 2025-09-27
  18:45ï¼šè„šæœ¬è¿½åŠ  â€œActivity é™æµæŒ‡æ ‡â€ åŒºå—ï¼Œæ±‡æ€» Redis å‘½ä¸­ç‡æ•°æ®ï¼ˆæ€»æ£€æŸ¥æ¬¡æ•° / æ‹¦æˆªæ•° / ç±»å‹æ‹†åˆ† / å¹³å‡å‰©ä½™é¢åº¦ï¼‰
- 2025-09-27
  19:10ï¼šè„šæœ¬æ–°å¢ â€œActivity æœç´¢æŒ‡æ ‡â€ åŒºå—ï¼Œè¦†ç›–æ€»æœç´¢æ¬¡æ•°ã€P95 è€—æ—¶ã€ç©ºç»“æœç‡ä¸å¹³å‡ç»“æœæ•°é‡
- ä¸‹ä¸€æ­¥ï¼šç­‰å¾… 2025-09-27 00:00 UTC é¦–ä¸ª cron è¾“å‡ºå¹¶æŒç»­è§‚æµ‹ 7 å¤©
