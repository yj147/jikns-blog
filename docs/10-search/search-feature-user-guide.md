# 搜索功能使用指南

**版本**: v1.0  
**发布日期**: 2025-10-09  
**适用对象**: 所有用户

---

## 📖 目录

1. [功能概述](#功能概述)
2. [如何使用全局搜索框](#如何使用全局搜索框)
3. [搜索结果页面](#搜索结果页面)
4. [高级过滤器](#高级过滤器)
5. [搜索建议](#搜索建议)
6. [搜索历史](#搜索历史)
7. [搜索技巧](#搜索技巧)
8. [常见问题](#常见问题)

---

## 功能概述

搜索功能允许您快速找到博客中的文章、动态、用户和标签。系统支持全文搜索，能够智能匹配标题、内容、摘要等多个字段，并按相关性排序结果。

### 核心特性

- ✅ **全文搜索**: 搜索文章标题、内容、摘要、SEO 描述
- ✅ **多类型搜索**: 支持搜索文章、动态、用户、标签
- ✅ **智能排序**: 按相关性和发布时间排序
- ✅ **实时建议**: 输入时显示相关建议
- ✅ **搜索历史**: 自动保存最近搜索
- ✅ **高级过滤**: 按类型、日期、标签、作者过滤

---

## 如何使用全局搜索框

### 位置

全局搜索框位于网站导航栏的中间位置，在所有页面都可以访问。

### 基本使用

1. **点击搜索框**: 点击搜索框或使用快捷键 `Ctrl+K` (Windows/Linux) 或 `Cmd+K`
   (Mac)
2. **输入关键词**: 输入您想搜索的内容，例如 "Next.js"、"React Hooks" 等
3. **触发搜索**:
   - 按 `Enter` 键
   - 点击搜索按钮（放大镜图标）
   - 选择搜索建议

### 快捷键

- `Ctrl/Cmd + K`: 聚焦搜索框
- `Enter`: 执行搜索
- `Esc`: 关闭搜索建议

### 示例

```
搜索框输入: "Next.js 性能优化"
结果: 显示所有包含 "Next.js" 和 "性能优化" 的文章、动态等
```

---

## 搜索结果页面

### 页面布局

搜索结果页面分为三个主要区域：

1. **顶部标题栏**: 显示搜索关键词和结果总数
2. **侧边栏**: 高级过滤器（桌面端）
3. **主内容区**: 搜索结果列表

### 结果分组

搜索结果按类型分组显示：

- **全部**: 显示所有类型的结果
- **文章**: 只显示博客文章
- **动态**: 只显示用户动态
- **用户**: 只显示用户信息
- **标签**: 只显示标签

### 结果卡片

每个搜索结果卡片包含：

**文章卡片**:

- 标题（可点击）
- 摘要（最多 200 字符）
- 作者信息（头像、名称）
- 发布日期
- 标签列表
- 阅读量

**动态卡片**:

- 内容预览（最多 150 字符）
- 作者信息
- 发布时间
- 点赞数、评论数

**用户卡片**:

- 用户头像
- 用户名
- 简介
- 文章数、粉丝数
- 关注按钮

**标签卡片**:

- 标签名称
- 描述
- 文章数量

---

## 高级过滤器

### 内容类型过滤

在搜索结果页面，点击顶部的类型标签可以快速过滤：

- **全部**: 显示所有类型
- **文章**: 只显示文章
- **动态**: 只显示动态
- **用户**: 只显示用户
- **标签**: 只显示标签

### 日期范围过滤（仅文章）

1. 点击侧边栏的"发布日期"过滤器
2. 选择起始日期和结束日期
3. 点击"应用"按钮

### 标签过滤（仅文章）

1. 点击侧边栏的"标签"过滤器
2. 选择一个或多个标签
3. 结果会自动更新

### 作者过滤（仅文章和动态）

1. 点击侧边栏的"作者"过滤器
2. 选择特定作者
3. 结果会自动更新

### 草稿可见性

- **管理员**: 过滤器面板中会出现“仅显示已发布”开关，关闭后即可检索草稿与未发布内容，方便审核。
- **普通用户**: 永远只能看到已发布的内容，系统会强制
  `onlyPublished=true`，即使手动拼接参数也不会显示草稿。

### 排序方式

搜索结果支持两种排序方式：

1. **相关度优先**（默认）：
   - 使用 PostgreSQL `ts_rank` 评分结合时间衰减因子
   - 计算公式：`rank = ts_rank(search_vector, tsQuery) * exp(-λ * age_in_days)`
   - 半衰期：文章 45 天，动态 14 天
   - 适合发现最相关的内容

2. **最新发布**：
   - 按发布时间/创建时间倒序排列
   - 忽略相关性评分
   - 适合查看最新内容

> **降级策略**：当全文搜索失败时，系统会自动降级到 LIKE 查询，此时相关性评分固定为 0，结果将按发布时间 / 创建时间倒序展示，确保体验一致且可预期。

### 清除过滤器

点击侧边栏底部的"清除所有过滤"按钮可以重置所有过滤条件。

---

## 搜索建议

### 什么是搜索建议

当您在搜索框中输入时，系统会自动显示相关的搜索建议，帮助您快速找到想要的内容。

### 建议类型

搜索建议包括：

1. **标签建议**: 显示匹配的标签名称和文章数量
2. **文章建议**: 显示匹配的文章标题和作者
3. **用户建议**: 显示匹配的用户名和简介

### 如何使用

1. 在搜索框中输入至少 2 个字符
2. 等待建议列表出现（300ms 防抖后触发）
3. 使用鼠标点击或键盘上下箭头选择建议
4. 按 `Enter` 或点击建议项跳转

### 键盘导航

- `↑` / `↓`: 在建议列表中上下移动
- `Enter`: 选择当前高亮的建议
- `Esc`: 关闭建议列表

---

## 搜索历史

### 自动保存

系统会自动保存您最近的 5 次搜索记录到浏览器本地存储（`search_history`
键），新的查询会顶替最早的一条。

### 查看历史

1. 点击搜索框
2. 如果有搜索历史，会在建议列表顶部显示
3. 点击历史项可以快速重复搜索

### 清除历史

搜索历史保存在浏览器本地，您可以通过以下方式清除：

1. 清除浏览器缓存和本地存储
2. 使用浏览器的隐私模式（不会保存历史）

---

## 搜索技巧

### 1. 使用关键词组合

**示例**:

```
"Next.js 性能优化"
"React Hooks 最佳实践"
"TypeScript 类型系统"
```

### 2. 搜索特定作者的文章

1. 先搜索关键词
2. 使用侧边栏的"作者"过滤器选择特定作者

### 3. 搜索特定时间段的文章

1. 先搜索关键词
2. 使用侧边栏的"发布日期"过滤器选择日期范围

### 4. 搜索特定标签的文章

1. 先搜索关键词
2. 使用侧边栏的"标签"过滤器选择标签

### 5. 利用搜索建议

输入关键词的前几个字符，查看建议列表，可能会发现更准确的搜索词。

### 6. 使用搜索历史

如果经常搜索相同的内容，可以直接从搜索历史中选择，节省时间。

---

## 常见问题

### Q1: 为什么搜索不到我想要的内容？

**A**: 可能的原因：

- 关键词拼写错误
- 内容尚未发布（草稿状态）
- 内容已被删除
- 搜索词太宽泛或太具体

**建议**:

- 检查拼写
- 尝试使用不同的关键词
- 使用更通用的词语
- 使用高级过滤器缩小范围

### Q2: 搜索结果的排序是如何确定的？

**A**: 默认使用「相关度优先」，计算方式为：

```
rank = ts_rank(search_vector, tsQuery) * exp(-λ * age_in_days)
```

- `λ`（半衰期）按内容类型配置：文章 45 天、动态 14 天；
- `search_vector` 来源于应用层分词的 token（nodejieba），适配中英文；
- 排序次序：标题 > 摘要/描述 > 正文。

切换到“最新发布”时，会忽略相关性，仅按发布时间 / 创建时间倒序展示。

> **降级策略**：当全文检索失败时，系统会自动降级到 LIKE 查询，相关性评分固定为 0，排序改为按发布时间 / 创建时间倒序，确保体验一致。

### Q3: 搜索建议为什么没有显示？

**A**: 可能的原因：

- 输入的字符少于 2 个
- 网络连接问题
- 没有匹配的建议

**建议**:

- 输入至少 2 个字符
- 检查网络连接
- 尝试不同的关键词

### Q4: 搜索历史保存在哪里？

**A**: 搜索历史保存在浏览器的本地存储（localStorage）中，不会上传到服务器。这意味着：

- 历史记录只在当前浏览器可见
- 清除浏览器数据会删除历史记录
- 使用隐私模式不会保存历史记录

### Q5: 搜索功能支持哪些语言？

**A**: 搜索功能支持中文和英文。系统使用 PostgreSQL 的全文搜索功能，能够正确处理中英文混合内容。

实现细节：

- **应用层分词**：写入内容时使用 nodejieba 进行中文分词，生成
  `titleTokens`、`contentTokens` 等字段
- **数据库配置**：使用 `to_tsvector('simple', tokens)` 构建
  `search_vector`，simple 配置不做语言特定处理，直接使用已分词的 token
- **无需扩展**：完全不依赖 PostgreSQL 扩展（如 zhparser），适用于 Supabase 托管环境

这种设计确保了在任何环境下都能获得稳定的中文搜索体验，同时保持了架构的简洁性和可移植性。

### Q6: 为什么有时会看到「搜索过于频繁」的提示？

**A**: 搜索结果、搜索建议与作者候选共用同一限流桶：

- 登录用户默认 60 次/分钟；
- 匿名 IP 默认 120 次/分钟；
- 超过阈值会返回 `RATE_LIMIT_EXCEEDED`，UI 会展示剩余等待时间。

如果在联调中频繁看到该提示，可以临时调高 `SEARCH_RATE_LIMIT_*` 环境变量。

### Q7: 搜索速度慢怎么办？

**A**: 搜索功能已经过性能优化，通常在 1 秒内返回结果。如果遇到速度慢的情况：

- 检查网络连接
- 尝试刷新页面
- 使用更具体的关键词减少结果数量
- 使用高级过滤器缩小搜索范围

### Q8: 可以搜索已删除的内容吗？

**A**: 不可以。搜索功能只会返回：

- 已发布的文章（`published: true`）
- 未删除的动态（`isDeleted: false`）
- 活跃的用户（`status: ACTIVE`）

### Q9: 搜索功能有使用限制吗？

**A**: 为了保护服务器资源，搜索功能有以下限制：

- 每个 IP 地址：默认 120 次/分钟（`SEARCH_RATE_LIMIT_PER_IP` 可配置）
- 已登录用户：默认 60 次/分钟（`SEARCH_RATE_LIMIT_PER_USER` 可配置）
- 搜索建议与作者候选和主搜索共用同一计数桶，因此频繁请求任意一种接口都会影响其它接口
- 速率窗口默认 60 秒（`SEARCH_RATE_LIMIT_WINDOW_MS`）

如果超出限制，系统会显示友好的错误提示，并告知您何时可以重试。

---

## 反馈与建议

如果您在使用搜索功能时遇到问题或有改进建议，欢迎通过以下方式联系我们：

- 提交 Issue
- 发送邮件
- 在社区讨论

---

**最后更新**: 2025-10-09  
**文档版本**: v1.0
