# 搜索模块架构验证报告

**验证日期**: 2025-12-20 **验证状态**: ✅ 文档与代码已对齐

---

## 1. 核心架构确认

经过代码审查与文档更新，确认当前搜索模块的架构如下：

### 1.1 统一入口 (Server Actions)

- **实现位置**: `lib/actions/search/search-content.ts`
- **职责**: 作为 UI 组件（全局搜索框、搜索结果页）的统一数据源。
- **特性**:
  - **参数验证**: 使用 Zod Schema (`SearchParamsSchema`)。
  - **统一限流**: 调用 `lib/rate-limit/search-limits.ts`，默认配置为 User
    60/min, IP 120/min。
  - **逻辑分发**: 将查询分发至 `lib/repos/search/` 下的专用仓储函数。

### 1.2 数据仓储 (Repositories)

- **位置**: `lib/repos/search/{unified-search,posts,activities,users,tags}.ts`
- **机制**:
  - 优先尝试 PostgreSQL 全文搜索 (`tsvector @@ tsquery`)。
  - 自动降级至 `ILIKE` 模糊查询（当全文搜索失败时）。
  - 支持复杂的过滤逻辑（标签、作者、日期范围）。

### 1.3 数据写入与分词 (Prisma Extension)

- **位置**: `lib/prisma.ts` (`searchTokenExtension`)
- **机制**:
  - 在 `create` / `update` 钩子中拦截写入操作。
  - 调用 `nodejieba` 对文本进行分词。
  - 将分词结果存入 `*Tokens` 字段（如 `titleTokens`, `contentTokens`）。
  - 数据库层 `search_vector` 生成列基于这些 Tokens 字段构建 `tsvector`。
- **优势**: 解决了 PostgreSQL `simple`
  配置无法处理中文分词的问题，且无需安装额外的数据库扩展（如 zhparser）。

---

## 2. 兼容性修复验证 (Compatibility Fixes)

### 2.1 中文分词 (Chinese Segmentation)

- **问题**: `ts_query` 对中文支持不佳。
- **修复**: `buildTsQuery` (在 `lib/search/rank-utils.ts`) 调用 `tokenizeText`
  (在 `lib/search/tokenizer.ts`)，使用 `nodejieba` 对查询词进行预分词。
- **状态**: ✅ 已验证。查询构建逻辑与数据写入逻辑使用相同的分词器，保证召回率。

### 2.2 邮箱搜索 (Email Search)

- **问题**: 用户搜索仅匹配 `name` 和 `bio`，遗漏 `email`。
- **修复**: `lib/repos/search/users.ts` 恢复了对 `email` 字段的 `ILIKE` 匹配（在
  `pg_trgm` 主路径和 fallback 路径均已包含）。
- **状态**: ✅ 已验证。

### 2.3 Tags 排序 (Tags Sorting)

- **问题**: Tags 搜索缺少按时间排序的支持。
- **修复**: `lib/repos/search/tags.ts` 中的 `searchTags` 函数已正确接收并处理
  `sort` 参数（支持 `latest` 和 `relevance`）。
- **状态**: ✅ 已验证。

---

## 3. 遗留组件说明 (Legacy)

### 3.1 REST API (`/api/search`)

- **位置**: `app/api/search/route.ts`
- **依赖**: 调用 `lib/repos/search/unified-search.ts`（repos 聚合）。
- **状态**: **遗留接口 (Legacy)**。
- **差异**:
  - **限流**: 已使用 `checkSearchRateLimit`（与 Server Action 对齐）。
  - **用途**: 目前主要用于向后兼容或外部简单的 API 调用。
  - **建议**: 如需进一步简化入口，可考虑直接复用 Server Action。

---

## 4. 修正记录

本次文档更新修复了以下关键偏差：

1.  **架构对齐**: 确认 `lib/services/search.ts` 已被彻底移除，架构简化为 Server
    Actions / REST API -> Repositories。
2.  **SQL 迁移脚本**: 修正了 `docs/10-search/搜索功能设计文档.md`
    中的 SQL 示例，明确了 `search_vector` 来源于 `*Tokens`
    分词字段而非原始文本字段。
3.  **限流策略**: 确认了文档中关于“可配置限流”的描述准确对应
    `lib/rate-limit/search-limits.ts` 的实现 (60/120)。
