# 现代化博客项目数据库实体关系图

## 完整 ERD 图

```mermaid
erDiagram
    %% 枚举定义
    Role ||--o{ User : has
    UserStatus ||--o{ User : has
    NotificationType ||--o{ Notification : has
    EmailSubscriptionStatus ||--o{ EmailSubscriber : has
    EmailQueueStatus ||--o{ EmailQueue : has
    MetricType ||--o{ PerformanceMetric : has

    %% 用户系统
    User {
        string id PK
        string email UK
        string name
        string avatarUrl
        string coverImage
        text bio
        json socialLinks
        Role role
        UserStatus status
        string passwordHash
        datetime createdAt
        datetime updatedAt
        datetime lastLoginAt
        string location
        string phone
        json notificationPreferences
        json privacySettings
        string nameTokens
        string bioTokens
        tsvector search_vector
    }

    %% 博客模块
    Post {
        string id PK
        string slug UK
        string title
        text content
        string excerpt
        boolean published
        boolean isPinned
        string canonicalUrl
        string seoTitle
        string seoDescription
        int viewCount
        datetime createdAt
        datetime updatedAt
        datetime publishedAt
        string authorId FK
        string seriesId FK
        string coverImage
        string titleTokens
        string contentTokens
        tsvector search_vector
    }

    Series {
        string id PK
        string title
        string slug UK
        text description
        string coverUrl
        int sortOrder
        datetime createdAt
        datetime updatedAt
        string authorId FK
    }

    Tag {
        string id PK
        string name UK
        string slug UK
        string description
        string color
        int postsCount
        int activitiesCount
        datetime createdAt
        datetime updatedAt
        tsvector search_vector
    }

    PostTag {
        string postId PK,FK
        string tagId PK,FK
        datetime createdAt
    }

    %% 社交动态模块
    Activity {
        string id PK
        text content
        string[] imageUrls
        boolean isPinned
        int commentsCount
        int likesCount
        int viewsCount
        datetime createdAt
        datetime updatedAt
        datetime deletedAt
        string authorId FK
        tsvector search_vector
    }

    ActivityTag {
        string activityId PK,FK
        string tagId PK,FK
        datetime createdAt
    }

    ActivityTagCandidate {
        string id PK
        string name
        string slug UK
        int occurrences
        datetime lastSeenAt
    }

    %% 通用交互模块
    Comment {
        string id PK
        text content
        datetime createdAt
        datetime updatedAt
        datetime deletedAt
        string authorId FK
        string postId FK
        string activityId FK
        string parentId FK
    }

    Like {
        string id PK
        datetime createdAt
        string authorId FK
        string postId FK
        string activityId FK
    }

    %% 用户功能模块
    Bookmark {
        string id PK
        datetime createdAt
        string userId FK
        string postId FK
    }

    Follow {
        string followerId PK,FK
        string followingId PK,FK
        datetime createdAt
    }

    %% 通知与订阅模块
    Notification {
        string id PK
        string recipientId FK
        string actorId FK
        NotificationType type
        datetime readAt
        string postId FK
        string commentId FK
        string activityId FK
        string followerId FK
    }

    EmailSubscriber {
        string id PK
        string email UK
        string userId FK
        EmailSubscriptionStatus status
        datetime verifiedAt
        datetime lastDigestAt
        json preferences
    }

    EmailQueue {
        string id PK
        string subscriberId FK
        NotificationType type
        datetime scheduledAt
        EmailQueueStatus status
        string notificationId FK
        string postId FK
    }

    %% 系统监控模块
    PerformanceMetric {
        string id PK
        MetricType type
        float value
        datetime timestamp
        string userId FK
    }

    SystemSetting {
        string key PK
        json value
        string category
        string updatedById FK
    }

    %% 关系定义
    User ||--o{ Post : "authors"
    User ||--o{ Series : "creates"
    User ||--o{ Activity : "publishes"
    User ||--o{ Comment : "writes"
    User ||--o{ Like : "gives"
    User ||--o{ Bookmark : "saves"
    User ||--o{ Notification : "receives/sends"
    User ||--o{ EmailSubscriber : "has"
    User ||--o{ PerformanceMetric : "generates"
    User ||--o{ SystemSetting : "updates"

    Series ||--o{ Post : "contains"

    Post ||--o{ Comment : "receives"
    Post ||--o{ Like : "receives"
    Post ||--o{ Bookmark : "bookmarked_as"
    Post ||--o{ Notification : "triggers"
    Post ||--o{ PostTag : "has"
    Post ||--o{ EmailQueue : "triggers"

    Activity ||--o{ Comment : "receives"
    Activity ||--o{ Like : "receives"
    Activity ||--o{ Notification : "triggers"
    Activity ||--o{ ActivityTag : "has"
    Activity ||--o{ ActivityTagCandidate : "generates"

    Tag ||--o{ PostTag : "in"
    Tag ||--o{ ActivityTag : "in"

    Comment ||--o{ Comment : "replies_to"
    Comment ||--o{ Notification : "triggers"

    Notification ||--o{ EmailQueue : "triggers"
    EmailSubscriber ||--o{ EmailQueue : "receives"

    %% 自引用多对多（关注关系）
    User ||--o{ Follow : "follower"
    User ||--o{ Follow : "following"
```

## 模块化 ERD 图

### 1. 用户系统模块

```mermaid
erDiagram
    User {
        string id PK
        string email UK "用户邮箱，唯一标识"
        string name "用户昵称"
        string avatarUrl "头像URL"
        text bio "个人简介"
        json socialLinks "社交链接JSON"
        Role role "用户角色：USER|ADMIN"
        UserStatus status "用户状态：ACTIVE|BANNED"
        string passwordHash "密码哈希，OAuth用户为null"
        datetime createdAt "创建时间"
        datetime updatedAt "更新时间"
        datetime lastLoginAt "最后登录时间"
    }

    Role {
        USER "普通用户"
        ADMIN "管理员"
    }

    UserStatus {
        ACTIVE "活跃状态"
        BANNED "封禁状态"
    }

    Role ||--o{ User : has
    UserStatus ||--o{ User : has
```

### 2. 博客模块

```mermaid
erDiagram
    User {
        string id PK
        string name
        Role role
    }

    Post {
        string id PK
        string slug UK "URL友好标识符"
        string title "文章标题"
        text content "文章正文"
        string excerpt "文章摘要"
        boolean published "是否发布"
        boolean isPinned "是否置顶"
        string canonicalUrl "SEO规范URL"
        string seoTitle "SEO标题"
        string seoDescription "SEO描述"
        int viewCount "浏览量"
        datetime createdAt "创建时间"
        datetime updatedAt "更新时间"
        datetime publishedAt "发布时间"
        string authorId FK
        string seriesId FK
    }

    Series {
        string id PK
        string title "系列标题"
        string slug UK "URL友好标识符"
        text description "系列描述"
        string coverUrl "系列封面"
        int sortOrder "排序权重"
        datetime createdAt
        datetime updatedAt
        string authorId FK
    }

    Tag {
        string id PK
        string name UK "标签名称"
        string slug UK "URL友好标识符"
        string description "标签描述"
        string color "标签颜色"
        int postsCount "使用计数"
        datetime createdAt
        datetime updatedAt
    }

    PostTag {
        string postId PK,FK
        string tagId PK,FK
        datetime createdAt
    }

    %% 关系
    User ||--o{ Post : "authors"
    User ||--o{ Series : "creates"
    Series ||--o{ Post : "contains"
    Post ||--o{ PostTag : ""
    PostTag }o--|| Tag : ""
```

### 3. 社交动态模块

```mermaid
erDiagram
    User {
        string id PK
        string name
        string avatarUrl
    }

    Activity {
        string id PK
        text content "动态内容"
        json imageUrls "图片URL数组"
        boolean isPinned "是否置顶"
        datetime createdAt "创建时间"
        datetime updatedAt "更新时间"
        string authorId FK
    }

    Follow {
        string followerId PK,FK "关注者ID"
        string followingId PK,FK "被关注者ID"
        datetime createdAt "关注时间"
    }

    %% 关系
    User ||--o{ Activity : "publishes"
    User ||--o{ Follow : "as_follower"
    User ||--o{ Follow : "as_following"
```

### 4. 通用交互模块

```mermaid
erDiagram
    User {
        string id PK
        string name
    }

    Post {
        string id PK
        string title
    }

    Activity {
        string id PK
        text content
    }

    Comment {
        string id PK
        text content "评论内容"
        datetime createdAt "创建时间"
        datetime updatedAt "更新时间"
        string authorId FK "评论者ID"
        string postId FK "文章ID（可空）"
        string activityId FK "动态ID（可空）"
        string parentId FK "父评论ID（可空）"
    }

    Like {
        string id PK
        datetime createdAt "点赞时间"
        string authorId FK "点赞者ID"
        string postId FK "文章ID（可空）"
        string activityId FK "动态ID（可空）"
    }

    %% 关系
    User ||--o{ Comment : "writes"
    User ||--o{ Like : "gives"
    Post ||--o{ Comment : "receives"
    Activity ||--o{ Comment : "receives"
    Post ||--o{ Like : "receives"
    Activity ||--o{ Like : "receives"
    Comment ||--o{ Comment : "replies_to"
```

### 5. 用户功能模块

```mermaid
erDiagram
    User {
        string id PK
        string name
    }

    Post {
        string id PK
        string title
    }

    Bookmark {
        string id PK
        datetime createdAt "收藏时间"
        string userId FK "用户ID"
        string postId FK "文章ID"
    }

    %% 关系
    User ||--o{ Bookmark : "saves"
    Post ||--o{ Bookmark : "bookmarked_as"
```

### 6. 通知与订阅模块

```mermaid
erDiagram
    User {
        string id PK
        string email
        json notificationPreferences
    }

    Notification {
        string id PK
        string recipientId FK
        string actorId FK
        NotificationType type "LIKE|COMMENT|FOLLOW|SYSTEM|NEW_POST"
        boolean read "通过readAt判断"
        datetime createdAt
    }

    EmailSubscriber {
        string id PK
        string email UK
        EmailSubscriptionStatus status "PENDING|VERIFIED|..."
        string verifyTokenHash
        string unsubscribeTokenHash
    }

    EmailQueue {
        string id PK
        string subscriberId FK
        NotificationType type
        EmailQueueStatus status "PENDING|SENDING|SENT|FAILED"
        int attempts
        string lastError
        datetime scheduledAt
    }

    %% 关系
    User ||--o{ Notification : "receives"
    User ||--o{ Notification : "triggers"
    User ||--o{ EmailSubscriber : "links_to"
    Notification ||--o{ EmailQueue : "generates_email"
    EmailSubscriber ||--o{ EmailQueue : "receives_email"
```

### 7. 系统监控与设置模块

```mermaid
erDiagram
    User {
        string id PK
        Role role
    }

    PerformanceMetric {
        string id PK
        MetricType type "api_response|db_query|..."
        float value
        string unit
        json context
        string[] tags
        datetime timestamp
    }

    SystemSetting {
        string key PK
        json value
        string category
        string description
        string updatedById FK
    }

    %% 关系
    User ||--o{ PerformanceMetric : "triggers"
    User ||--o{ SystemSetting : "modifies"
```

## 关系类型说明

### 一对一关系 (1:1)

- `User` ↔ `EmailSubscriber` (可选，未登录用户也可以订阅)

### 一对多关系 (1:N)

1. **User → Posts**: 用户（管理员）发布多篇文章
2. **User → Activities**: 用户发布多条动态
3. **User → Series**: 用户创建多个文章系列
4. **User → Comments**: 用户发表多条评论
5. **User → Likes**: 用户给出多个点赞
6. **User → Bookmarks**: 用户收藏多篇文章
7. **Series → Posts**: 系列包含多篇文章
8. **Post → Comments**: 文章收到多条评论
9. **Activity → Comments**: 动态收到多条评论
10. **Comment → Comments**: 评论的嵌套回复
11. **User → Notifications**: 用户接收/触发多条通知
12. **User → PerformanceMetrics**: 用户行为产生多条性能指标
13. **EmailSubscriber → EmailQueue**: 订阅者接收多封邮件

### 多对多关系 (M:N)

1. **Post ↔ Tag**: 文章与标签的多对多关系（通过PostTag中间表）
2. **Activity ↔ Tag**: 动态与标签的多对多关系（通过ActivityTag中间表）
3. **User ↔ User**: 用户关注关系（通过Follow自引用表）

### 多态关联

1. **Comment**: 既可以评论Post，也可以评论Activity
2. **Like**: 既可以点赞Post，也可以点赞Activity
3. **Notification**: 可关联 Post, Comment, Activity, User (Follower)

## 索引设计图

```mermaid
graph TD
    subgraph "主键索引 (自动创建)"
        PK_ALL[所有表的 id]
    end

    subgraph "唯一索引 (业务约束)"
        UK1[User.email]
        UK2[Post.slug]
        UK3[Series.slug]
        UK4[Tag.name]
        UK5[Tag.slug]
        UK6[EmailSubscriber.email]
        UK7[ActivityTagCandidate.slug]
    end

    subgraph "全文检索索引 (GIN)"
        GIN1[Post.search_vector]
        GIN2[Activity.search_vector]
        GIN3[User.search_vector]
        GIN4[Tag.search_vector]
        GIN5[User.name/bio/email (trgm)]
    end

    subgraph "复合索引 (性能优化)"
        CI1[Post: published + publishedAt DESC]
        CI2[Like: authorId + postId/activityId]
        CI3[Bookmark: userId + postId]
        CI4[Follow: followerId + followingId]
        CI5[Notification: recipientId + readAt]
        CI6[EmailQueue: status + scheduledAt]
        CI7[PerformanceMetric: type + timestamp]
    end

    subgraph "排序索引 (时间序列)"
        SI1[Activity.createdAt DESC]
        SI2[Comment.createdAt DESC]
        SI3[Tag.postsCount DESC]
        SI4[ActivityTagCandidate.lastSeenAt]
    end
```

## 数据流向图

```mermaid
graph LR
    subgraph "核心业务流"
        U1[User] -->|发布| P1[Post/Activity]
        P1 -->|触发| N1[Notification]
        N1 -->|入队| Q1[EmailQueue]
        Q1 -->|发送| E1[Email]
    end

    subgraph "搜索与发现"
        U2[User] -->|搜索| S1[Search Engine]
        S1 -->|查询| V1[tsvector/GIN]
        V1 -->|返回| R1[Results]
    end
```

## 总结

本实体关系图完整展现了现代化博客项目的数据架构（v4.2）：

1.  **16个核心模型**：新增了通知、邮件订阅、性能监控、系统设置等基础设施模型。
2.  **全文检索支持**：核心内容表（Post, Activity, User, Tag）均集成了 PostgreSQL
    `tsvector` 和 GIN 索引，支持高性能全文搜索。
3.  **完善的通知体系**：支持站内通知和邮件推送的双重触达机制。
4.  **运维监控能力**：内置性能指标采集和动态系统设置，提升系统可维护性。
5.  **性能优化导向**：超过25个精心设计的索引，特别是针对复杂查询和全文检索的优化。

该架构不仅满足了博客和社交的基本需求，还为大规模用户运营、内容分发和系统稳定性提供了坚实的底层支撑。
