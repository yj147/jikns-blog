# 现代化博客项目数据库架构设计说明

**版本**: 4.2 **日期**: 2025-12-20 **编制**: Claude (Based on Implementation)

## 目录

1. [设计概述](#1-设计概述)
2. [数据模型详解](#2-数据模型详解)
3. [关系设计论证](#3-关系设计论证)
4. [索引策略分析](#4-索引策略分析)
5. [数据完整性与安全性](#5-数据完整性与安全性)
6. [性能优化考量](#6-性能优化考量)
7. [扩展性设计](#7-扩展性设计)

## 1. 设计概述

### 1.1 架构理念

本数据库架构基于"双重核心"设计理念，明确区分**博客模块**（管理员控制）和**动态模块**（多用户社交）两大业务场景。架构采用模块化设计，具备良好的可扩展性和维护性。

### 1.2 核心设计原则

1. **业务分离**: 博客管理和社交互动功能完全分离，各自独立演进
2. **通用化设计**: 评论和点赞系统采用多态关联，支持不同内容类型
3. **权限精细化**: 基于角色和状态的双重权限控制机制
4. **性能导向**: 针对高频查询场景优化索引设计，引入全文本地搜索引擎
5. **数据安全**: 级联删除和软删除机制确保数据完整性

### 1.3 模型统计

- **核心模型**: 16个（新增 Notification, EmailSubscriber, EmailQueue,
  PerformanceMetric, SystemSetting 等）
- **枚举类型**: 6个（Role, UserStatus, NotificationType,
  EmailSubscriptionStatus, EmailQueueStatus, MetricType）
- **关系类型**: 一对一(0), 一对多(13), 多对多(3), 多态关联(3)
- **索引数量**: 25+个（包含GIN全文索引、复合索引和唯一约束）

## 2. 数据模型详解

### 2.1 用户系统模块

#### 2.1.1 User 模型

**设计理念**: 作为整个系统的核心模型，User 模型承载了用户身份认证、权限控制、社交关系和个性化设置的全部功能。

**新增字段说明**:

- `search_vector`: 基于 PostgreSQL `tsvector` 的全文检索向量
- `nameTokens`, `bioTokens`: 用于生成搜索向量的中间字段
- `notificationPreferences`: JSON 存储的细粒度通知偏好
- `privacySettings`: JSON 存储的隐私设置

**权限设计逻辑**:

```typescript
// 权限检查示例逻辑
function checkBlogPermission(user: User): boolean {
  return user.role === "ADMIN" && user.status === "ACTIVE"
}

function checkInteractionPermission(user: User): boolean {
  return user.status === "ACTIVE" // 不区分角色，所有活跃用户均可互动
}
```

### 2.2 博客模块

#### 2.2.1 Post 模型

**设计理念**: 面向专业内容创作的长文章模型，强调 SEO 优化和内容管理功能。

**新增搜索能力**: Post 模型集成了原生全文检索能力，通过 database generated
column 自动维护 `search_vector`。

```prisma
search_vector Unsupported("tsvector")? @default(dbgenerated("..."))
@@index([search_vector], type: Gin)
```

**发布控制逻辑**:

```typescript
interface PublishState {
  published: boolean // 是否公开可见
  publishedAt: Date? // 实际发布时间
  isPinned: boolean // 是否置顶显示
}
```

### 2.3 社交动态模块

#### 2.3.1 Activity 模型

**设计理念**: 轻量级短内容发布，支持图文混合和快速互动。

**新增特性**:

- 集成 ActivityTagCandidate 系统，支持动态标签自动发现
- 集成全文检索，支持内容搜索

### 2.4 通用交互模块

#### 2.4.1 Comment 模型（多态设计）

**设计理念**: 统一的评论系统，支持文章和动态的评论，以及嵌套回复功能。

**多态关联实现**:

```prisma
model Comment {
  // 多态字段：评论目标
  postId     String?
  activityId String?
  post       Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  activity   Activity? @relation(fields: [activityId], references: [id], onDelete: Cascade)

  // 嵌套回复
  parent     Comment?  @relation("commentsTocomments", fields: [parentId], references: [id], onDelete: NoAction)
  parentId   String?
  replies    Comment[] @relation("commentsTocomments")
}
```

#### 2.4.2 Like 模型（多态设计）

**设计理念**: 轻量级点赞系统，支持文章和动态的点赞功能。

### 2.5 用户功能模块

包含 Bookmark (收藏) 和 Follow (关注) 模型。

### 2.6 通知与订阅模块 (新增/已实现)

#### 2.6.1 Notification 模型

**设计理念**: 统一的站内通知中心，支持多渠道分发。

**核心字段**:

- `type`: 通知类型 (LIKE, COMMENT, FOLLOW, SYSTEM, NEW_POST)
- `readAt`: 标记已读状态
- `recipientId` / `actorId`: 接收者和触发者
- 多态关联: 关联到 Post, Comment, Activity 或 Follower

#### 2.6.2 EmailSubscriber & EmailQueue

**设计理念**: 邮件订阅列表和异步发送队列。

- `EmailSubscriber`: 管理订阅状态 (PENDING, VERIFIED) 和 token
- `EmailQueue`: 邮件发送任务队列，支持重试、状态追踪和定时发送

### 2.7 系统与监控模块 (新增/已实现)

#### 2.7.1 PerformanceMetric

**设计理念**: 应用层性能监控数据持久化。

- `type`: 指标类型 (api_response, db_query 等)
- `value`: 数值
- `tags`: 维度标签

#### 2.7.2 SystemSetting

**设计理念**: 动态系统配置，无需重新部署即可修改系统行为。

### 2.8 全文检索模块 (新增/已实现)

基于 PostgreSQL 的原生全文检索实现，无需引入外部搜索引擎（如 ElasticSearch）。

- **原理**: 使用 `tsvector` 数据类型存储分词后的向量，使用 `GIN` 索引加速查询。
- **自动维护**: 通过 Prisma 的 `dbgenerated`
  和 PostgreSQL 函数，在数据写入时自动更新向量。
- **支持范围**: Post (标题, 内容, 摘要), Activity (内容), User (名称, 简介), Tag
  (名称, 描述).

## 3. 关系设计论证

（保持原有内容不变）

## 4. 索引策略分析

### 4.1 全文检索索引 (新增)

```prisma
@@index([search_vector], type: Gin)
```

使用 GIN (Generalized Inverted
Index) 索引加速全文检索查询，支持复杂的逻辑操作符 (`&`, `|`,
`!`) 和排名 (`ts_rank`)。

### 4.2 复合索引更新

新增了针对通知和邮件队列的高频查询索引：

```prisma
// 查找未读通知
@@index([recipientId, readAt])

// 查找待发送邮件
@@index([status, scheduledAt])
```

## 7. 扩展性设计

### 7.1 功能扩展状态

#### 7.1.1 通知系统实现 (已完成)

已实现基于 `Notification` 模型和 `useRealtimeNotifications`
hook 的全栈通知系统。

#### 7.1.2 邮件订阅实现 (已完成)

已实现基于 `EmailSubscriber` 和 `EmailQueue`
的 Newsletter 系统，支持双重验证 (Double Opt-in) 和批量发送。

#### 7.1.3 内容审核预留 (规划中)

```prisma
// 未来扩展：审核记录
model ModerationLog {
  id         String   @id @default(cuid())
  action     String   // 'approve', 'reject', 'delete'
  reason     String?
  // ...
}
```

（后续章节保持不变）
