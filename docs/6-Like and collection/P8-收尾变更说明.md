# Phase 8 收尾变更说明

## 更新时间

2025-09-15

## 变更内容

### 1. 审计日志统一 (/api/bookmarks)

- **描述**: 将收藏 API 的审计日志切换至统一的 `auditLogger` 工具
- **影响范围**: `/api/bookmarks` 路由
- **关键改动**:
  - 使用 `lib/audit-log.ts` 中的 `auditLogger` 替代独立的日志实现
  - 审计日志包含：IP 地址、User-Agent、操作类型、目标ID、结果状态
  - 支持客户端 IP 提取（支持代理头 x-forwarded-for）

### 2. 点赞/收藏限流钩子

- **描述**: 为点赞和收藏的 POST 操作添加可配置的限流保护
- **状态**: 默认关闭，需通过环境变量启用
- **配置项**:

  ```env
  # 启用限流（默认关闭）
  RATE_LIMIT_ENABLED=true

  # 限流窗口（毫秒，默认 60000 = 1分钟）
  RATE_LIMIT_WINDOW_MS=60000

  # 窗口内最大请求数（默认 10）
  RATE_LIMIT_MAX_REQUESTS=10
  ```

- **实现位置**:
  - `/api/likes` POST 方法
  - `/api/bookmarks` POST 方法
- **限流逻辑**: 基于用户ID的滑动窗口限流

### 3. Bookmark 列表稳定排序与复合索引

- **描述**: 优化收藏列表的查询性能和排序稳定性
- **数据库变更**:
  - 新增复合索引: `@@index([userId, createdAt(sort: Desc)])`
  - 确保分页查询的排序稳定性
- **迁移文件**: `20250915173257_add_bookmark_user_created_idx.sql`
- **应用方式**:

  ```bash
  # 本地快速应用
  pnpm db:push

  # 生产环境迁移
  supabase db push
  ```

### 4. 博客详情页点赞按钮统一

- **描述**: 将博客详情页页脚的"有帮助"按钮替换为 LikeButton 组件
- **影响文件**: `/app/blog/[slug]/page.tsx`
- **改动内容**:
  - 页头和页脚现在使用相同的 `<LikeButton>` 组件
  - 保持点赞状态和计数的一致性
  - 移除了 ThumbsUp 图标导入（已被 LikeButton 内部的 Heart 图标替代）
- **用户体验改进**:
  - 页头/页脚点赞操作实时同步
  - 刷新页面后状态正确保持
  - 侧栏统计数据保持最终一致性

## 验证方法

### 1. 点赞功能验证

```bash
# 访问博客详情页
# 检查页头和页脚的点赞按钮状态是否同步
# 点击任一按钮后，两处计数应同时更新
```

### 2. 数据库索引验证

```sql
-- 检查索引是否存在
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'bookmarks'
AND indexname LIKE '%userId_createdAt%';
```

### 3. 限流功能验证（需先启用）

```bash
# 设置环境变量
export RATE_LIMIT_ENABLED=true
export RATE_LIMIT_MAX_REQUESTS=3

# 快速连续调用点赞API超过3次
# 应收到 429 Too Many Requests 响应
```

### 4. 审计日志验证

```bash
# 执行收藏操作后检查日志
tail -f logs/audit-*.log | grep bookmarks
# 应看到包含IP、UA等信息的审计记录
```

## 注意事项

1. **生产环境部署**:
   - 先应用数据库迁移，再部署代码变更
   - 确认 Supabase 环境变量正确配置
   - 限流功能建议先在测试环境验证后再启用

2. **性能影响**:
   - 复合索引会略微增加写入开销，但显著提升查询性能
   - 限流功能使用内存存储，对性能影响极小

3. **向后兼容性**:
   - API 响应格式保持不变
   - 前端组件接口未改变
   - 数据库变更为增量式，不影响现有数据

## 5. Like 表游标分页索引优化（2025-09-21）

### 问题分析

Like 表的游标分页查询存在性能问题：

**原始索引设计**：

```sql
CREATE INDEX "likes_createdAt_id_idx" ON likes (createdAt DESC, id DESC);
```

**实际查询模式**：

```sql
WHERE postId = ? ORDER BY createdAt DESC, id DESC
WHERE activityId = ? ORDER BY createdAt DESC, id DESC
```

问题：索引第一列是 `createdAt`，但 WHERE 条件是 `postId` 或
`activityId`，导致无法有效利用索引，查询退化为全表扫描。

### 解决方案

#### Prisma Schema 更新

```prisma
model Like {
  // 复合索引：支持基于 postId 的游标分页查询
  @@index([postId, createdAt(sort: Desc), id(sort: Desc)])

  // 复合索引：支持基于 activityId 的游标分页查询
  @@index([activityId, createdAt(sort: Desc), id(sort: Desc)])

  // 用户点赞记录查询
  @@index([authorId])
}
```

#### 数据库迁移

迁移文件：`20250921211454_optimize_like_cursor_indexes.sql`

- 删除旧的无效索引
- 创建 `postId + createdAt + id` 复合索引
- 创建 `activityId + createdAt + id` 复合索引
- 使用 WHERE 子句过滤 NULL 值，减少索引大小

### 性能优化效果

- **优化前**：全表扫描，性能随数据量线性下降
- **优化后**：索引覆盖扫描，性能与数据量呈对数关系

### 部署步骤

```bash
# 1. 生成 Prisma 客户端
pnpm prisma generate

# 2. 应用数据库迁移
supabase migration up  # 或使用 psql 直接执行

# 3. 验证索引使用
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM likes
WHERE "postId" = 'xxx'
ORDER BY "createdAt" DESC, id DESC
LIMIT 10;
```

### 验证结果

✅ 所有 likes-service 单元测试通过（22/22）✅ 游标分页功能正常工作 ✅ 点赞/取消点赞功能无回归

## 相关文档

- [Phase 7 点赞与收藏实现](./Phase7-点赞与收藏-实现报告.md)
- [架构补救计划](../Architecture-Remediation-Plan-Phase6-8.md)
