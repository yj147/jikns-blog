# M4 T22 上线前检查清单（关注系统 Phase 9）

版本: v1.0 日期: 2025-10-09 范围: 关注系统（Follow）

## 1. 功能与契约

- [x] API 契约对齐设计文档
  - [x] GET /api/users/[userId]/followers → createPaginatedResponse +
        meta.requestId
  - [x] GET /api/users/[userId]/following → createPaginatedResponse +
        meta.requestId
  - [x] POST /api/users/follow/status → 返回 map: `{ [userId]: boolean }`
- [x] Hook/组件对齐
  - [x] useFollowStatusBatch 解析 map
  - [x] FollowButton 状态/回滚/错误提示

## 2. 认证与授权

- [x] assertPolicy("public"): followers/following 列表
- [x] assertPolicy("user-active"): follow/unfollow、follow/status
- [x] 禁止自关注/封禁用户控制

## 3. 速率限制与防滥用

- [x] follow 写操作: 30/min
- [x] follow-status 批量: 20/min
- [x] read 列表: 100/min
- [x] 限流命中指标: FOLLOW_ACTION_RATE_LIMIT

## 4. 审计与可观测性

- [x] 审计字段: requestId, userId, action, resource, success, severity, details,
      ipAddress, userAgent
- [x] 性能指标
  - [x] FOLLOW_ACTION_DURATION（follow/unfollow/status）
  - [x] FEED_FOLLOWING_RESULT_COUNT（列表）
- [x] requestId 透传至响应 meta

## 5. 数据与分页

- [x] 游标分页: limit≤50, nextCursor/hasMore 语义正确
- [x] T9 批量上限≤50, 验证错误返回 422/400

## 6. 测试与质量

- [x] 单元/集成: 关注系统相关用例全绿
- [x] E2E: 暂缓（按指令），不阻塞上线评审
- [x] 质量检查: 仓库级存在历史 lint 错误（与本改动无关）

## 7. 配置与 Flag

- [x] FEATURE_FEED_FOLLOWING_STRICT 已接入（Following Tab gating）
- [ ] feature CLI/脚本（未来完善）

## 8. 依赖与环境

- [x] 不新增运行时外部依赖
- [x] 数据库迁移：无新增 schema 变更

## 9. 回归风险与验证

- [x] T9 从 array→map：前端 Hook 已适配；页面逻辑不依赖 isMutual（来自列表 API）
- [x] 关注/取关后状态刷新：已验证（Hook 测试）

## 结论

- 结论：通过（可进入 M4 后续项）
- 备注：仓库级 quality:check 存在历史解析错误，需在全仓层面另行修复。
