# M4 T27 回滚预案（关注系统 Phase 9）

版本: v1.0 日期: 2025-10-09

## 1. 回滚触发条件（任一）

- 关键监控越阈：
  - FOLLOW_ACTION_DURATION P95 > 500ms 持续 10 分钟
  - API 5xx 比例 > 0.5% 持续 10 分钟
  - FOLLOW_ACTION_RATE_LIMIT 触发率 > 5%/min 持续 10 分钟
- 大量用户报错/投诉（>10 条/10 分钟）
- 数据不一致：关注状态异常（无法关注/取关、状态不同步）

## 2. 回滚步骤（优先级）

1. 立即关闭 Feature Flag：
   - FEATURE_FEED_FOLLOWING_STRICT=off（下掉 Following Tab）
2. 限流保护（可选）：
   - 降低 follow-status 配额（由 20/min → 10/min）
3. 后端回退：
   - 回退至上一个已知稳定版本（CI 构建号 / 标签）
   - 若仅 T9 出现问题，可临时降级接口为 array 版本（应急开关）
4. 观测与验证：
   - 5 分钟窗口：成功率、P95、告警趋势恢复
   - 手动脚本：登录→关注→取关→列表刷新

## 3. 数据与配置

- 本阶段不涉及 DB schema 变更，无需数据库回滚
- 仅需调整环境变量 / Feature Flag / 速率限制配置

## 4. 复盘与修复

- 收集审计与指标样本，定位瓶颈（DB 查询、缓存、网络）
- 编写复盘报告，明确根因与永久修复项
- 在灰度环境复测通过后再恢复流量

## 5. 通知与记录

- 在 #engineering、#oncall 同步状态与ETA
- 记录操作人、时间、变更项、监控截图与结果
