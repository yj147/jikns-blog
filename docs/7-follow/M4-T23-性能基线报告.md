# M4 T23 性能基线验证报告（关注系统 Phase 9）

版本: v1.0 日期: 2025-10-09

## 1. 目标与口径

- T9（批量状态查询）：50 个 ID 查询 < 100ms（路由层处理时间，不含网络）
- 列表 API：P95 < 400ms；吞吐量 > 50 req/s（参考项目通用阈值）
- 速率限制：命中时正确返回 429，并记录 FOLLOW_ACTION_RATE_LIMIT

## 2. 方法

- 单元/集成层验证：Vitest 路由/服务用例，覆盖所有成功/失败/限流分支。
- 轻量基准（开发机）：对 `POST /api/users/follow/status` 的路由函数进行 50
  ID 输入的测量（mock Prisma），观察处理耗时。
- 注意：未启动完整 Next 服务器，端到端（网络+DB）基线将在联调/灰度中补充。

## 3. 结果（开发机）

- 路由函数（mock I/O）平均耗时：~7–12ms/次（50 ID）
- 速率限制分支：正确返回 429，指标记录正常（在 API 测试日志中可见 WARN:
  RATE_LIMIT_EXCEEDED）。
- 列表 API：维持既有性能特征（本轮未改动查询逻辑）。

## 4. 结论

- T9 目标（50 ID < 100ms）在路由函数层面达成。
- 端到端目标需在灰度环境进一步度量（含真实 DB）。

## 5. 后续度量计划（灰度）

- 在 `pnpm dev` + 本地 Supabase 环境下，运行
  `scripts/collect-monitoring-data.sh --focus follow` 收集 30 分钟窗口数据：
  - FOLLOW_ACTION_DURATION：avg/P95
  - FOLLOW_ACTION_RATE_LIMIT：每分钟命中数
  - FEED_FOLLOWING_RESULT_COUNT：结果分布
- 并发校验：10 并发 \* 100 请求，对比成功率 ≥95%、P95 ≤ 400ms。

## 6. 优化建议（如未达标）

- 为 `follows(followerId, followingId)`/`(followerId, createdAt)` 补充复合索引
- 限制一次批量 ID ≤ 50，并引导前端合并请求
- 命中率高时在接口层增加缓存（短 TTL）或前端缓存
