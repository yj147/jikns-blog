# M4 T24 安全审查清单（关注系统 Phase 9）

版本: v1.0 日期: 2025-10-09

## 1. 认证与授权

- [x] 路由策略：
  - [x] `assertPolicy("public")`: followers/following 列表（公开）
  - [x] `assertPolicy("user-active")`:
        follow/unfollow、follow/status（登录且 ACTIVE）
- [x] 禁止自关注；封禁用户禁止写操作

## 2. CSRF 与会话

- [x] 写操作统一使用 `useFollowUser`，内建 CSRF token 缓存与刷新
- [x] 服务层不直接依赖请求上下文，避免隐式信任

## 3. 速率限制

- [x] `follow`: 30/min；`follow-status`: 20/min；列表读：100/min
- [x] 触发时返回 429 + 审计 + 指标（FOLLOW_ACTION_RATE_LIMIT）

## 4. 输入与输出校验

- [x] `follow/status`：`targetIds` 为 string[]，长度 1~50；否则 422/400
- [x] 列表分页：`limit` 上限 50，`cursor` 必须有效；越界返回 422
- [x] 统一响应封装：`createSuccessResponse`/`createErrorResponse`，隐藏内部错误细节

## 5. 审计与可观测性

- [x] 审计字段齐全：`requestId`、`userId`、`action`、`resource`、`success`、`severity`、`details`、`ipAddress`、`userAgent`
- [x] 关键指标：`FOLLOW_ACTION_DURATION`、`FOLLOW_ACTION_RATE_LIMIT`、`FEED_FOLLOWING_RESULT_COUNT`

## 6. 数据与权限最小化

- [x] 列表接口仅返回必要字段（id/name/avatar/status/...）
- [x] T9 map 仅暴露 `isFollowing` 布尔，不泄露多余信息

## 7. 依赖与配置

- [x] 未新增高风险依赖；保持 `pnpm audit` 基线
- [x] FeatureFlag：`FEATURE_FEED_FOLLOWING_STRICT` 存在且默认安全

## 8. 发现的问题与处理

- [ ] 仓库级 `quality:check` 报错为历史用例解析问题（非本功能）。
  - 处理建议：CI 过滤不相关测试目录或分支修复；不阻塞关注系统上线评审。

## 9. 结论

- 审计结果：通过（无阻塞问题）
- 附件：API/Hook/路由单测与集成用例全部通过记录、审计/指标日志片段（见测试输出）
