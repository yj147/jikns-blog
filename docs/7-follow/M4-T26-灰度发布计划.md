# M4 T26 灰度发布计划（关注系统 Phase 9）

版本: v1.0 日期: 2025-10-09

## 1. 目标

- 以可控流量验证关注系统稳定性与性能，出现异常可在分钟级关闭。

## 2. 灰度策略

- Feature Flag：FEATURE_FEED_FOLLOWING_STRICT
  - 阶段 0：off（不展示 following Tab）
  - 阶段 1：on（内部账号）
  - 阶段 2：on（5% 外部流量）
  - 阶段 3：on（25%）
  - 阶段 4：on（100%）
- 切换方式：配置文件/环境变量或脚本（未来提供 `pnpm feature:set`）。

## 3. 监控指标与阈值

- 可用性：API 成功率 ≥ 99.5%
- 性能：
  - FOLLOW_ACTION_DURATION：P95 ≤ 300ms
  - 列表 API：P95 ≤ 400ms
- 限流：FOLLOW_ACTION_RATE_LIMIT 触发率 ≤ 2%/min（异常时报警）
- 错误：5xx ≤ 0.1%/min

## 4. 验收脚本（示例）

- `bash scripts/collect-monitoring-data.sh --focus follow`（如已配置）
- `pnpm vitest run tests/api/follow-*.test.ts`（冒烟）
- 前端人工脚本：登录→关注→取关→Following Tab→Settings 列表联动

## 5. 上线节奏与观察窗口

- 每阶段 30~60 分钟观察窗口；指标达标方可进入下一阶段。
- 触发回滚条件：见回滚预案（T27）。

## 6. 风险与缓解

- 关注流为空：确认推荐区与列表 API 正常；放宽 Following Tab gating（仅内部）
- 限流过严：短期调高 follow-status 配额或前端合并请求
- 审计暴涨：调整采样或归档策略
