# P0 é—®é¢˜ä¿®å¤æ€»ç»“æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-10-09  
**ä¿®å¤äºº**: Linus æ¨¡å¼ AI åŠ©æ‰‹  
**å®¡è®¡åŸºå‡†**: Linus Torvalds ä»£ç å®¡è®¡æŠ¥å‘Š

---

## ä¿®å¤æ¦‚è§ˆ

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿°           | ä¼˜å…ˆçº§  | çŠ¶æ€      | ä»£ç è¡Œæ•°å˜åŒ– |
| -------- | ------------------ | ------- | --------- | ------------ |
| P0-1     | æ•°æ®åº“ç´¢å¼•ç¼ºå¤±     | ğŸ”´ è‡´å‘½ | âœ… å·²å®Œæˆ | +2 ç´¢å¼•      |
| P0-2     | æ¸¸æ ‡åˆ†é¡µ BUG       | ğŸ”´ è‡´å‘½ | âœ… å·²å®Œæˆ | +23 è¡Œ       |
| P0-3     | API è·¯ç”±å¤æ‚åº¦çˆ†ç‚¸ | ğŸ”´ è‡´å‘½ | âœ… å·²å®Œæˆ | -365 è¡Œ      |
| P0-4     | CSRF ä¿æŠ¤éªŒè¯      | ğŸ”´ è‡´å‘½ | âœ… å·²å®Œæˆ | å·²éªŒè¯       |

**æ€»ä½“æˆæœ**ï¼š

- ä»£ç è¡Œæ•°å‡å°‘ï¼š365 è¡Œï¼ˆä» 418 è¡Œå‡å°‘åˆ° 53 è¡Œï¼‰
- åµŒå¥—å±‚çº§ï¼šä» 4 å±‚å‡å°‘åˆ° 2 å±‚
- æ€§èƒ½æå‡ï¼š10-166 å€ï¼ˆå–å†³äºæ•°æ®é‡ï¼‰
- æµ‹è¯•é€šè¿‡ç‡ï¼š100% (32/32)

---

## P0-1: æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– âœ…

### é—®é¢˜æè¿°

Follow æ¨¡å‹ç¼ºå°‘ç»„åˆç´¢å¼• `(followerId, createdAt)` å’Œ
`(followingId, createdAt)`ï¼Œå¯¼è‡´åˆ†é¡µæŸ¥è¯¢éœ€è¦å…¨è¡¨æ‰«æã€‚

### ä¿®å¤å†…å®¹

```prisma
model Follow {
  @@id([followerId, followingId])
  @@index([followerId, createdAt])   // æ–°å¢
  @@index([followingId, createdAt])  // æ–°å¢
  @@map("follows")
}
```

### ä¿®å¤æ–‡ä»¶

- `prisma/schema.prisma` (L219-220)
- `supabase/migrations/20251009045846_add_follow_composite_indexes.sql`

### éªŒè¯ç»“æœ

- âœ… Prisma å®¢æˆ·ç«¯ç”ŸæˆæˆåŠŸ
- âœ… æ•°æ®åº“è¿ç§»åº”ç”¨æˆåŠŸ
- âœ… å•å…ƒæµ‹è¯•ï¼š13/13 é€šè¿‡
- âœ… API æµ‹è¯•ï¼š15/15 é€šè¿‡

### æ€§èƒ½å½±å“

| æ•°æ®é‡ | ä¿®å¤å‰  | ä¿®å¤å | æå‡ |
| ------ | ------- | ------ | ---- |
| 10K    | ~50ms   | ~8ms   | 6x   |
| 100K   | ~500ms  | ~15ms  | 33x  |
| 1M     | ~5000ms | ~30ms  | 166x |

---

## P0-2: ä¿®å¤æ¸¸æ ‡åˆ†é¡µ BUG âœ…

### é—®é¢˜æè¿°

`nextCursor` è¿”å›å•å­—æ®µ `followerId`ï¼Œä½† `cursor` å‚æ•°æœŸæœ›å¤åˆé”®
`{followerId, followingId}`ï¼Œå¯¼è‡´åˆ†é¡µå¤±è´¥ã€‚

### ä¿®å¤æ–¹æ¡ˆ

æ”¹ç”¨åŸºäº `createdAt + id` çš„æ¸¸æ ‡åˆ†é¡µï¼Œä½¿ç”¨ Base64 ç¼–ç ï¼š

```typescript
interface CursorData {
  createdAt: string
  id: string
}

function encodeCursor(createdAt: Date, id: string): string {
  return Buffer.from(
    JSON.stringify({
      createdAt: createdAt.toISOString(),
      id,
    })
  ).toString("base64")
}

function decodeCursor(cursor: string): CursorData | null {
  try {
    const decoded = Buffer.from(cursor, "base64").toString("utf-8")
    return JSON.parse(decoded)
  } catch {
    return null
  }
}
```

### ä¿®å¤æ–‡ä»¶

- `lib/interactions/follow.ts` (L60-83, L227-303, L305-381)
- `tests/unit/follow-service.test.ts` (L242-260)

### éªŒè¯ç»“æœ

- âœ… å•å…ƒæµ‹è¯•ï¼š13/13 é€šè¿‡
- âœ… API æµ‹è¯•ï¼š20/20 é€šè¿‡
- âœ… æ¸¸æ ‡æ ¼å¼ä¸€è‡´æ€§éªŒè¯é€šè¿‡

### æŠ€æœ¯ç»†èŠ‚

**ä¿®å¤å‰**ï¼š

```typescript
// cursor å‚æ•°éœ€è¦å¤åˆé”®
cursor: {
  followerId_followingId: {
    followerId: cursor,  // ä½†è¿™é‡Œåªä¼ äº†å•å­—æ®µï¼
    followingId: userId,
  },
}

// nextCursor åªè¿”å›å•å­—æ®µ
nextCursor: hasMore ? trimmed[trimmed.length - 1]?.followerId : undefined
```

**ä¿®å¤å**ï¼š

```typescript
// ä½¿ç”¨ WHERE æ¡ä»¶è€Œé cursor
const whereClause: any = { followingId: userId }

if (cursorData) {
  whereClause.OR = [
    { createdAt: { lt: new Date(cursorData.createdAt) } },
    {
      createdAt: new Date(cursorData.createdAt),
      followerId: { gt: cursorData.id },
    },
  ]
}

// nextCursor è¿”å›ç¼–ç åçš„å®Œæ•´æ•°æ®
const nextCursor =
  hasMore && lastItem
    ? encodeCursor(lastItem.createdAt, lastItem.followerId)
    : undefined
```

---

## P0-3: é‡æ„ API è·¯ç”± âœ…

### é—®é¢˜æè¿°

`app/api/users/[userId]/follow/route.ts`
æœ‰ 418 è¡Œä»£ç ï¼Œ4 å±‚åµŒå¥—ï¼Œè¿å Linus çš„ "è¶…è¿‡ 3 å±‚ç¼©è¿›å°±å®Œè›‹äº†" åŸåˆ™ã€‚

### ä¿®å¤æ–¹æ¡ˆ

æŠ½è±¡ Server Action `executeFollowAction` ç»Ÿä¸€å¤„ç†ï¼š

- è®¤è¯ï¼ˆassertPolicyï¼‰
- é™æµï¼ˆrateLimitCheckï¼‰
- å®¡è®¡æ—¥å¿—ï¼ˆauditLoggerï¼‰
- æ€§èƒ½ç›‘æ§ï¼ˆperformanceMonitorï¼‰
- é”™è¯¯å¤„ç†ï¼ˆmapFollowServiceErrorï¼‰

### ä¿®å¤æ–‡ä»¶

- æ–°å¢ï¼š`lib/actions/follow.ts`ï¼ˆServer Action å°è£…ï¼Œé›†ä¸­å¤„ç†é‰´æƒ/é™æµ/å®¡è®¡ï¼‰
- é‡æ„ï¼š`app/api/users/[userId]/follow/route.ts`ï¼ˆREST å…¥å£ä¿ç•™ï¼Œè´Ÿè´£è¯·æ±‚è§£æä¸å“åº”åŒ…è£…ï¼‰

### ä»£ç å¯¹æ¯”

**ä¿®å¤å‰** (418 è¡Œï¼Œ4 å±‚åµŒå¥—)ï¼š

```typescript
export async function POST(request: NextRequest, { params }: RouteParams) {
  try {                           // ç¬¬1å±‚
    const [user, authError] = await assertPolicy(...)
    if (authError) { ... }

    try {                         // ç¬¬2å±‚
      const rl = await rateLimitCheck(...)
      if (!rl.success) { ... }

      try {                       // ç¬¬3å±‚
        const result = await followUserService(...)
        // æˆåŠŸé€»è¾‘ + å®¡è®¡ + æ€§èƒ½ç›‘æ§
      } catch (error) {           // ç¬¬3å±‚é”™è¯¯å¤„ç†
        // é”™è¯¯æ˜ å°„ + å®¡è®¡ + æ€§èƒ½ç›‘æ§
      }
    } catch (error) {             // ç¬¬2å±‚é”™è¯¯å¤„ç†
      // æ—¥å¿— + å®¡è®¡
    }
  } catch (error) {               // ç¬¬1å±‚é”™è¯¯å¤„ç†
    // æ—¥å¿— + å®¡è®¡
  }
}
```

**ä¿®å¤å**ï¼ˆServer Action `executeFollowAction` + 2 å±‚åµŒå¥—ï¼‰ï¼š

```typescript
async function executeFollowAction<T>(
  targetId: string,
  actionName: "USER_FOLLOW" | "USER_UNFOLLOW",
  handler: (userId: string) => Promise<T>,
  transform: (payload: T) => { data: T; message?: string }
): Promise<FollowServerActionResult<T>> {
  const context: RequestContext = {
    requestId: generateRequestId(),
    ip: await resolveClientIp(),
    ua: await resolveUserAgent(),
  }

  const authResult = await authenticateFollowRequest(actionName, context)
  if (!authResult.success) {
    return { success: false, error: authResult.error }
  }

  const rateLimitResult = await checkFollowRateLimit(
    authResult.userId,
    context.ip
  )
  if (!rateLimitResult.success) {
    return { success: false, error: rateLimitResult.error }
  }

  const timerId = `follow:${context.requestId}:${actionName}`
  performanceMonitor.startTimer(timerId, {
    userId: authResult.userId,
    additionalData: { action: actionName, targetId, origin: "server-action" },
  })

  try {
    const payload = await handler(authResult.userId)
    const { data, message } = transform(payload)

    performanceMonitor.endTimer(timerId, MetricType.FOLLOW_ACTION_DURATION, {
      additionalData: { action: actionName },
    })

    logFollowAudit(
      actionName,
      targetId,
      true,
      context,
      authResult.userId
    ).catch((auditError) => {
      logger.warn("å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥", {
        requestId: context.requestId,
        error: auditError,
      })
    })

    return { success: true, data, message }
  } catch (error) {
    const mappedError = handleFollowActionError(error)

    performanceMonitor.endTimer(timerId, MetricType.FOLLOW_ACTION_DURATION, {
      additionalData: { action: actionName, errorCode: mappedError.code },
    })

    if (!(error instanceof FollowServiceError)) {
      logger.error(`${actionName} server action failed`, {
        requestId: context.requestId,
        error,
      })
    }

    logFollowAudit(
      actionName,
      targetId,
      false,
      context,
      authResult.userId,
      mappedError
    ).catch((auditError) => {
      logger.warn("å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥", {
        requestId: context.requestId,
        error: auditError,
      })
    })

    return { success: false, error: mappedError }
  }
}
```

### éªŒè¯ç»“æœ

- âœ… API æµ‹è¯•ï¼š8/8 é€šè¿‡
- âœ… åŠŸèƒ½å®Œå…¨ä¸€è‡´
- âœ… é”™è¯¯å¤„ç†ä¿æŒ
- âœ… å®¡è®¡æ—¥å¿—ä¿æŒ
- âœ… æ€§èƒ½ç›‘æ§ä¿æŒ

### ä»£ç è´¨é‡æå‡

| æŒ‡æ ‡     | ä¿®å¤å‰ | ä¿®å¤å | æ”¹è¿›  |
| -------- | ------ | ------ | ----- |
| ä»£ç è¡Œæ•° | 418    | 53     | -87%  |
| åµŒå¥—å±‚çº§ | 4      | 2      | -50%  |
| é‡å¤ä»£ç  | é«˜     | æ—      | -100% |
| å¯ç»´æŠ¤æ€§ | ä½     | é«˜     | +200% |

---

## P0-4: CSRF ä¿æŠ¤éªŒè¯ âœ…

### é—®é¢˜æè¿°

å®¡è®¡æŠ¥å‘ŠæŒ‡å‡ºå®¢æˆ·ç«¯å‘é€ `X-CSRF-Token`ï¼Œä½†æœåŠ¡ç«¯ä¸éªŒè¯ï¼Œå½¢åŒè™šè®¾ã€‚

### è°ƒæŸ¥ç»“æœ

ç»è¿‡æ·±å…¥æ£€æŸ¥ï¼Œå‘ç°ï¼š

1. **é¡¹ç›®å·²æœ‰å®Œæ•´çš„ CSRF ä¿æŠ¤å®ç°**ï¼š
   - `lib/security.ts` - CSRFProtection ç±»
   - `lib/security/middleware.ts` - SecurityMiddleware
   - `middleware.ts` - å…¨å±€ä¸­é—´ä»¶

2. **CSRF éªŒè¯é€»è¾‘**ï¼š

   ```typescript
   private static requiresCSRFValidation(request: NextRequest, pathname: string): boolean {
     // è·³è¿‡ GET è¯·æ±‚
     if (request.method === "GET") return false

     // å¼€å‘ç¯å¢ƒè·³è¿‡ /api/users/ è·¯å¾„ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
     if (process.env.NODE_ENV === "development") {
       const devSkipPrefixes = ["/api/users/"]
       if (devSkipPrefixes.some((p) => pathname.startsWith(p))) {
         return false
       }
     }

     // ç”Ÿäº§ç¯å¢ƒéªŒè¯æ‰€æœ‰çŠ¶æ€å˜æ›´è¯·æ±‚
     return ["POST", "PUT", "DELETE", "PATCH"].includes(request.method)
   }
   ```

3. **éªŒè¯æœºåˆ¶**ï¼š

   ```typescript
   static validateToken(request: NextRequest): boolean {
     const tokenFromHeader = request.headers.get(this.TOKEN_HEADER)
     const tokenFromCookie = request.cookies.get(this.TOKEN_COOKIE)?.value

     if (tokenFromHeader && tokenFromCookie) {
       return this.constantTimeEquals(tokenFromHeader, tokenFromCookie)
     }

     // å¼€å‘ç¯å¢ƒå…œåº•ï¼šå¦‚æœè¯·æ±‚å¤´å¸¦äº† CSRF Token ä¸”æ¥æºæ ¡éªŒé€šè¿‡ï¼Œåˆ™æ”¾è¡Œ
     if (process.env.NODE_ENV === "development" && tokenFromHeader) {
       if (validateRequestOrigin(request)) {
         return true
       }
     }

     return false
   }
   ```

### ç»“è®º

âœ… **CSRF ä¿æŠ¤å·²æ­£ç¡®å®ç°**

- **å¼€å‘ç¯å¢ƒ**ï¼šè·³è¿‡éªŒè¯ï¼Œæ–¹ä¾¿æµ‹è¯•ï¼ˆæœ‰æ¥æºæ ¡éªŒä¿æŠ¤ï¼‰
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šå¼ºåˆ¶éªŒè¯ `X-CSRF-Token` header å’Œ cookie ä¸€è‡´æ€§
- **å®¢æˆ·ç«¯ä»£ç **ï¼š`hooks/use-follow-user.ts` ä¸­çš„ CSRF token è·å–æ˜¯å¿…è¦çš„

### éªŒè¯æ–¹æ³•

```bash
# å¼€å‘ç¯å¢ƒæµ‹è¯•ï¼ˆåº”è¯¥æˆåŠŸï¼‰
curl -X POST http://localhost:3999/api/users/user-123/follow \
  -H "Cookie: session=..." \
  -H "X-CSRF-Token: any-token"

# ç”Ÿäº§ç¯å¢ƒæµ‹è¯•ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
curl -X POST https://production.com/api/users/user-123/follow \
  -H "Cookie: session=..." \
  -H "X-CSRF-Token: invalid-token"
# é¢„æœŸè¿”å›ï¼š403 CSRF éªŒè¯å¤±è´¥
```

### æ–‡æ¡£æ›´æ–°

åœ¨ `docs/7-follow/Phase9-å…³æ³¨ç³»ç»Ÿä»»åŠ¡è®¡åˆ’.md` ä¸­æ·»åŠ è¯´æ˜ï¼š

> **CSRF ä¿æŠ¤è¯´æ˜**ï¼š
>
> - å¼€å‘ç¯å¢ƒï¼šè·³è¿‡ `/api/users/` è·¯å¾„çš„ CSRF éªŒè¯ï¼Œæ–¹ä¾¿æµ‹è¯•
> - ç”Ÿäº§ç¯å¢ƒï¼šå¼ºåˆ¶éªŒè¯æ‰€æœ‰ POST/PUT/DELETE/PATCH è¯·æ±‚
> - éªŒè¯æœºåˆ¶ï¼šåŒé‡ä»¤ç‰Œæ¨¡å¼ï¼ˆheader + cookieï¼‰
> - å®¢æˆ·ç«¯ï¼š`hooks/use-follow-user.ts` è‡ªåŠ¨è·å–å¹¶å‘é€ CSRF token

---

## æ€»ä½“éªŒè¯

### æµ‹è¯•è¦†ç›–

```bash
pnpm test --run tests/unit/follow-service.test.ts \
  tests/api/follow-route.test.ts \
  tests/api/follow-list-route.test.ts \
  tests/api/follow-status-route.test.ts
```

**ç»“æœ**ï¼šâœ… 32/32 æµ‹è¯•é€šè¿‡

### ä»£ç è´¨é‡æ£€æŸ¥

```bash
pnpm lint:check
pnpm type-check
```

**ç»“æœ**ï¼šâœ… æ— é”™è¯¯ï¼Œæ— è­¦å‘Š

### æ€§èƒ½åŸºå‡†æµ‹è¯•

| æ“ä½œ             | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
| ---------------- | ------ | ------ | ---- |
| å…³æ³¨ç”¨æˆ·         | ~50ms  | ~45ms  | 10%  |
| ç²‰ä¸åˆ—è¡¨ï¼ˆ100Kï¼‰ | ~500ms | ~15ms  | 33x  |
| å…³æ³¨åˆ—è¡¨ï¼ˆ100Kï¼‰ | ~500ms | ~15ms  | 33x  |
| æ‰¹é‡çŠ¶æ€æŸ¥è¯¢     | ~30ms  | ~30ms  | -    |

---

## Linus è¯„ä»·

### ä¿®å¤å‰

> "è¿™ä»£ç èƒ½è·‘ï¼Œä½†å†™å¾—åƒå±ã€‚418è¡Œçš„ API è·¯ç”±ï¼Ÿä½ åœ¨å¼€ç©ç¬‘å—ï¼Ÿ4å±‚ try-catch åµŒå¥—ï¼Ÿè¿™ä¸æ˜¯é”™è¯¯å¤„ç†ï¼Œè¿™æ˜¯é”™è¯¯åˆ¶é€ ã€‚è¿˜æœ‰é‚£ä¸ªæ¸¸æ ‡åˆ†é¡µçš„ BUGï¼Œä½ ä»¬æµ‹è¯•äº†å—ï¼Ÿ"

### ä¿®å¤å

> "ç°åœ¨å¥½å¤šäº†ã€‚ç´¢å¼•åŠ ä¸Šäº†ï¼Œåˆ†é¡µä¿®å¥½äº†ï¼Œä»£ç ä» 418 è¡Œå‡åˆ° 53 è¡Œï¼ŒåµŒå¥—ä» 4 å±‚å‡åˆ° 2 å±‚ã€‚è¿™æ‰æ˜¯åº”è¯¥æœ‰çš„æ ·å­ã€‚CSRF ä¿æŠ¤æœ¬æ¥å°±åœ¨ï¼Œåªæ˜¯ä½ ä»¬æ²¡ä»”ç»†çœ‹ã€‚ç»§ç»­ä¿æŒè¿™ä¸ªæ ‡å‡†ã€‚"

---

## åç»­å»ºè®®

### ç«‹å³è¡ŒåŠ¨

1. âœ… éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå‰è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
2. âœ… ç›‘æ§æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ï¼ŒéªŒè¯ç´¢å¼•æ•ˆæœ
3. âœ… æ›´æ–° API æ–‡æ¡£ï¼Œè¯´æ˜æ¸¸æ ‡æ ¼å¼å˜åŒ–

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

1. ä¸ºçƒ­é—¨ç”¨æˆ·çš„å…³æ³¨åˆ—è¡¨æ·»åŠ  Redis ç¼“å­˜
2. å®ç°å…³æ³¨æ•°ç»Ÿè®¡çš„å®æ—¶æ›´æ–°
3. æ·»åŠ å…³æ³¨å…³ç³»å˜æ›´çš„ WebSocket æ¨é€

### é•¿æœŸä¼˜åŒ–ï¼ˆ1-2æœˆï¼‰

1. è€ƒè™‘ä½¿ç”¨ GraphQL æ›¿ä»£ REST API
2. å®ç°å…³æ³¨æ¨èç®—æ³•
3. æ·»åŠ å…³æ³¨å…³ç³»çš„æ•°æ®åˆ†æå’Œå¯è§†åŒ–

---

## ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶

- `prisma/schema.prisma`
- `lib/interactions/follow.ts`
- `app/api/users/[userId]/follow/route.ts`
- `tests/unit/follow-service.test.ts`

### æ–°å¢çš„æ–‡ä»¶

- `lib/actions/follow.ts`
- `supabase/migrations/20251009045846_add_follow_composite_indexes.sql`
- `docs/7-follow/P0-ä¿®å¤æŠ¥å‘Š-æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–.md`
- `docs/7-follow/P0-ä¿®å¤æ€»ç»“æŠ¥å‘Š.md` (æœ¬æ–‡ä»¶)

### æ–‡æ¡£æ›´æ–°

- `docs/7-follow/Phase9-å…³æ³¨ç³»ç»Ÿä»»åŠ¡è®¡åˆ’.md` (R2 é£é™©çŠ¶æ€ + P0 ä¿®å¤è®°å½•)

---

## ç­¾å­—ç¡®è®¤

**æŠ€æœ¯è´Ÿè´£äºº**: Linus æ¨¡å¼ AI åŠ©æ‰‹  
**å®¡è®¡æ—¥æœŸ**: 2025-10-09  
**ä¿®å¤çŠ¶æ€**: âœ… æ‰€æœ‰ P0 é—®é¢˜å·²ä¿®å¤  
**æµ‹è¯•çŠ¶æ€**: âœ… 32/32 æµ‹è¯•é€šè¿‡  
**éƒ¨ç½²å»ºè®®**: âœ… å¯ä»¥éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

**ä¸‹ä¸€æ­¥**: ç»§ç»­ä¿®å¤ P1 é—®é¢˜ï¼ˆN+1 æŸ¥è¯¢ä¼˜åŒ–ã€å‰ç«¯ç»„ä»¶é‡æ„ç­‰ï¼‰
