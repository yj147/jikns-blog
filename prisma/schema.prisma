generator client {
  provider      = "prisma-client-js"
  output        = "../lib/generated/prisma"
  binaryTargets = ["native"]
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Activity {
  @@map("activities")

  id            String     @id @default(uuid())
  content       String
  contentTokens String?
  imageUrls     String[]   @default([])
  search_vector Unsupported("tsvector")?
  isPinned      Boolean    @default(false)
  deletedAt     DateTime?
  likesCount    Int        @default(0)
  commentsCount Int        @default(0)
  viewsCount    Int        @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  authorId      String     @db.Uuid

  author        User                     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  tagCandidates ActivityTagCandidate[]
  tags          ActivityTag[]
  comments      Comment[]
  likes         Like[]

  @@index([authorId])
  @@index([createdAt(sort: Desc)])
  @@index([deletedAt, createdAt(sort: Desc)])
}

model ActivityTagCandidate {
  @@map("activity_tag_candidates")

  id                 String   @id @default(uuid())
  name               String
  slug               String   @unique
  occurrences        Int      @default(1)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  lastSeenAt         DateTime @default(now())
  lastSeenActivityId String?

  activity Activity? @relation(fields: [lastSeenActivityId], references: [id])

  @@index([lastSeenAt(sort: Desc)])
}

model ActivityTag {
  @@map("activity_tags")

  activityId String
  tagId      String
  createdAt  DateTime @default(now())

  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([activityId, tagId])
}

model Bookmark {
  @@map("bookmarks")

  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  userId    String   @db.Uuid
  postId    String

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
}

model Comment {
  @@map("comments")

  id         String    @id @default(uuid())
  content    String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  authorId   String    @db.Uuid
  postId     String?
  activityId String?
  parentId   String?

  activity Activity? @relation(fields: [activityId], references: [id], onDelete: Cascade)
  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post     Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent   Comment?  @relation("commentsTocomments", fields: [parentId], references: [id], onDelete: NoAction)
  replies  Comment[] @relation("commentsTocomments")

  @@index([activityId])
  @@index([authorId])
  @@index([createdAt(sort: Desc)])
  @@index([deletedAt])
  @@index([parentId])
  @@index([postId])
}

model Follow {
  @@map("follows")

  followerId  String   @db.Uuid
  followingId String   @db.Uuid
  createdAt   DateTime @default(now())

  follower  User @relation("follows_followerIdTousers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("follows_followingIdTousers", fields: [followingId], references: [id], onDelete: Cascade)

  @@id([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Like {
  @@map("likes")

  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  authorId   String   @db.Uuid
  postId     String?
  activityId String?

  activity Activity? @relation(fields: [activityId], references: [id], onDelete: Cascade)
  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post     Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([authorId, activityId])
  @@unique([authorId, postId])
  @@index([activityId])
  @@index([authorId])
  @@index([postId])
}

model PostTag {
  @@map("post_tags")

  postId    String
  tagId     String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
}

model Post {
  @@map("posts")

  id                   String      @id @default(uuid())
  slug                 String      @unique
  title                String
  titleTokens          String?
  content              String
  contentTokens        String?
  excerpt              String?
  excerptTokens        String?
  search_vector        Unsupported("tsvector")?
  published            Boolean     @default(false)
  isPinned             Boolean     @default(false)
  canonicalUrl         String?
  seoTitle             String?
  seoDescription       String?
  seoDescriptionTokens String?
  viewCount            Int         @default(0)
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  publishedAt          DateTime?
  authorId             String      @db.Uuid
  seriesId             String?
  coverImage           String?

  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  series    Series?   @relation(fields: [seriesId], references: [id])
  tags      PostTag[]
  bookmarks Bookmark[]
  comments  Comment[]
  likes     Like[]

  @@index([authorId])
  @@index([published, publishedAt(sort: Desc)])
  @@index([seriesId])
}

model Series {
  @@map("series")

  id          String   @id
  title       String
  slug        String   @unique
  description String?
  coverUrl    String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  authorId    String   @db.Uuid

  author User  @relation(fields: [authorId], references: [id], onDelete: Cascade)
  posts  Post[]

  @@index([authorId])
}

model Tag {
  @@map("tags")

  id          String    @id @default(uuid())
  name        String    @unique @db.VarChar(50)
  slug        String    @unique @db.VarChar(50)
  description String?   @db.VarChar(200)
  color       String?   @db.VarChar(7)
  postsCount  Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  activities ActivityTag[]
  posts      PostTag[]

  @@index([postsCount(sort: Desc)])
}

model SystemSetting {
  @@map("system_settings")

  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedById String?  @db.Uuid

  updatedBy User? @relation(fields: [updatedById], references: [id], onDelete: SetNull)

  @@index([key])
}

model User {
  @@map("users")

  id        String    @id @db.Uuid @default(uuid())
  email     String    @unique
  name      String?
  avatarUrl String?
  bio       String?
  socialLinks Json?
  role      Role       @default(USER)
  status    UserStatus @default(ACTIVE)
  passwordHash String?
  createdAt DateTime   @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?

  activities  Activity[]
  bookmarks   Bookmark[]
  comments    Comment[]
  following   Follow[] @relation("follows_followerIdTousers")
  followers   Follow[] @relation("follows_followingIdTousers")
  likes       Like[]
  posts       Post[]
  series      Series[]
  systemSettings SystemSetting[]
}

enum Role {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  BANNED
}
