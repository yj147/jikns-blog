generator client {
  provider      = "prisma-client-js"
  output        = "../lib/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Activity {
  id            String                   @id @default(uuid())
  content       String
  isPinned      Boolean                  @default(false)
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt
  authorId      String
  commentsCount Int                      @default(0)
  deletedAt     DateTime?
  likesCount    Int                      @default(0)
  viewsCount    Int                      @default(0)
  imageUrls     String[]                 @default([])
  contentTokens String?
  search_vector Unsupported("tsvector")? @default(dbgenerated("setweight(to_tsvector('simple'::regconfig, COALESCE(\"contentTokens\", ''::text)), 'A'::\"char\")"))
  author        User                     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  tagCandidates ActivityTagCandidate[]
  tags          ActivityTag[]
  comments      Comment[]
  likes         Like[]
  notifications Notification[]

  @@index([createdAt(sort: Desc)])
  @@index([deletedAt, createdAt(sort: Desc)])
  @@index([authorId, createdAt(sort: Desc)])
  @@index([isPinned, createdAt(sort: Desc)])
  @@index([search_vector], type: Gin)
  @@map("activities")
}

model ActivityTagCandidate {
  id                 String    @id @default(uuid())
  name               String
  slug               String    @unique
  occurrences        Int       @default(1)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @default(now()) @updatedAt
  lastSeenAt         DateTime  @default(now())
  lastSeenActivityId String?
  activity           Activity? @relation(fields: [lastSeenActivityId], references: [id], onUpdate: NoAction, map: "activity_tag_candidates_last_seen_activity_id_fkey")

  @@index([lastSeenAt(sort: Desc)], map: "activity_tag_candidates_last_seen_idx")
  @@map("activity_tag_candidates")
}

model ActivityTag {
  activityId String
  tagId      String
  createdAt  DateTime @default(now())
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([activityId, tagId])
  @@index([activityId])
  @@index([tagId])
  @@map("activity_tags")
}

model Bookmark {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  userId    String
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
  @@index([userId, createdAt(sort: Desc)])
  @@map("bookmarks")
}

/// 评论模型
/// 数据库约束: comments_target_xor_check - postId 和 activityId 互斥（最多一个非空）
model Comment {
  id            String         @id @default(uuid())
  content       String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  authorId      String
  postId        String?        /// 与 activityId 互斥（数据库 CHECK 约束）
  activityId    String?        /// 与 postId 互斥（数据库 CHECK 约束）
  parentId      String?
  deletedAt     DateTime?      @db.Timestamp(6)
  activity      Activity?      @relation(fields: [activityId], references: [id], onDelete: Cascade)
  author        User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent        Comment?       @relation("commentsTocomments", fields: [parentId], references: [id], onDelete: NoAction)
  replies       Comment[]      @relation("commentsTocomments")
  post          Post?          @relation(fields: [postId], references: [id], onDelete: Cascade)
  notifications Notification[] @relation("NotificationComment")

  @@index([activityId])
  @@index([authorId])
  @@index([createdAt(sort: Desc)])
  @@index([deletedAt])
  @@index([parentId])
  @@index([postId])
  @@index([activityId, parentId, createdAt(sort: Desc), id(sort: Desc)])
  @@index([parentId, createdAt, id], map: "comments_parentId_createdAt_id_asc_idx")
  @@index([postId, parentId, createdAt(sort: Desc), id(sort: Desc)])
  @@map("comments")
}

model Follow {
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("follows_followerIdTousers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("follows_followingIdTousers", fields: [followingId], references: [id], onDelete: Cascade)

  @@id([followerId, followingId])
  @@index([followerId, createdAt])
  @@index([followingId, createdAt])
  @@map("follows")
}

/// 点赞模型
/// 数据库约束: likes_target_xor_check - postId 和 activityId 互斥（最多一个非空）
model Like {
  id         String    @id @default(uuid())
  createdAt  DateTime  @default(now())
  authorId   String
  postId     String?   /// 与 activityId 互斥（数据库 CHECK 约束）
  activityId String?   /// 与 postId 互斥（数据库 CHECK 约束）
  activity   Activity? @relation(fields: [activityId], references: [id], onDelete: Cascade)
  author     User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post       Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([authorId, activityId])
  @@unique([authorId, postId])
  @@index([authorId])
  @@map("likes")
}

model PostTag {
  postId    String
  tagId     String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@map("post_tags")
}

model Post {
  id                   String                   @id @default(uuid())
  slug                 String                   @unique
  title                String
  content              String
  excerpt              String?
  published            Boolean                  @default(false)
  isPinned             Boolean                  @default(false)
  canonicalUrl         String?
  seoTitle             String?
  seoDescription       String?
  viewCount            Int                      @default(0)
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  publishedAt          DateTime?
  authorId             String
  seriesId             String?
  coverImage           String?
  titleTokens          String?
  excerptTokens        String?
  seoDescriptionTokens String?
  contentTokens        String?
  search_vector        Unsupported("tsvector")? @default(dbgenerated("(((setweight(to_tsvector('simple'::regconfig, COALESCE(\"titleTokens\", ''::text)), 'A'::\"char\") || setweight(to_tsvector('simple'::regconfig, COALESCE(\"excerptTokens\", ''::text)), 'B'::\"char\")) || setweight(to_tsvector('simple'::regconfig, COALESCE(\"seoDescriptionTokens\", ''::text)), 'B'::\"char\")) || setweight(to_tsvector('simple'::regconfig, COALESCE(\"contentTokens\", ''::text)), 'C'::\"char\"))"))
  bookmarks            Bookmark[]
  comments             Comment[]
  likes                Like[]
  notifications        Notification[]           @relation("NotificationPost")
  emailQueue           EmailQueue[]
  tags                 PostTag[]
  author               User                     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  series               Series?                  @relation(fields: [seriesId], references: [id])

  @@index([authorId])
  @@index([published, publishedAt(sort: Desc)])
  @@index([seriesId])
  @@index([createdAt(sort: Desc), id(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([isPinned])
  @@index([published, createdAt(sort: Desc)])
  @@index([search_vector], type: Gin)
  @@index([viewCount(sort: Desc)])
  @@map("posts")
}

model Series {
  id          String   @id
  title       String
  slug        String   @unique
  description String?
  coverUrl    String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  authorId    String
  posts       Post[]
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@map("series")
}

model Tag {
  id                String                   @id @default(uuid())
  name              String                   @unique
  slug              String                   @unique
  description       String?
  color             String?
  postsCount        Int                      @default(0)
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  activitiesCount   Int                      @default(0)
  nameTokens        String?
  descriptionTokens String?
  search_vector     Unsupported("tsvector")? @default(dbgenerated("(setweight(to_tsvector('simple'::regconfig, COALESCE(\"nameTokens\", ''::text)), 'A'::\"char\") || setweight(to_tsvector('simple'::regconfig, COALESCE(\"descriptionTokens\", ''::text)), 'B'::\"char\"))"))
  activities        ActivityTag[]
  posts             PostTag[]

  @@index([postsCount(sort: Desc)])
  @@index([search_vector], type: Gin)
  @@map("tags")
}

model User {
  id                      String                   @id @default(uuid())
  email                   String                   @unique
  name                    String?
  avatarUrl               String?
  coverImage              String?
  bio                     String?
  socialLinks             Json?
  role                    Role                     @default(USER)
  status                  UserStatus               @default(ACTIVE)
  passwordHash            String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  lastLoginAt             DateTime?
  nameTokens              String?
  bioTokens               String?
  search_vector           Unsupported("tsvector")? @default(dbgenerated("((setweight(to_tsvector('simple'::regconfig, COALESCE(\"nameTokens\", ''::text)), 'A'::\"char\") || setweight(to_tsvector('simple'::regconfig, regexp_replace(COALESCE(email, ''::text), '[^a-zA-Z0-9]+'::text, ' '::text, 'g'::text)), 'B'::\"char\")) || setweight(to_tsvector('simple'::regconfig, COALESCE(\"bioTokens\", ''::text)), 'C'::\"char\"))"))
  location                String?
  notificationPreferences Json                     @default("{}")
  phone                   String?
  privacySettings         Json                     @default("{}")
  activities              Activity[]
  bookmarks               Bookmark[]
  comments                Comment[]
  following               Follow[]                 @relation("follows_followerIdTousers")
  followers               Follow[]                 @relation("follows_followingIdTousers")
  likes                   Like[]
  notificationsSent       Notification[]           @relation("NotificationActor")
  notificationsReceived   Notification[]           @relation("NotificationRecipient")
  notificationsFollowed   Notification[]           @relation("NotificationFollower")
  performanceMetrics      PerformanceMetric[]
  posts                   Post[]
  series                  Series[]
  systemSettingsUpdated   SystemSetting[]          @relation("SystemSettingUpdatedBy")
  emailSubscriptions      EmailSubscriber[]

  @@index([bio(ops: raw("gin_trgm_ops"))], map: "idx_users_bio_trgm", type: Gin)
  @@index([name(ops: raw("gin_trgm_ops"))], map: "idx_users_name_trgm", type: Gin)
  @@index([email(ops: raw("gin_trgm_ops"))], map: "users_email_trgm_idx", type: Gin)
  @@index([search_vector], type: Gin)
  @@map("users")
}

model Notification {
  /// DB CHECK: exactly one of postId/activityId/followerId is non-null.
  id          String           @id @default(uuid())
  recipientId String
  actorId     String
  type        NotificationType
  readAt      DateTime?
  createdAt   DateTime         @default(now())
  postId      String?
  commentId   String?
  activityId  String?
  followerId  String?
  actor       User             @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)
  comment     Comment?         @relation("NotificationComment", fields: [commentId], references: [id])
  post        Post?            @relation("NotificationPost", fields: [postId], references: [id])
  activity    Activity?        @relation(fields: [activityId], references: [id])
  follower    User?            @relation("NotificationFollower", fields: [followerId], references: [id], onDelete: SetNull)
  recipient   User             @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  emailQueue  EmailQueue[]

  @@index([recipientId, readAt])
  @@index([followerId])
  @@map("notifications")
}

model EmailSubscriber {
  id                   String                    @id @default(uuid())
  email                String                    @unique
  userId               String?
  status               EmailSubscriptionStatus   @default(PENDING)
  verifyTokenHash      String?                   @unique
  verifyExpiresAt      DateTime?
  unsubscribeTokenHash String                    @unique
  verifiedAt           DateTime?
  lastDigestAt         DateTime?
  preferences          Json                      @default("{}")
  source               String?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  emailQueue EmailQueue[]

  @@index([email])
  @@index([status])
  @@map("email_subscribers")
}

model EmailQueue {
  id             String           @id @default(uuid())
  subscriberId   String?
  type           NotificationType
  payload        Json
  scheduledAt    DateTime         @default(now())
  status         EmailQueueStatus @default(PENDING)
  attempts       Int              @default(0)
  lastError      String?
  sentAt         DateTime?
  notificationId String?
  postId         String?
  createdAt      DateTime         @default(now())

  subscriber   EmailSubscriber? @relation(fields: [subscriberId], references: [id], onDelete: SetNull)
  notification Notification?    @relation(fields: [notificationId], references: [id], onDelete: SetNull)
  post         Post?            @relation(fields: [postId], references: [id], onDelete: SetNull)

  @@index([status, scheduledAt])
  @@index([type])
  @@map("email_queue")
}

model PerformanceMetric {
  id        String     @id @default(cuid())
  type      MetricType
  value     Float
  unit      String
  timestamp DateTime   @default(now())
  context   Json?
  tags      String[]   @default([])
  requestId String?
  userId    String?
  user      User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([type, timestamp(sort: Desc)])
  @@index([tags])
  @@index([userId])
  @@map("performance_metrics")
}

model SystemSetting {
  key         String   @id
  value       Json
  category    String?
  description String?
  updatedById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedBy   User?    @relation(name: "SystemSettingUpdatedBy", fields: [updatedById], references: [id])

  @@map("system_settings")
}

enum Role {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  BANNED
}

enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
  SYSTEM
  NEW_POST
}

enum EmailSubscriptionStatus {
  PENDING
  VERIFIED
  UNSUBSCRIBED
  BOUNCED
}

enum EmailQueueStatus {
  PENDING
  SENDING
  SENT
  FAILED
}

enum MetricType {
  api_response
  db_query
  cache_hit
  external_api
  auth_login
  auth_session
  permission_check
}
